

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/default.ico">
  <link rel="icon" href="/img/default.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="陈怀森">
  <meta name="keywords" content="">
  
    <meta name="description" content="1.Redis之Cluster集群1.1 Redis Cluster工作原理在哨兵sentinel机制中，可以解决Redis高可用问题，即当MASTER故障后可以自动将SLAVE提升为MASTER，从而可以保证Redis服务的正常使用，但是无法解决Redis单机写入的瓶颈问题，即单机Redis写入性能受限于单机的内存大小、并发数量、网卡速率等因素。 为了解决单机性能的瓶颈，提高Redis 性能，可">
<meta property="og:type" content="article">
<meta property="og:title" content="(6).Redis之Cluster集群">
<meta property="og:url" content="https://chsblogs.gitee.io/2023/02/19/NoSQL/Redis/redis06/index.html">
<meta property="og:site_name" content="陈怀森の运维笔记">
<meta property="og:description" content="1.Redis之Cluster集群1.1 Redis Cluster工作原理在哨兵sentinel机制中，可以解决Redis高可用问题，即当MASTER故障后可以自动将SLAVE提升为MASTER，从而可以保证Redis服务的正常使用，但是无法解决Redis单机写入的瓶颈问题，即单机Redis写入性能受限于单机的内存大小、并发数量、网卡速率等因素。 为了解决单机性能的瓶颈，提高Redis 性能，可">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://chsblogs.gitee.io/2023/02/19/NoSQL/Redis/redis06/image-20230219170743768.png">
<meta property="article:published_time" content="2023-02-19T08:56:09.000Z">
<meta property="article:modified_time" content="2023-03-15T03:25:36.506Z">
<meta property="article:author" content="陈怀森">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://chsblogs.gitee.io/2023/02/19/NoSQL/Redis/redis06/image-20230219170743768.png">
  
  
  
  <title>(6).Redis之Cluster集群 - 陈怀森の运维笔记</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"chsblogs.gitee.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"SHELL"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":6},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>陈怀森 の 运维笔记</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="(6).Redis之Cluster集群"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-02-19 16:56" pubdate>
          2023年2月19日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          53k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          37 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">(6).Redis之Cluster集群</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="1-Redis之Cluster集群"><a href="#1-Redis之Cluster集群" class="headerlink" title="1.Redis之Cluster集群"></a>1.Redis之Cluster集群</h1><h2 id="1-1-Redis-Cluster工作原理"><a href="#1-1-Redis-Cluster工作原理" class="headerlink" title="1.1 Redis Cluster工作原理"></a>1.1 Redis Cluster工作原理</h2><p>在哨兵sentinel机制中，可以解决Redis高可用问题，即当MASTER故障后可以自动将SLAVE提升为MASTER，从而可以保证Redis服务的正常使用，但是无法解决Redis单机写入的瓶颈问题，即单机Redis写入性能受限于单机的内存大小、并发数量、网卡速率等因素。</p>
<p>为了解决单机性能的瓶颈，提高Redis 性能，可以使用分布式集群的解决方案。Redis 3.0版本之后推出了无中心架构的Redis Cluster机制，在无中心的Redis集群当中，其每个节点保存当前节点数据和整个集群状态,每个节点都和其他所有节点连接。</p>
<p><strong>Redis Cluster特点：</strong></p>
<ul>
<li>所有Redis节点使用(PING机制)互联。</li>
<li>集群中某个节点是否失效，是由整个集群中超过半数的节点监测都失效，才能算真正的失效。</li>
<li>客户端不需要Proxy即可直接连接Redis，应用程序中需要配置全部的Redis服务器IP。</li>
<li>Redis Cluster把所有的Redis Node平均映射到0-166383个槽位(Slot)上，读写需要到指定的Redis Node上进行操作，因此有多个Redis Node相当于Redis并发扩展了多倍，每个Redis Node承担16384&#x2F;N个槽位。</li>
<li>Redis Cluster预先分配16384个(Slot)槽位，当需要在Redis集群中写入一个Key-Value的时候，会使用CRC16(Key)Mode 16384之后的值，决定将Key写入哪一个槽位从而决定写入哪一个Redis节点上，从而有效解决单机瓶颈。</li>
</ul>
<p><strong>Redis Cluster 架构：</strong></p>
<p><img src="/2023/02/19/NoSQL/Redis/redis06/image-20230219170743768.png" srcset="/img/loading.gif" lazyload alt="image-20230219170743768">  </p>
<h1 id="2-手动部署"><a href="#2-手动部署" class="headerlink" title="2 手动部署"></a>2 手动部署</h1><p>基于原生命令手动部署Redis Cluster集群：</p>
<h2 id="2-1-部署清单"><a href="#2-1-部署清单" class="headerlink" title="2.1 部署清单"></a>2.1 部署清单</h2><table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>操作系统</th>
<th>服务</th>
</tr>
</thead>
<tbody><tr>
<td>node20</td>
<td>192.168.1.20</td>
<td>CentOS8.5</td>
<td>Redis5.0.3</td>
</tr>
<tr>
<td>node21</td>
<td>192.168.1.21</td>
<td>CentOS8.5</td>
<td>Redis5.0.3</td>
</tr>
<tr>
<td>node22</td>
<td>192.168.1.22</td>
<td>CentOS8.5</td>
<td>Redis5.0.3</td>
</tr>
<tr>
<td>node23</td>
<td>192.168.1.23</td>
<td>CentOS8.5</td>
<td>Redis5.0.3</td>
</tr>
<tr>
<td>node24</td>
<td>192.168.1.24</td>
<td>CentOS8.5</td>
<td>Redis5.0.3</td>
</tr>
<tr>
<td>node25</td>
<td>192.168.1.25</td>
<td>CentOS8.5</td>
<td>Redis5.0.3</td>
</tr>
</tbody></table>
<h2 id="2-2-安装配置Redis-5-0-3"><a href="#2-2-安装配置Redis-5-0-3" class="headerlink" title="2.2 安装配置Redis 5.0.3"></a>2.2 安装配置Redis 5.0.3</h2><p><strong>6个节点分别安装Redis：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#node20节点</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># dnf -y install redis</span>

<span class="token comment">#node21节点</span>
<span class="token punctuation">[</span>root@node21 ~<span class="token punctuation">]</span><span class="token comment"># dnf -y install redis</span>

<span class="token comment">#node22节点</span>
<span class="token punctuation">[</span>root@node22 ~<span class="token punctuation">]</span><span class="token comment"># dnf -y install redis</span>

<span class="token comment">#node23节点</span>
<span class="token punctuation">[</span>root@node23 ~<span class="token punctuation">]</span><span class="token comment"># dnf -y install redis</span>

<span class="token comment">#node24节点</span>
<span class="token punctuation">[</span>root@node24 ~<span class="token punctuation">]</span><span class="token comment"># dnf -y install redis</span>

<span class="token comment">#node25节点</span>
<span class="token punctuation">[</span>root@node25 ~<span class="token punctuation">]</span><span class="token comment"># dnf -y install redis</span></code></pre></div></figure>



<p><strong>6个节点分别配置Redis：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/redis.conf</span>
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
masterauth <span class="token number">123456</span>
requirepass <span class="token number">123456</span>
cluster-enabled <span class="token function">yes</span> <span class="token comment">#取消此行注释,必须开启集群，开启后redis 进程会有cluster标识。</span>
cluster-config-file nodes-6379.conf <span class="token comment">#取消此行注释,此为集群状态文件,记录主从关系及slot范围信息,由redis cluster 集群自动创建和维护。</span>
cluster-require-full-coverage no <span class="token comment">#默认值为yes,设为no可以防止一个节点不可用导致整个cluster不可用。</span>

<span class="token comment">#批量修改配置文件</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># sed -i.bak -e 's/bind 127.0.0.1/bind 0.0.0.0/' -e '/masterauth/a masterauth 123456' -e '/# requirepass/a requirepass 123456' -e '/# cluster-enabled yes/a cluster-enabled yes' -e '/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf' -e '/cluster-require-full-coverage yes/c cluster-require-full-coverage no' /etc/redis.conf</span>

<span class="token punctuation">[</span>root@node21 ~<span class="token punctuation">]</span><span class="token comment"># sed -i.bak -e 's/bind 127.0.0.1/bind 0.0.0.0/' -e '/masterauth/a masterauth 123456' -e '/# requirepass/a requirepass 123456' -e '/# cluster-enabled yes/a cluster-enabled yes' -e '/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf' -e '/cluster-require-full-coverage yes/c cluster-require-full-coverage no' /etc/redis.conf</span>

<span class="token punctuation">[</span>root@node22 ~<span class="token punctuation">]</span><span class="token comment"># sed -i.bak -e 's/bind 127.0.0.1/bind 0.0.0.0/' -e '/masterauth/a masterauth 123456' -e '/# requirepass/a requirepass 123456' -e '/# cluster-enabled yes/a cluster-enabled yes' -e '/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf' -e '/cluster-require-full-coverage yes/c cluster-require-full-coverage no' /etc/redis.conf</span>

<span class="token punctuation">[</span>root@node23 ~<span class="token punctuation">]</span><span class="token comment"># sed -i.bak -e 's/bind 127.0.0.1/bind 0.0.0.0/' -e '/masterauth/a masterauth 123456' -e '/# requirepass/a requirepass 123456' -e '/# cluster-enabled yes/a cluster-enabled yes' -e '/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf' -e '/cluster-require-full-coverage yes/c cluster-require-full-coverage no' /etc/redis.conf</span>

<span class="token punctuation">[</span>root@node24 ~<span class="token punctuation">]</span><span class="token comment"># sed -i.bak -e 's/bind 127.0.0.1/bind 0.0.0.0/' -e '/masterauth/a masterauth 123456' -e '/# requirepass/a requirepass 123456' -e '/# cluster-enabled yes/a cluster-enabled yes' -e '/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf' -e '/cluster-require-full-coverage yes/c cluster-require-full-coverage no' /etc/redis.conf</span>

<span class="token punctuation">[</span>root@node25 ~<span class="token punctuation">]</span><span class="token comment"># sed -i.bak -e 's/bind 127.0.0.1/bind 0.0.0.0/' -e '/masterauth/a masterauth 123456' -e '/# requirepass/a requirepass 123456' -e '/# cluster-enabled yes/a cluster-enabled yes' -e '/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf' -e '/cluster-require-full-coverage yes/c cluster-require-full-coverage no' /etc/redis.conf</span>

<span class="token comment">#启动redis服务</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now redis</span>
<span class="token punctuation">[</span>root@node21 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now redis</span>
<span class="token punctuation">[</span>root@node22 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now redis</span>
<span class="token punctuation">[</span>root@node23 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now redis</span>
<span class="token punctuation">[</span>root@node24 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now redis</span>
<span class="token punctuation">[</span>root@node25 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now redis</span></code></pre></div></figure>



<p><strong>执行meet操作实现相互通信：</strong></p>
 <figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#在任一节点上和其它所有节点进行meet通信</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 192.168.1.20 -a 123456 --no-auth-warning cluster meet 192.168.1.21 6379</span>
OK
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 192.168.1.20 -a 123456 --no-auth-warning cluster meet 192.168.1.22 6379</span>
OK
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 192.168.1.20 -a 123456 --no-auth-warning cluster meet 192.168.1.23 6379</span>
OK
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 192.168.1.20 -a 123456 --no-auth-warning cluster meet 192.168.1.24 6379</span>
OK
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 192.168.1.20 -a 123456 --no-auth-warning cluster meet 192.168.1.25 6379</span>
OK

<span class="token comment">#所有节点之间可以相互连接通信</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 192.168.1.20 -a 123456 --no-auth-warning cluster nodes</span>
4c709246f80b88b0b051deb2e04b56f3e0f4590c <span class="token number">192.168</span>.1.24:6379@16379 master - <span class="token number">0</span> <span class="token number">1676779617172</span> <span class="token number">4</span> connected
d8dbe0eeeb7b03e78bd896af0c1b59d2acf89f83 <span class="token number">192.168</span>.1.20:6379@16379 myself,master - <span class="token number">0</span> <span class="token number">1676779618000</span> <span class="token number">2</span> connected
292b2d637d7a2c8db6a169ed29f1fa37ca8695fb <span class="token number">192.168</span>.1.25:6379@16379 master - <span class="token number">0</span> <span class="token number">1676779616164</span> <span class="token number">5</span> connected
fc5349739b52484c613a48e621da3e1363439c6b <span class="token number">192.168</span>.1.22:6379@16379 master - <span class="token number">0</span> <span class="token number">1676779616000</span> <span class="token number">0</span> connected
fb4f1757251753caa2142bbd4bd22e5b204acf46 <span class="token number">192.168</span>.1.23:6379@16379 master - <span class="token number">0</span> <span class="token number">1676779617000</span> <span class="token number">3</span> connected
03a760a1a1041517103d306813a22f93a52c88e5 <span class="token number">192.168</span>.1.21:6379@16379 master - <span class="token number">0</span> <span class="token number">1676779618186</span> <span class="token number">1</span> connected

<span class="token comment">#查看当前状态</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -a 123456 --no-auth-warning cluster info</span>
cluster_state:fail
cluster_slots_assigned:0 <span class="token comment">#无槽位分配</span>
cluster_slots_ok:0
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:0 <span class="token comment">#无集群成员</span>
cluster_current_epoch:5
cluster_my_epoch:2
cluster_stats_messages_ping_sent:452
cluster_stats_messages_pong_sent:509
cluster_stats_messages_meet_sent:5
cluster_stats_messages_sent:966
cluster_stats_messages_ping_received:509
cluster_stats_messages_pong_received:457
cluster_stats_messages_received:966
</code></pre></div></figure>



<p><strong>为各个master 节点指派槽位范围：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># vim addslot.sh</span>
<span class="token comment">#!/bin/bash</span>
<span class="token assign-left variable">host</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token variable">$3</span>
<span class="token assign-left variable">end</span><span class="token operator">=</span><span class="token variable">$4</span>
<span class="token assign-left variable">pass</span><span class="token operator">=</span><span class="token number">123456</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">slot</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">seq</span> $<span class="token punctuation">&#123;</span>start<span class="token punctuation">&#125;</span> $<span class="token punctuation">&#123;</span>end<span class="token punctuation">&#125;</span><span class="token variable">`</span></span><span class="token punctuation">;</span><span class="token keyword">do</span>
  <span class="token builtin class-name">echo</span> slot:<span class="token variable">$slot</span>
  redis-cli <span class="token parameter variable">-h</span> <span class="token variable">$&#123;host&#125;</span> <span class="token parameter variable">-p</span> <span class="token variable">$port</span> <span class="token parameter variable">-a</span> <span class="token variable">$&#123;pass&#125;</span> --no-auth-warning cluster addslots <span class="token variable">$&#123;slot&#125;</span>
<span class="token keyword">done</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x addslot.sh</span>

<span class="token comment">#为三个master分配槽位,共16364/3=5,461.333333333333,平均每个master分配5,461个槽位。</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># bash addslot.sh 192.168.1.20 6379 0 5461</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># bash addslot.sh 192.168.1.21 6379 5462 10922</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># bash addslot.sh 192.168.1.22 6379 10922 16383</span>

<span class="token comment">#查看当前状态</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 192.168.1.20 -a 123456 --no-auth-warning cluster nodes</span>
4c709246f80b88b0b051deb2e04b56f3e0f4590c <span class="token number">192.168</span>.1.24:6379@16379 master - <span class="token number">0</span> <span class="token number">1676780327000</span> <span class="token number">4</span> connected
d8dbe0eeeb7b03e78bd896af0c1b59d2acf89f83 <span class="token number">192.168</span>.1.20:6379@16379 myself,master - <span class="token number">0</span> <span class="token number">1676780325000</span> <span class="token number">2</span> connected <span class="token number">0</span>-5461
292b2d637d7a2c8db6a169ed29f1fa37ca8695fb <span class="token number">192.168</span>.1.25:6379@16379 master - <span class="token number">0</span> <span class="token number">1676780327000</span> <span class="token number">5</span> connected
fc5349739b52484c613a48e621da3e1363439c6b <span class="token number">192.168</span>.1.22:6379@16379 master - <span class="token number">0</span> <span class="token number">1676780326000</span> <span class="token number">0</span> connected <span class="token number">10923</span>-16383
fb4f1757251753caa2142bbd4bd22e5b204acf46 <span class="token number">192.168</span>.1.23:6379@16379 master - <span class="token number">0</span> <span class="token number">1676780327710</span> <span class="token number">3</span> connected
03a760a1a1041517103d306813a22f93a52c88e5 <span class="token number">192.168</span>.1.21:6379@16379 master - <span class="token number">0</span> <span class="token number">1676780326000</span> <span class="token number">1</span> connected <span class="token number">5462</span>-10922

<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -a 123456 --no-auth-warning cluster info</span>
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:5
cluster_my_epoch:2
cluster_stats_messages_ping_sent:776
cluster_stats_messages_pong_sent:873
cluster_stats_messages_meet_sent:5
cluster_stats_messages_sent:1654
cluster_stats_messages_ping_received:873
cluster_stats_messages_pong_received:781
cluster_stats_messages_received:1654</code></pre></div></figure>



<p><strong>指定各个节点的主从关系：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#通过cluster nodes查看master的ID信息,将对应的slave指定相应的master节点,实现三对主从节点。</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 192.168.1.20 -a 123456 --no-auth-warning cluster nodes</span>
4c709246f80b88b0b051deb2e04b56f3e0f4590c <span class="token number">192.168</span>.1.24:6379@16379 master - <span class="token number">0</span> <span class="token number">1676780327000</span> <span class="token number">4</span> connected
d8dbe0eeeb7b03e78bd896af0c1b59d2acf89f83 <span class="token number">192.168</span>.1.20:6379@16379 myself,master - <span class="token number">0</span> <span class="token number">1676780325000</span> <span class="token number">2</span> connected <span class="token number">0</span>-5461
292b2d637d7a2c8db6a169ed29f1fa37ca8695fb <span class="token number">192.168</span>.1.25:6379@16379 master - <span class="token number">0</span> <span class="token number">1676780327000</span> <span class="token number">5</span> connected
fc5349739b52484c613a48e621da3e1363439c6b <span class="token number">192.168</span>.1.22:6379@16379 master - <span class="token number">0</span> <span class="token number">1676780326000</span> <span class="token number">0</span> connected <span class="token number">10923</span>-16383
fb4f1757251753caa2142bbd4bd22e5b204acf46 <span class="token number">192.168</span>.1.23:6379@16379 master - <span class="token number">0</span> <span class="token number">1676780327710</span> <span class="token number">3</span> connected
03a760a1a1041517103d306813a22f93a52c88e5 <span class="token number">192.168</span>.1.21:6379@16379 master - <span class="token number">0</span> <span class="token number">1676780326000</span> <span class="token number">1</span> connected <span class="token number">5462</span>-10922

<span class="token comment">#将192.168.1.23指定192.168.1.20的ID作为其从节点</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 192.168.1.23 -a 123456 --no-auth-warning cluster replicate d8dbe0eeeb7b03e78bd896af0c1b59d2acf89f83</span>
OK

<span class="token comment">#将192.168.1.24指定192.168.1.21的ID作为其从节点</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 192.168.1.24 -a 123456 --no-auth-warning cluster replicate 03a760a1a1041517103d306813a22f93a52c88e5</span>
OK

<span class="token comment">#将192.168.1.25指定192.168.1.22的ID作为其从节点</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 192.168.1.25 -a 123456 --no-auth-warning cluster replicate fc5349739b52484c613a48e621da3e1363439c6b</span>
OK

<span class="token comment">#查看状态</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 192.168.1.20 -a 123456 --no-auth-warning cluster nodes</span>
4c709246f80b88b0b051deb2e04b56f3e0f4590c <span class="token number">192.168</span>.1.24:6379@16379 slave 03a760a1a1041517103d306813a22f93a52c88e5 <span class="token number">0</span> <span class="token number">1676780744000</span> <span class="token number">4</span> connected
d8dbe0eeeb7b03e78bd896af0c1b59d2acf89f83 <span class="token number">192.168</span>.1.20:6379@16379 myself,master - <span class="token number">0</span> <span class="token number">1676780744000</span> <span class="token number">2</span> connected <span class="token number">0</span>-5461
292b2d637d7a2c8db6a169ed29f1fa37ca8695fb <span class="token number">192.168</span>.1.25:6379@16379 slave fc5349739b52484c613a48e621da3e1363439c6b <span class="token number">0</span> <span class="token number">1676780744000</span> <span class="token number">5</span> connected
fc5349739b52484c613a48e621da3e1363439c6b <span class="token number">192.168</span>.1.22:6379@16379 master - <span class="token number">0</span> <span class="token number">1676780745141</span> <span class="token number">0</span> connected <span class="token number">10923</span>-16383
fb4f1757251753caa2142bbd4bd22e5b204acf46 <span class="token number">192.168</span>.1.23:6379@16379 slave d8dbe0eeeb7b03e78bd896af0c1b59d2acf89f83 <span class="token number">0</span> <span class="token number">1676780744129</span> <span class="token number">3</span> connected
03a760a1a1041517103d306813a22f93a52c88e5 <span class="token number">192.168</span>.1.21:6379@16379 master - <span class="token number">0</span> <span class="token number">1676780746149</span> <span class="token number">1</span> connected <span class="token number">5462</span>-10922

<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -a 123456 --no-auth-warning cluster info</span>
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:5
cluster_my_epoch:2
cluster_stats_messages_ping_sent:1259
cluster_stats_messages_pong_sent:1424
cluster_stats_messages_meet_sent:5
cluster_stats_messages_sent:2688
cluster_stats_messages_ping_received:1424
cluster_stats_messages_pong_received:1264
cluster_stats_messages_received:2688

<span class="token comment">#查看主从节关系及槽位信息</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -a 123456 --no-auth-warning cluster slots</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">5461</span>
   <span class="token number">3</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"192.168.1.20"</span>
      <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6379</span>
      <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"d8dbe0eeeb7b03e78bd896af0c1b59d2acf89f83"</span>
   <span class="token number">4</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"192.168.1.23"</span>
      <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6379</span>
      <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"fb4f1757251753caa2142bbd4bd22e5b204acf46"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">10923</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">16383</span>
   <span class="token number">3</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"192.168.1.22"</span>
      <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6379</span>
      <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"fc5349739b52484c613a48e621da3e1363439c6b"</span>
   <span class="token number">4</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"192.168.1.25"</span>
      <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6379</span>
      <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"292b2d637d7a2c8db6a169ed29f1fa37ca8695fb"</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">5462</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">10922</span>
   <span class="token number">3</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"192.168.1.21"</span>
      <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6379</span>
      <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"03a760a1a1041517103d306813a22f93a52c88e5"</span>
   <span class="token number">4</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"192.168.1.24"</span>
      <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">6379</span>
      <span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"4c709246f80b88b0b051deb2e04b56f3e0f4590c"</span></code></pre></div></figure>



<p><strong>验证 Redis Cluster访问：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#指定选项-c表示以集群方式连接</span>
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -h 192.168.1.20 -a 123456 --no-auth-warning set chs www.chsblogs.com</span>
OK
<span class="token punctuation">[</span>root@node20 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -h 192.168.1.20 -a 123456 --no-auth-warning get chs</span>
<span class="token string">"www.chsblogs.com"</span></code></pre></div></figure>



<h1 id="3-Redis-4部署"><a href="#3-Redis-4部署" class="headerlink" title="3 Redis 4部署"></a>3 Redis 4部署</h1><p>基于Redis 4部署Redis Cluster集群：</p>
<h2 id="3-1-部署清单"><a href="#3-1-部署清单" class="headerlink" title="3.1 部署清单"></a>3.1 部署清单</h2><table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>操作系统</th>
<th>服务</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>node10</td>
<td>192.168.1.10</td>
<td>CentOS7.9</td>
<td>Redis4.0.9</td>
<td></td>
</tr>
<tr>
<td>node11</td>
<td>192.168.1.11</td>
<td>CentOS7.9</td>
<td>Redis4.0.9</td>
<td></td>
</tr>
<tr>
<td>node12</td>
<td>192.168.1.12</td>
<td>CentOS7.9</td>
<td>Redis4.0.9</td>
<td></td>
</tr>
<tr>
<td>node13</td>
<td>192.168.1.13</td>
<td>CentOS7.9</td>
<td>Redis4.0.9</td>
<td></td>
</tr>
<tr>
<td>node14</td>
<td>192.168.1.14</td>
<td>CentOS7.9</td>
<td>Redis4.0.9</td>
<td></td>
</tr>
<tr>
<td>node15</td>
<td>192.168.1.15</td>
<td>CentOS7.9</td>
<td>Redis4.0.9</td>
<td></td>
</tr>
<tr>
<td>node16</td>
<td>192.168.1.16</td>
<td>CentOS7.9</td>
<td>Redis4.0.9</td>
<td>集群动态扩容</td>
</tr>
<tr>
<td>node17</td>
<td>192.168.1.17</td>
<td>CentOS7.9</td>
<td>Redis4.0.9</td>
<td>集群动态扩容</td>
</tr>
</tbody></table>
<h2 id="3-2-安装配置Redis-4-0-9"><a href="#3-2-安装配置Redis-4-0-9" class="headerlink" title="3.2 安装配置Redis 4.0.9"></a>3.2 安装配置Redis 4.0.9</h2><p><strong>8个节点分别安装Redis：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#shell脚本一键安装Redis</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># vim install_redis.sh</span>
<span class="token comment">#!/bin/bash</span>
<span class="token assign-left variable">VERSION</span><span class="token operator">=</span>redis-4.0.9
<span class="token assign-left variable">PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span>
<span class="token assign-left variable">INSTALL_DIR</span><span class="token operator">=</span>/apps/redis
<span class="token function-name function">color</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token assign-left variable">RES_COL</span><span class="token operator">=</span><span class="token number">60</span>
    <span class="token assign-left variable">MOVE_TO_COL</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\\">\\</span>033[<span class="token variable">$&#123;RES_COL&#125;</span>G"</span>
    <span class="token assign-left variable">SETCOLOR_SUCCESS</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\\">\\</span>033[1;32m"</span>
    <span class="token assign-left variable">SETCOLOR_FAILURE</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\\">\\</span>033[1;31m"</span>
    <span class="token assign-left variable">SETCOLOR_WARNING</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\\">\\</span>033[1;33m"</span>
    <span class="token assign-left variable">SETCOLOR_NORMAL</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\E">\E</span>[0m"</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$MOVE_TO_COL</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"["</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"success"</span> <span class="token parameter variable">-o</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token variable">$&#123;SETCOLOR_SUCCESS&#125;</span>
        <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> $<span class="token string">"  OK  "</span>    
    <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"failure"</span> <span class="token parameter variable">-o</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"1"</span>  <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span> 
        <span class="token variable">$&#123;SETCOLOR_FAILURE&#125;</span>
        <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> $<span class="token string">"FAILED"</span>
    <span class="token keyword">else</span>
        <span class="token variable">$&#123;SETCOLOR_WARNING&#125;</span>
        <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> $<span class="token string">"WARNING"</span>
    <span class="token keyword">fi</span>
    <span class="token variable">$&#123;SETCOLOR_NORMAL&#125;</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"]"</span>
    <span class="token builtin class-name">echo</span> 
<span class="token punctuation">&#125;</span>
<span class="token function-name function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc gcc-c++ systemd-devel <span class="token function">wget</span> <span class="token operator">||</span> <span class="token punctuation">&#123;</span> color <span class="token string">"安装软件包失败，请检查网络配置"</span> <span class="token number">1</span> <span class="token punctuation">;</span> <span class="token builtin class-name">exit</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token function">wget</span> http://download.redis.io/releases/<span class="token variable">$&#123;VERSION&#125;</span>.tar.gz <span class="token operator">||</span> <span class="token punctuation">&#123;</span> color <span class="token string">"Redis 源码下载失败"</span> <span class="token number">1</span> <span class="token punctuation">;</span> <span class="token builtin class-name">exit</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token function">tar</span> xf <span class="token variable">$&#123;VERSION&#125;</span>.tar.gz
<span class="token builtin class-name">cd</span> <span class="token variable">$&#123;VERSION&#125;</span>
<span class="token function">make</span> <span class="token parameter variable">-j</span> <span class="token number">4</span> <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span><span class="token variable">$&#123;INSTALL_DIR&#125;</span> <span class="token function">install</span> <span class="token operator">&amp;&amp;</span> color <span class="token string">"Redis 编译安装完成"</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">&#123;</span> color <span class="token string">"Redis 编译安装失败"</span> <span class="token number">1</span> <span class="token punctuation">;</span><span class="token builtin class-name">exit</span> <span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token function">ln</span> <span class="token parameter variable">-s</span> <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/bin/redis-*  /usr/bin/
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/<span class="token punctuation">&#123;</span>etc,log,data,run<span class="token punctuation">&#125;</span>
<span class="token function">cp</span> redis.conf  <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/etc/redis.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">'s/bind 127.0.0.1/bind 0.0.0.0/'</span>  <span class="token parameter variable">-e</span> <span class="token string">"/# requirepass/a requirepass <span class="token variable">$PASSWORD</span>"</span>  <span class="token parameter variable">-e</span> <span class="token string">"/^dir .*/c dir <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/data/"</span>  <span class="token parameter variable">-e</span> <span class="token string">"/logfile .*/c logfile <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/log/redis.log"</span>  <span class="token parameter variable">-e</span>  <span class="token string">"/^pidfile .*/c  pidfile <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/run/redis.pid"</span> <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/etc/redis.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s@protected-mode yes@protected-mode no@'</span> <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/etc/redis.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s@daemonize no@daemonize yes@'</span> <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/etc/redis.conf

<span class="token keyword">if</span> <span class="token function">id</span> redis <span class="token operator">&amp;></span> /dev/null <span class="token punctuation">;</span><span class="token keyword">then</span> 
    color <span class="token string">"Redis 用户已存在"</span> <span class="token number">1</span> 
<span class="token keyword">else</span>
    <span class="token function">useradd</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-s</span> /sbin/nologin redis
    color <span class="token string">"Redis 用户创建成功"</span> <span class="token number">0</span>
<span class="token keyword">fi</span>
<span class="token function">chown</span> <span class="token parameter variable">-R</span> redis.redis <span class="token variable">$&#123;INSTALL_DIR&#125;</span>
<span class="token function">cat</span> <span class="token operator">>></span> /etc/sysctl.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
net.core.somaxconn = 1024
vm.overcommit_memory = 1
EOF</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-p</span> 
<span class="token builtin class-name">echo</span> <span class="token string">'echo never > /sys/kernel/mm/transparent_hugepage/enabled'</span> <span class="token operator">>></span> /etc/rc.d/rc.local
<span class="token function">chmod</span> +x /etc/rc.d/rc.local
/etc/rc.d/rc.local
<span class="token function">cat</span> <span class="token operator">></span> /usr/lib/systemd/system/redis.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=Redis persistent key-value database
After=network.target

[Service]
ExecStart=<span class="token variable">$&#123;INSTALL_DIR&#125;</span>/bin/redis-server <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/etc/redis.conf --supervised systemd
ExecStop=/bin/kill -s QUIT \<span class="token variable">$MAINPID</span>
Type=notify
User=redis
Group=redis
RuntimeDirectory=redis
RuntimeDirectoryMode=0755

[Install]
WantedBy=multi-user.target
EOF</span>
systemctl daemon-reload 
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span>  redis <span class="token operator">&amp;></span> /dev/null <span class="token operator">&amp;&amp;</span> color <span class="token string">"Redis 服务启动成功,Redis信息如下:"</span>  <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">&#123;</span> color <span class="token string">"Redis 启动失败"</span> <span class="token number">1</span> <span class="token punctuation">;</span><span class="token builtin class-name">exit</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> 
<span class="token function">sleep</span> <span class="token number">2</span>
redis-cli <span class="token parameter variable">-a</span> <span class="token variable">$PASSWORD</span> INFO Server <span class="token operator"><span class="token file-descriptor important">2</span>></span> /dev/null

<span class="token punctuation">&#125;</span>
<span class="token function">install</span></code></pre></div></figure>



<p><strong>8个节点分别配置Redis：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># sed -i.bak -e 's/bind 127.0.0.1/bind 0.0.0.0/' -e '/masterauth/a masterauth 123456' -e '/# requirepass/a requirepass 123456' -e '/# cluster-enabled yes/a cluster-enabled yes' -e '/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf' -e '/cluster-require-full-coverage yes/c cluster-require-full-coverage no' /apps/redis/etc/redis.conf</span>

<span class="token comment">#重启redis服务</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart redis</span></code></pre></div></figure>



<p><strong>安装redis-trib.rb工具：</strong></p>
<p>Redis 3和4版本需要使用到集群管理工具redis-trib.rb，这个工具是redis官方推出的管理redis集群的工具，集成在redis的源码src目录下，是基于redis提供的集群命令封装成简单、便捷、实用的操作工具，redis-trib.rb是redis作者用ruby开发完成的，需要安装ruby的redis模块,但是centos 7 系统yum安装的ruby存在版本较低问题，如下：  </p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># find / -name "redis-trib.rb"</span>
/root/redis-4.0.9/src/redis-trib.rb
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># cp /root/redis-4.0.9/src/redis-trib.rb /usr/bin/</span>
<span class="token comment">#缺少ruby环境无法运行rb脚本</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-trib.rb </span>
/usr/bin/env: ruby: No such <span class="token function">file</span> or directory

<span class="token comment">#CentOS 7带的ruby版本过低,无法运行上面ruby脚本,需要安装2.3以上版本,安装rubygems依赖ruby自动安装</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install rubygems</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># gem install redis</span>
Fetching: connection_pool-2.3.0.gem <span class="token punctuation">(</span><span class="token number">100</span>%<span class="token punctuation">)</span>
ERROR:  Error installing redis:
	connection_pool requires Ruby version <span class="token operator">>=</span> <span class="token number">2.5</span>.0.
	
<span class="token comment">#编译安装高版本的ruby</span>
<span class="token comment">#ruby 官网: http://www.ruby-lang.org/zh_cn</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install gcc openssl-devel zlib-devel</span>
<span class="token punctuation">[</span>root@node10 src<span class="token punctuation">]</span><span class="token comment"># ls</span>
ruby-2.5.9.tar.gz
<span class="token punctuation">[</span>root@node10 src<span class="token punctuation">]</span><span class="token comment"># tar -xvf ruby-2.5.9.tar.gz </span>
<span class="token punctuation">[</span>root@node10 src<span class="token punctuation">]</span><span class="token comment"># cd ruby-2.5.9</span>
<span class="token punctuation">[</span>root@node10 ruby-2.5.9<span class="token punctuation">]</span><span class="token comment"># ./configure</span>
<span class="token punctuation">[</span>root@node10 ruby-2.5.9<span class="token punctuation">]</span><span class="token comment"># make -j 2 &amp;&amp; make install</span>
<span class="token punctuation">[</span>root@node10 ruby-2.5.9<span class="token punctuation">]</span><span class="token comment"># ruby -v</span>
ruby <span class="token number">2.5</span>.9p229 <span class="token punctuation">(</span><span class="token number">2021</span>-04-05 revision <span class="token number">67939</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>x86_64-linux<span class="token punctuation">]</span>

<span class="token comment">#安装ruby中redis模块</span>
<span class="token comment">#无法在线安装，可以下载redis模块安装包离线安装：https://rubygems.org/gems/redis</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># gem install redis</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># gem install -l redis-4.1.3.gem </span>
Successfully installed redis-4.1.3
Parsing documentation <span class="token keyword">for</span> redis-4.1.3
Installing ri documentation <span class="token keyword">for</span> redis-4.1.3
Done installing documentation <span class="token keyword">for</span> redis after <span class="token number">1</span> seconds
<span class="token number">1</span> gem installed</code></pre></div></figure>



<p><strong>redis-trib.rb 命令用法：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-trib.rb</span>
Usage: redis-trib <span class="token operator">&lt;</span>command<span class="token operator">></span> <span class="token operator">&lt;</span>options<span class="token operator">></span> <span class="token operator">&lt;</span>arguments <span class="token punctuation">..</span>.<span class="token operator">></span>

  create          host1:port1 <span class="token punctuation">..</span>. hostN:portN
                  <span class="token parameter variable">--replicas</span> <span class="token operator">&lt;</span>arg<span class="token operator">></span> <span class="token comment">#指定每个master的副本数量,即对应slave数量,一般为1</span>
  check           host:port <span class="token comment">#检查集群信息</span>
  info            host:port <span class="token comment">#查看集群主机信息</span>
  fix             host:port <span class="token comment">#修复集群</span>
                  <span class="token parameter variable">--timeout</span> <span class="token operator">&lt;</span>arg<span class="token operator">></span>
  reshard         host:port <span class="token comment">#在线热迁移集群指定主机的slots数据</span>
                  <span class="token parameter variable">--from</span> <span class="token operator">&lt;</span>arg<span class="token operator">></span>
                  <span class="token parameter variable">--to</span> <span class="token operator">&lt;</span>arg<span class="token operator">></span>
                  <span class="token parameter variable">--slots</span> <span class="token operator">&lt;</span>arg<span class="token operator">></span>
                  <span class="token parameter variable">--yes</span>
                  <span class="token parameter variable">--timeout</span> <span class="token operator">&lt;</span>arg<span class="token operator">></span>
                  <span class="token parameter variable">--pipeline</span> <span class="token operator">&lt;</span>arg<span class="token operator">></span>
  rebalance       host:port <span class="token comment">#平衡集群中各主机的slot数量</span>
                  <span class="token parameter variable">--weight</span> <span class="token operator">&lt;</span>arg<span class="token operator">></span>
                  --auto-weights
                  --use-empty-masters
                  <span class="token parameter variable">--timeout</span> <span class="token operator">&lt;</span>arg<span class="token operator">></span>
                  <span class="token parameter variable">--simulate</span>
                  <span class="token parameter variable">--pipeline</span> <span class="token operator">&lt;</span>arg<span class="token operator">></span>
                  <span class="token parameter variable">--threshold</span> <span class="token operator">&lt;</span>arg<span class="token operator">></span>
  add-node        new_host:new_port existing_host:existing_port <span class="token comment">#添加主机到集群</span>
                  <span class="token parameter variable">--slave</span>
                  --master-id <span class="token operator">&lt;</span>arg<span class="token operator">></span>
  del-node        host:port node_id <span class="token comment">#删除主机</span>
  set-timeout     host:port milliseconds <span class="token comment">#设置节点的超时时间</span>
  call            host:port <span class="token builtin class-name">command</span> arg arg <span class="token punctuation">..</span> arg <span class="token comment">#在集群上的所有节点上执行命令</span>
  <span class="token function">import</span>          host:port <span class="token comment">#导入外部redis服务器的数据到当前集群</span>
                  <span class="token parameter variable">--from</span> <span class="token operator">&lt;</span>arg<span class="token operator">></span>
                  <span class="token parameter variable">--copy</span>
                  <span class="token parameter variable">--replace</span>
  <span class="token builtin class-name">help</span>            <span class="token punctuation">(</span>show this <span class="token builtin class-name">help</span><span class="token punctuation">)</span></code></pre></div></figure>



<p><strong>创建Redis Cluster集群：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#修改redis-trib.rb连接redis的密码</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># vim /usr/local/lib/ruby/gems/2.5.0/gems/redis-4.1.3/lib/redis/client.rb</span>
class Redis
  class Client

    DEFAULTS <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      :url <span class="token operator">=</span><span class="token operator">></span> lambda <span class="token punctuation">&#123;</span> ENV<span class="token punctuation">[</span><span class="token string">"REDIS_URL"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>,
      :scheme <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"redis"</span>,
      :host <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"127.0.0.1"</span>,
      :port <span class="token operator">=</span><span class="token operator">></span> <span class="token number">6379</span>,
      :path <span class="token operator">=</span><span class="token operator">></span> nil,
      :timeout <span class="token operator">=</span><span class="token operator">></span> <span class="token number">5.0</span>,
      :password <span class="token operator">=</span><span class="token operator">></span> <span class="token number">123456</span>, <span class="token comment">#此处修改密码</span>
      :db <span class="token operator">=</span><span class="token operator">></span> <span class="token number">0</span>,
      :driver <span class="token operator">=</span><span class="token operator">></span> nil,
      :id <span class="token operator">=</span><span class="token operator">></span> nil,
      :tcp_keepalive <span class="token operator">=</span><span class="token operator">></span> <span class="token number">0</span>,
      :reconnect_attempts <span class="token operator">=</span><span class="token operator">></span> <span class="token number">1</span>,
      :reconnect_delay <span class="token operator">=</span><span class="token operator">></span> <span class="token number">0</span>,
      :reconnect_delay_max <span class="token operator">=</span><span class="token operator">></span> <span class="token number">0.5</span>,
      :inherit_socket <span class="token operator">=</span><span class="token operator">></span> <span class="token boolean">false</span>
    <span class="token punctuation">&#125;</span>

<span class="token comment">#创建集群</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-trib.rb create --replicas 1 192.168.1.10:6379 192.168.1.11:6379 192.168.1.12:6379 192.168.1.13:6379 192.168.1.14:6379 192.168.1.15:6379</span>
<span class="token operator">>></span><span class="token operator">></span> Creating cluster
<span class="token operator">>></span><span class="token operator">></span> Performing <span class="token builtin class-name">hash</span> slots allocation on <span class="token number">6</span> nodes<span class="token punctuation">..</span>.
Using <span class="token number">3</span> masters:
<span class="token number">192.168</span>.1.10:6379
<span class="token number">192.168</span>.1.11:6379
<span class="token number">192.168</span>.1.12:6379
Adding replica <span class="token number">192.168</span>.1.14:6379 to <span class="token number">192.168</span>.1.10:6379
Adding replica <span class="token number">192.168</span>.1.15:6379 to <span class="token number">192.168</span>.1.11:6379
Adding replica <span class="token number">192.168</span>.1.13:6379 to <span class="token number">192.168</span>.1.12:6379
M: dca4320ad3082c06d3ecef0376eb17dc44f2f667 <span class="token number">192.168</span>.1.10:6379
   slots:0-5460 <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
M: c287bfc868cc17ad246d4cbb4377dd2f10260b9d <span class="token number">192.168</span>.1.11:6379
   slots:5461-10922 <span class="token punctuation">(</span><span class="token number">5462</span> slots<span class="token punctuation">)</span> master
M: 4a3e180a9805afa1a325523b2b9da68f4b2958b2 <span class="token number">192.168</span>.1.12:6379
   slots:10923-16383 <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
S: 555035ef69008b2932e6c0b182f503ed621d1cfd <span class="token number">192.168</span>.1.13:6379
   replicates 4a3e180a9805afa1a325523b2b9da68f4b2958b2
S: 75a67b1cadfc75a6acfa10f32ccc6a58a5bec974 <span class="token number">192.168</span>.1.14:6379
   replicates dca4320ad3082c06d3ecef0376eb17dc44f2f667
S: 06116e2e5a2ec9b57a0b122329d69ecfd91eb5b0 <span class="token number">192.168</span>.1.15:6379
   replicates c287bfc868cc17ad246d4cbb4377dd2f10260b9d
Can I <span class="token builtin class-name">set</span> the above configuration? <span class="token punctuation">(</span>type <span class="token string">'yes'</span> to accept<span class="token punctuation">)</span>: <span class="token function">yes</span>
<span class="token operator">>></span><span class="token operator">></span> Nodes configuration updated
<span class="token operator">>></span><span class="token operator">></span> Assign a different config epoch to each <span class="token function">node</span>
<span class="token operator">>></span><span class="token operator">></span> Sending CLUSTER MEET messages to <span class="token function">join</span> the cluster
Waiting <span class="token keyword">for</span> the cluster to join<span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using <span class="token function">node</span> <span class="token number">192.168</span>.1.10:6379<span class="token punctuation">)</span>
M: dca4320ad3082c06d3ecef0376eb17dc44f2f667 <span class="token number">192.168</span>.1.10:6379
   slots:0-5460 <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: 555035ef69008b2932e6c0b182f503ed621d1cfd <span class="token number">192.168</span>.1.13:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 4a3e180a9805afa1a325523b2b9da68f4b2958b2
S: 06116e2e5a2ec9b57a0b122329d69ecfd91eb5b0 <span class="token number">192.168</span>.1.15:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates c287bfc868cc17ad246d4cbb4377dd2f10260b9d
S: 75a67b1cadfc75a6acfa10f32ccc6a58a5bec974 <span class="token number">192.168</span>.1.14:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates dca4320ad3082c06d3ecef0376eb17dc44f2f667
M: 4a3e180a9805afa1a325523b2b9da68f4b2958b2 <span class="token number">192.168</span>.1.12:6379
   slots:10923-16383 <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: c287bfc868cc17ad246d4cbb4377dd2f10260b9d <span class="token number">192.168</span>.1.11:6379
   slots:5461-10922 <span class="token punctuation">(</span><span class="token number">5462</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.
<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered.

<span class="token comment">#如果有之前的操作导致Redis集群创建报错，则执行清空数据和集群命令：</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> FLUSHALL
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> cluster reset
OK</code></pre></div></figure>



<p><strong>查看Redis Cluster集群状态：</strong></p>
<figure><div class="code-wrapper"><pre class="language-SHELL" data-language="SHELL"><code class="language-SHELL">[root@node10 ~]# redis-trib.rb info 192.168.1.10:6379
192.168.1.10:6379 (dca4320a...) -&gt; 0 keys | 5461 slots | 1 slaves.
192.168.1.12:6379 (4a3e180a...) -&gt; 0 keys | 5461 slots | 1 slaves.
192.168.1.11:6379 (c287bfc8...) -&gt; 0 keys | 5462 slots | 1 slaves.
[OK] 0 keys in 3 masters.
0.00 keys per slot on average.
[root@node10 ~]# redis-trib.rb check 192.168.1.10:6379
&gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.10:6379)
M: dca4320ad3082c06d3ecef0376eb17dc44f2f667 192.168.1.10:6379
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
S: 555035ef69008b2932e6c0b182f503ed621d1cfd 192.168.1.13:6379
   slots: (0 slots) slave
   replicates 4a3e180a9805afa1a325523b2b9da68f4b2958b2
S: 06116e2e5a2ec9b57a0b122329d69ecfd91eb5b0 192.168.1.15:6379
   slots: (0 slots) slave
   replicates c287bfc868cc17ad246d4cbb4377dd2f10260b9d
S: 75a67b1cadfc75a6acfa10f32ccc6a58a5bec974 192.168.1.14:6379
   slots: (0 slots) slave
   replicates dca4320ad3082c06d3ecef0376eb17dc44f2f667
M: 4a3e180a9805afa1a325523b2b9da68f4b2958b2 192.168.1.12:6379
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
M: c287bfc868cc17ad246d4cbb4377dd2f10260b9d 192.168.1.11:6379
   slots:5461-10922 (5462 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.</code></pre></div></figure>



<h2 id="3-3-Redis-Cluster集群节点维护"><a href="#3-3-Redis-Cluster集群节点维护" class="headerlink" title="3.3 Redis Cluster集群节点维护"></a>3.3 Redis Cluster集群节点维护</h2><h3 id="3-3-1-集群维护之动态扩容"><a href="#3-3-1-集群维护之动态扩容" class="headerlink" title="3.3.1 集群维护之动态扩容"></a>3.3.1 集群维护之动态扩容</h3><p><strong>添加新的master节点到集群：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#将一台新的主机192.168.1.16加入集群,以下示例中192.168.1.10可以是任意存在的集群节点。</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-trib.rb add-node 192.168.1.16:6379 192.168.1.10:6379</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-trib.rb info 192.168.1.10:6379</span>
<span class="token number">192.168</span>.1.10:6379 <span class="token punctuation">(</span>dca4320a<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">0</span> keys <span class="token operator">|</span> <span class="token number">5461</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.12:6379 <span class="token punctuation">(</span>4a3e180a<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">0</span> keys <span class="token operator">|</span> <span class="token number">5461</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.11:6379 <span class="token punctuation">(</span>c287bfc8<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">0</span> keys <span class="token operator">|</span> <span class="token number">5462</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.16:6379 <span class="token punctuation">(</span>c0ffe8c6<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">0</span> keys <span class="token operator">|</span> <span class="token number">0</span> slots <span class="token operator">|</span> <span class="token number">0</span> slaves.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> <span class="token number">0</span> keys <span class="token keyword">in</span> <span class="token number">4</span> masters.
<span class="token number">0.00</span> keys per slot on average.</code></pre></div></figure>



<p><strong>在新的master上重新分配槽位：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-trib.rb reshard 192.168.1.10:6379</span>
<span class="token comment">#如果迁移失败使用此命令修复集群</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-trib.rb fix 192.168.1.10:6379</span></code></pre></div></figure>



<p><strong>为新的master添加新的slave节点：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#向当前的Redis集群中添加一个Redis单机服务器192.168.1.17，用于解决当前192.168.1.16单机的潜在宕机问题</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-trib.rb add-node --slave --master-id c0ffe8c67fd7c5267ffed0415ee9cefaf76215d4 192.168.1.17:6379 192.168.1.10:6379</span></code></pre></div></figure>



<h3 id="3-3-2-集群维护之动态缩容"><a href="#3-3-2-集群维护之动态缩容" class="headerlink" title="3.3.2 集群维护之动态缩容"></a>3.3.2 集群维护之动态缩容</h3><p><strong>迁移master 的槽位之其他master ：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#下线主节点192.168.1.12及其从节点192.168.1.13</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-trib.rb check 192.168.1.10:6379</span>
<span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using <span class="token function">node</span> <span class="token number">192.168</span>.1.10:6379<span class="token punctuation">)</span>
M: dca4320ad3082c06d3ecef0376eb17dc44f2f667 <span class="token number">192.168</span>.1.10:6379
   slots:1365-5460 <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: 555035ef69008b2932e6c0b182f503ed621d1cfd <span class="token number">192.168</span>.1.13:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 4a3e180a9805afa1a325523b2b9da68f4b2958b2
S: 06116e2e5a2ec9b57a0b122329d69ecfd91eb5b0 <span class="token number">192.168</span>.1.15:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates c287bfc868cc17ad246d4cbb4377dd2f10260b9d
S: 75a67b1cadfc75a6acfa10f32ccc6a58a5bec974 <span class="token number">192.168</span>.1.14:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates dca4320ad3082c06d3ecef0376eb17dc44f2f667
M: 4a3e180a9805afa1a325523b2b9da68f4b2958b2 <span class="token number">192.168</span>.1.12:6379
   slots:12288-16383 <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: c287bfc868cc17ad246d4cbb4377dd2f10260b9d <span class="token number">192.168</span>.1.11:6379
   slots:6827-10922 <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: 59fd0573637bca6de96209ae345afbaf81db73a6 <span class="token number">192.168</span>.1.17:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates c0ffe8c67fd7c5267ffed0415ee9cefaf76215d4
M: c0ffe8c67fd7c5267ffed0415ee9cefaf76215d4 <span class="token number">192.168</span>.1.16:6379
   slots:0-1364,5461-6826,10923-12287 <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.
<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered.

<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-trib.rb reshard 192.168.1.10:6379</span>
<span class="token comment">#如果迁移失败使用此命令修复集群</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-trib.rb fix 192.168.1.10:6379</span></code></pre></div></figure>



<p><strong>从集群删除服务器：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#redis-trib.rb del-node &lt;任意cluster节点的IP:port> &lt;删除节点的ID></span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-trib.rb del-node 192.168.1.10:6379 4a3e180a9805afa1a325523b2b9da68f4b2958b2</span>
<span class="token operator">>></span><span class="token operator">></span> Removing <span class="token function">node</span> 4a3e180a9805afa1a325523b2b9da68f4b2958b2 from cluster <span class="token number">192.168</span>.1.10:6379
<span class="token operator">>></span><span class="token operator">></span> Sending CLUSTER FORGET messages to the cluster<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> SHUTDOWN the node.

<span class="token comment">#删除多余的slave从节点</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-trib.rb del-node 192.168.1.10:6379 555035ef69008b2932e6c0b182f503ed621d1cfd</span>
<span class="token operator">>></span><span class="token operator">></span> Removing <span class="token function">node</span> 555035ef69008b2932e6c0b182f503ed621d1cfd from cluster <span class="token number">192.168</span>.1.10:6379
<span class="token operator">>></span><span class="token operator">></span> Sending CLUSTER FORGET messages to the cluster<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> SHUTDOWN the node.

<span class="token comment">#查看集群状态</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-trib.rb info 192.168.1.10:6379</span>
<span class="token number">192.168</span>.1.10:6379 <span class="token punctuation">(</span>dca4320a<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">0</span> keys <span class="token operator">|</span> <span class="token number">5452</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.11:6379 <span class="token punctuation">(</span>c287bfc8<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">0</span> keys <span class="token operator">|</span> <span class="token number">5452</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.16:6379 <span class="token punctuation">(</span>c0ffe8c6<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">0</span> keys <span class="token operator">|</span> <span class="token number">5480</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> <span class="token number">0</span> keys <span class="token keyword">in</span> <span class="token number">3</span> masters.
<span class="token number">0.00</span> keys per slot on average.</code></pre></div></figure>



<h1 id="4-Redis-6部署"><a href="#4-Redis-6部署" class="headerlink" title="4 Redis 6部署"></a>4 Redis 6部署</h1><p>基于Redis 6部署Redis Cluster集群：</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://redis.io/topics/cluster-tutorial">https://redis.io/topics/cluster-tutorial</a></p>
<h2 id="4-1-部署清单"><a href="#4-1-部署清单" class="headerlink" title="4.1 部署清单"></a>4.1 部署清单</h2><table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>操作系统</th>
<th>服务</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>node10</td>
<td>192.168.1.10</td>
<td>CentOS7.9</td>
<td>Redis6.2.9</td>
<td></td>
</tr>
<tr>
<td>node11</td>
<td>192.168.1.11</td>
<td>CentOS7.9</td>
<td>Redis6.2.9</td>
<td></td>
</tr>
<tr>
<td>node12</td>
<td>192.168.1.12</td>
<td>CentOS7.9</td>
<td>Redis6.2.9</td>
<td></td>
</tr>
<tr>
<td>node13</td>
<td>192.168.1.13</td>
<td>CentOS7.9</td>
<td>Redis6.2.9</td>
<td></td>
</tr>
<tr>
<td>node14</td>
<td>192.168.1.14</td>
<td>CentOS7.9</td>
<td>Redis6.2.9</td>
<td></td>
</tr>
<tr>
<td>node15</td>
<td>192.168.1.15</td>
<td>CentOS7.9</td>
<td>Redis6.2.9</td>
<td></td>
</tr>
<tr>
<td>node16</td>
<td>192.168.1.16</td>
<td>CentOS7.9</td>
<td>Redis6.2.9</td>
<td>集群动态扩容</td>
</tr>
<tr>
<td>node17</td>
<td>192.168.1.17</td>
<td>CentOS7.9</td>
<td>Redis6.2.9</td>
<td>集群动态扩容</td>
</tr>
</tbody></table>
<h2 id="4-2-安装配置Redis6-2-9"><a href="#4-2-安装配置Redis6-2-9" class="headerlink" title="4.2 安装配置Redis6.2.9"></a>4.2 安装配置Redis6.2.9</h2><p><strong>8个节点分别安装Redis：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#shell脚本一键安装Redis</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># vim install_redis.sh</span>
<span class="token comment">#!/bin/bash</span>
<span class="token assign-left variable">VERSION</span><span class="token operator">=</span>redis-6.2.9
<span class="token assign-left variable">PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span>
<span class="token assign-left variable">INSTALL_DIR</span><span class="token operator">=</span>/apps/redis
<span class="token function-name function">color</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token assign-left variable">RES_COL</span><span class="token operator">=</span><span class="token number">60</span>
    <span class="token assign-left variable">MOVE_TO_COL</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\\">\\</span>033[<span class="token variable">$&#123;RES_COL&#125;</span>G"</span>
    <span class="token assign-left variable">SETCOLOR_SUCCESS</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\\">\\</span>033[1;32m"</span>
    <span class="token assign-left variable">SETCOLOR_FAILURE</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\\">\\</span>033[1;31m"</span>
    <span class="token assign-left variable">SETCOLOR_WARNING</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\\">\\</span>033[1;33m"</span>
    <span class="token assign-left variable">SETCOLOR_NORMAL</span><span class="token operator">=</span><span class="token string">"echo -en <span class="token entity" title="\E">\E</span>[0m"</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$MOVE_TO_COL</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"["</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"success"</span> <span class="token parameter variable">-o</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token variable">$&#123;SETCOLOR_SUCCESS&#125;</span>
        <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> $<span class="token string">"  OK  "</span>    
    <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"failure"</span> <span class="token parameter variable">-o</span> <span class="token variable">$2</span> <span class="token operator">=</span> <span class="token string">"1"</span>  <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span> 
        <span class="token variable">$&#123;SETCOLOR_FAILURE&#125;</span>
        <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> $<span class="token string">"FAILED"</span>
    <span class="token keyword">else</span>
        <span class="token variable">$&#123;SETCOLOR_WARNING&#125;</span>
        <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> $<span class="token string">"WARNING"</span>
    <span class="token keyword">fi</span>
    <span class="token variable">$&#123;SETCOLOR_NORMAL&#125;</span>
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"]"</span>
    <span class="token builtin class-name">echo</span> 
<span class="token punctuation">&#125;</span>
<span class="token function-name function">install</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc gcc-c++ systemd-devel <span class="token function">wget</span> <span class="token operator">||</span> <span class="token punctuation">&#123;</span> color <span class="token string">"安装软件包失败，请检查网络配置"</span> <span class="token number">1</span> <span class="token punctuation">;</span> <span class="token builtin class-name">exit</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token function">wget</span> http://download.redis.io/releases/<span class="token variable">$&#123;VERSION&#125;</span>.tar.gz <span class="token operator">||</span> <span class="token punctuation">&#123;</span> color <span class="token string">"Redis 源码下载失败"</span> <span class="token number">1</span> <span class="token punctuation">;</span> <span class="token builtin class-name">exit</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token function">tar</span> xf <span class="token variable">$&#123;VERSION&#125;</span>.tar.gz
<span class="token builtin class-name">cd</span> <span class="token variable">$&#123;VERSION&#125;</span>
<span class="token function">make</span> <span class="token parameter variable">-j</span> <span class="token number">4</span> <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span><span class="token variable">$&#123;INSTALL_DIR&#125;</span> <span class="token function">install</span> <span class="token operator">&amp;&amp;</span> color <span class="token string">"Redis 编译安装完成"</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">&#123;</span> color <span class="token string">"Redis 编译安装失败"</span> <span class="token number">1</span> <span class="token punctuation">;</span><span class="token builtin class-name">exit</span> <span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token function">ln</span> <span class="token parameter variable">-s</span> <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/bin/redis-*  /usr/bin/
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/<span class="token punctuation">&#123;</span>etc,log,data,run<span class="token punctuation">&#125;</span>
<span class="token function">cp</span> redis.conf  <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/etc/redis.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">'s/bind 127.0.0.1/bind 0.0.0.0/'</span>  <span class="token parameter variable">-e</span> <span class="token string">"/# requirepass/a requirepass <span class="token variable">$PASSWORD</span>"</span>  <span class="token parameter variable">-e</span> <span class="token string">"/^dir .*/c dir <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/data/"</span>  <span class="token parameter variable">-e</span> <span class="token string">"/logfile .*/c logfile <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/log/redis.log"</span>  <span class="token parameter variable">-e</span>  <span class="token string">"/^pidfile .*/c  pidfile <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/run/redis.pid"</span> <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/etc/redis.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s@protected-mode yes@protected-mode no@'</span> <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/etc/redis.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s@daemonize no@daemonize yes@'</span> <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/etc/redis.conf

<span class="token keyword">if</span> <span class="token function">id</span> redis <span class="token operator">&amp;></span> /dev/null <span class="token punctuation">;</span><span class="token keyword">then</span> 
    color <span class="token string">"Redis 用户已存在"</span> <span class="token number">1</span> 
<span class="token keyword">else</span>
    <span class="token function">useradd</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-s</span> /sbin/nologin redis
    color <span class="token string">"Redis 用户创建成功"</span> <span class="token number">0</span>
<span class="token keyword">fi</span>
<span class="token function">chown</span> <span class="token parameter variable">-R</span> redis.redis <span class="token variable">$&#123;INSTALL_DIR&#125;</span>
<span class="token function">cat</span> <span class="token operator">>></span> /etc/sysctl.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
net.core.somaxconn = 1024
vm.overcommit_memory = 1
EOF</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-p</span> 
<span class="token builtin class-name">echo</span> <span class="token string">'echo never > /sys/kernel/mm/transparent_hugepage/enabled'</span> <span class="token operator">>></span> /etc/rc.d/rc.local
<span class="token function">chmod</span> +x /etc/rc.d/rc.local
/etc/rc.d/rc.local
<span class="token function">cat</span> <span class="token operator">></span> /usr/lib/systemd/system/redis.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=Redis persistent key-value database
After=network.target

[Service]
ExecStart=<span class="token variable">$&#123;INSTALL_DIR&#125;</span>/bin/redis-server <span class="token variable">$&#123;INSTALL_DIR&#125;</span>/etc/redis.conf --supervised systemd
ExecStop=/bin/kill -s QUIT \<span class="token variable">$MAINPID</span>
Type=notify
User=redis
Group=redis
RuntimeDirectory=redis
RuntimeDirectoryMode=0755

[Install]
WantedBy=multi-user.target
EOF</span>
systemctl daemon-reload 
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span>  redis <span class="token operator">&amp;></span> /dev/null <span class="token operator">&amp;&amp;</span> color <span class="token string">"Redis 服务启动成功,Redis信息如下:"</span>  <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">&#123;</span> color <span class="token string">"Redis 启动失败"</span> <span class="token number">1</span> <span class="token punctuation">;</span><span class="token builtin class-name">exit</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> 
<span class="token function">sleep</span> <span class="token number">2</span>
redis-cli <span class="token parameter variable">-a</span> <span class="token variable">$PASSWORD</span> INFO Server <span class="token operator"><span class="token file-descriptor important">2</span>></span> /dev/null

<span class="token punctuation">&#125;</span>
<span class="token function">install</span></code></pre></div></figure>



<p><strong>8个节点分别配置Redis：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># sed -i.bak -e 's/bind 127.0.0.1/bind 0.0.0.0/' -e '/masterauth/a masterauth 123456' -e '/# requirepass/a requirepass 123456' -e '/# cluster-enabled yes/a cluster-enabled yes' -e '/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf' -e '/cluster-require-full-coverage yes/c cluster-require-full-coverage no' /apps/redis/etc/redis.conf</span>

<span class="token comment">#重启redis服务</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart redis</span></code></pre></div></figure>



<p><strong>创建集群：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#命令redis-cli的选项 --cluster-replicas 1 表示每个master对应一个slave节点。</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -a 123456 --cluster create 192.168.1.10:6379 192.168.1.11:6379 192.168.1.12:6379 192.168.1.13:6379 192.168.1.14:6379 192.168.1.15:6379 --cluster-replicas 1</span>
Warning: Using a password with <span class="token string">'-a'</span> or <span class="token string">'-u'</span> option on the <span class="token builtin class-name">command</span> line interface may not be safe.
<span class="token operator">>></span><span class="token operator">></span> Performing <span class="token builtin class-name">hash</span> slots allocation on <span class="token number">6</span> nodes<span class="token punctuation">..</span>.
Master<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> -<span class="token operator">></span> Slots <span class="token number">0</span> - <span class="token number">5460</span>
Master<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> -<span class="token operator">></span> Slots <span class="token number">5461</span> - <span class="token number">10922</span>
Master<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> -<span class="token operator">></span> Slots <span class="token number">10923</span> - <span class="token number">16383</span>
Adding replica <span class="token number">192.168</span>.1.14:6379 to <span class="token number">192.168</span>.1.10:6379
Adding replica <span class="token number">192.168</span>.1.15:6379 to <span class="token number">192.168</span>.1.11:6379
Adding replica <span class="token number">192.168</span>.1.13:6379 to <span class="token number">192.168</span>.1.12:6379
M: 30825a8ad0835ae99dbf85239551f65a1f20bfaa <span class="token number">192.168</span>.1.10:6379
   slots:<span class="token punctuation">[</span><span class="token number">0</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
M: d42907fa14783afc68bbb4a751499a9e0bf032ae <span class="token number">192.168</span>.1.11:6379
   slots:<span class="token punctuation">[</span><span class="token number">5461</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5462</span> slots<span class="token punctuation">)</span> master
M: b666f51a7819dffa33669f5f8a809122e5ce92d6 <span class="token number">192.168</span>.1.12:6379
   slots:<span class="token punctuation">[</span><span class="token number">10923</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
S: 4a7175160eb05b564006690320e15837e4f2698f <span class="token number">192.168</span>.1.13:6379
   replicates b666f51a7819dffa33669f5f8a809122e5ce92d6
S: d96ec7cfb7cc36df811fba636a27fce5ed378a17 <span class="token number">192.168</span>.1.14:6379
   replicates 30825a8ad0835ae99dbf85239551f65a1f20bfaa
S: e94943e4670476e4c39bf0d7acc7a8ad114314da <span class="token number">192.168</span>.1.15:6379
   replicates d42907fa14783afc68bbb4a751499a9e0bf032ae
Can I <span class="token builtin class-name">set</span> the above configuration? <span class="token punctuation">(</span>type <span class="token string">'yes'</span> to accept<span class="token punctuation">)</span>: <span class="token function">yes</span> <span class="token comment">#输入yes自动创建集群</span>
<span class="token operator">>></span><span class="token operator">></span> Nodes configuration updated
<span class="token operator">>></span><span class="token operator">></span> Assign a different config epoch to each <span class="token function">node</span>
<span class="token operator">>></span><span class="token operator">></span> Sending CLUSTER MEET messages to <span class="token function">join</span> the cluster
Waiting <span class="token keyword">for</span> the cluster to <span class="token function">join</span>
<span class="token builtin class-name">.</span>
<span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using <span class="token function">node</span> <span class="token number">192.168</span>.1.10:6379<span class="token punctuation">)</span>
M: 30825a8ad0835ae99dbf85239551f65a1f20bfaa <span class="token number">192.168</span>.1.10:6379
   slots:<span class="token punctuation">[</span><span class="token number">0</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master <span class="token comment">#已经分配的槽位</span>
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">#分配了一个slave</span>
M: b666f51a7819dffa33669f5f8a809122e5ce92d6 <span class="token number">192.168</span>.1.12:6379
   slots:<span class="token punctuation">[</span><span class="token number">10923</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: e94943e4670476e4c39bf0d7acc7a8ad114314da <span class="token number">192.168</span>.1.15:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates d42907fa14783afc68bbb4a751499a9e0bf032ae
S: 4a7175160eb05b564006690320e15837e4f2698f <span class="token number">192.168</span>.1.13:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates b666f51a7819dffa33669f5f8a809122e5ce92d6
S: d96ec7cfb7cc36df811fba636a27fce5ed378a17 <span class="token number">192.168</span>.1.14:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 30825a8ad0835ae99dbf85239551f65a1f20bfaa
M: d42907fa14783afc68bbb4a751499a9e0bf032ae <span class="token number">192.168</span>.1.11:6379
   slots:<span class="token punctuation">[</span><span class="token number">5461</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5462</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration. <span class="token comment">#所有节点槽位分配完成</span>
<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>. <span class="token comment">#检查打开的槽位</span>
<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>. <span class="token comment">#检查插槽覆盖范围</span>
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered. <span class="token comment">#所有槽位(16384个)分配完成</span>

<span class="token comment">#查看当前集群状态</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -a 123456 --no-auth-warning cluster nodes</span>
b666f51a7819dffa33669f5f8a809122e5ce92d6 <span class="token number">192.168</span>.1.12:6379@16379 master - <span class="token number">0</span> <span class="token number">1676790118531</span> <span class="token number">3</span> connected <span class="token number">10923</span>-16383
30825a8ad0835ae99dbf85239551f65a1f20bfaa <span class="token number">192.168</span>.1.10:6379@16379 myself,master - <span class="token number">0</span> <span class="token number">1676790117000</span> <span class="token number">1</span> connected <span class="token number">0</span>-5460
e94943e4670476e4c39bf0d7acc7a8ad114314da <span class="token number">192.168</span>.1.15:6379@16379 slave d42907fa14783afc68bbb4a751499a9e0bf032ae <span class="token number">0</span> <span class="token number">1676790118000</span> <span class="token number">2</span> connected
4a7175160eb05b564006690320e15837e4f2698f <span class="token number">192.168</span>.1.13:6379@16379 slave b666f51a7819dffa33669f5f8a809122e5ce92d6 <span class="token number">0</span> <span class="token number">1676790118000</span> <span class="token number">3</span> connected
d96ec7cfb7cc36df811fba636a27fce5ed378a17 <span class="token number">192.168</span>.1.14:6379@16379 slave 30825a8ad0835ae99dbf85239551f65a1f20bfaa <span class="token number">0</span> <span class="token number">1676790117000</span> <span class="token number">1</span> connected
d42907fa14783afc68bbb4a751499a9e0bf032ae <span class="token number">192.168</span>.1.11:6379@16379 master - <span class="token number">0</span> <span class="token number">1676790119549</span> <span class="token number">2</span> connected <span class="token number">5461</span>-10922</code></pre></div></figure>



<p><strong>Python脚本实现Redis Cluster集群写入：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install python3</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># pip3 install redis-py-cluster</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># vim redis_cluster_test.py</span>
<span class="token comment">#!/usr/bin/env python3</span>
from rediscluster <span class="token function">import</span> RedisCluster
startup_nodes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span><span class="token string">"host"</span><span class="token builtin class-name">:</span><span class="token string">"192.168.1.10"</span>, <span class="token string">"port"</span>:6379<span class="token punctuation">&#125;</span>,
  <span class="token punctuation">&#123;</span><span class="token string">"host"</span><span class="token builtin class-name">:</span><span class="token string">"192.168.1.11"</span>, <span class="token string">"port"</span>:6379<span class="token punctuation">&#125;</span>,
  <span class="token punctuation">&#123;</span><span class="token string">"host"</span><span class="token builtin class-name">:</span><span class="token string">"192.168.1.12"</span>, <span class="token string">"port"</span>:6379<span class="token punctuation">&#125;</span>,
  <span class="token punctuation">&#123;</span><span class="token string">"host"</span><span class="token builtin class-name">:</span><span class="token string">"192.168.1.13"</span>, <span class="token string">"port"</span>:6379<span class="token punctuation">&#125;</span>,
  <span class="token punctuation">&#123;</span><span class="token string">"host"</span><span class="token builtin class-name">:</span><span class="token string">"192.168.1.14"</span>, <span class="token string">"port"</span>:6379<span class="token punctuation">&#125;</span>,
  <span class="token punctuation">&#123;</span><span class="token string">"host"</span><span class="token builtin class-name">:</span><span class="token string">"192.168.1.15"</span>, <span class="token string">"port"</span>:6379<span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span>
<span class="token assign-left variable">redis_conn</span><span class="token operator">=</span> RedisCluster<span class="token punctuation">(</span>startup_nodes<span class="token operator">=</span>startup_nodes,password<span class="token operator">=</span><span class="token string">'123456'</span>,
<span class="token assign-left variable">decode_responses</span><span class="token operator">=</span>True<span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">10000</span><span class="token punctuation">)</span>:
  redis_conn.set<span class="token punctuation">(</span><span class="token string">'key'</span>+str<span class="token punctuation">(</span>i<span class="token punctuation">)</span>,<span class="token string">'value'</span>+str<span class="token punctuation">(</span>i<span class="token punctuation">))</span>
  print<span class="token punctuation">(</span><span class="token string">'key'</span>+str<span class="token punctuation">(</span>i<span class="token punctuation">)</span>+<span class="token string">':'</span>,redis_conn.get<span class="token punctuation">(</span><span class="token string">'key'</span>+str<span class="token punctuation">(</span>i<span class="token punctuation">))</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># chmod +x redis_cluster_test.py </span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># ./redis_cluster_test.py</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
key9998: value9998
key9999: value9999</code></pre></div></figure>



<p><strong>模拟MASTER故障，对应的SLAVE节点自动提升为新MASTER：</strong></p>
<figure><div class="code-wrapper"><pre class="language-SHELL" data-language="SHELL"><code class="language-SHELL">#查看集群状态，模拟192.168.1.11故障。
[root@node10 ~]# redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning cluster nodes
b666f51a7819dffa33669f5f8a809122e5ce92d6 192.168.1.12:6379@16379 master - 0 1676791104491 3 connected 10923-16383
30825a8ad0835ae99dbf85239551f65a1f20bfaa 192.168.1.10:6379@16379 myself,master - 0 1676791102000 1 connected 0-5460
e94943e4670476e4c39bf0d7acc7a8ad114314da 192.168.1.15:6379@16379 slave d42907fa14783afc68bbb4a751499a9e0bf032ae 0 1676791103000 2 connected
4a7175160eb05b564006690320e15837e4f2698f 192.168.1.13:6379@16379 slave b666f51a7819dffa33669f5f8a809122e5ce92d6 0 1676791102000 3 connected
d96ec7cfb7cc36df811fba636a27fce5ed378a17 192.168.1.14:6379@16379 slave 30825a8ad0835ae99dbf85239551f65a1f20bfaa 0 1676791102000 1 connected
d42907fa14783afc68bbb4a751499a9e0bf032ae 192.168.1.11:6379@16379 master - 0 1676791103480 2 connected 5461-10922

[root@node11 ~]# systemctl stop redis
[root@node10 ~]# redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning cluster nodes
b666f51a7819dffa33669f5f8a809122e5ce92d6 192.168.1.12:6379@16379 master - 0 1676791428000 3 connected 10923-16383
30825a8ad0835ae99dbf85239551f65a1f20bfaa 192.168.1.10:6379@16379 myself,master - 0 1676791427000 1 connected 0-5460
e94943e4670476e4c39bf0d7acc7a8ad114314da 192.168.1.15:6379@16379 master - 0 1676791425556 7 connected 5461-10922 #192.168.1.15为新的MASTER
4a7175160eb05b564006690320e15837e4f2698f 192.168.1.13:6379@16379 slave b666f51a7819dffa33669f5f8a809122e5ce92d6 0 1676791427594 3 connected
d96ec7cfb7cc36df811fba636a27fce5ed378a17 192.168.1.14:6379@16379 slave 30825a8ad0835ae99dbf85239551f65a1f20bfaa 0 1676791428608 1 connected
d42907fa14783afc68bbb4a751499a9e0bf032ae 192.168.1.11:6379@16379 master,fail - 1676791204544 1676791201000 2 disconnected

#恢复192.168.1.11故障。自动成为SLAVE节点。
[root@node11 ~]# systemctl start redis
[root@node10 ~]# redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning cluster nodes
b666f51a7819dffa33669f5f8a809122e5ce92d6 192.168.1.12:6379@16379 master - 0 1676791577584 3 connected 10923-16383
30825a8ad0835ae99dbf85239551f65a1f20bfaa 192.168.1.10:6379@16379 myself,master - 0 1676791576000 1 connected 0-5460
e94943e4670476e4c39bf0d7acc7a8ad114314da 192.168.1.15:6379@16379 master - 0 1676791575568 7 connected 5461-10922
4a7175160eb05b564006690320e15837e4f2698f 192.168.1.13:6379@16379 slave b666f51a7819dffa33669f5f8a809122e5ce92d6 0 1676791576576 3 connected
d96ec7cfb7cc36df811fba636a27fce5ed378a17 192.168.1.14:6379@16379 slave 30825a8ad0835ae99dbf85239551f65a1f20bfaa 0 1676791578595 1 connected
d42907fa14783afc68bbb4a751499a9e0bf032ae 192.168.1.11:6379@16379 slave e94943e4670476e4c39bf0d7acc7a8ad114314da 0 1676791578000 7 connected #从节点</code></pre></div></figure>



<h2 id="4-3-Redis-Cluster集群节点维护"><a href="#4-3-Redis-Cluster集群节点维护" class="headerlink" title="4.3 Redis Cluster集群节点维护"></a>4.3 Redis Cluster集群节点维护</h2><h3 id="4-3-1-集群维护之动态扩容"><a href="#4-3-1-集群维护之动态扩容" class="headerlink" title="4.3.1 集群维护之动态扩容"></a>4.3.1 集群维护之动态扩容</h3><p>场景：三主三从的Redis Cluster架构可能无法满足现有业务的并发写入需求，因此将192.168.1.16，  192.168.1.17动态添加到集群中，但不能影响业务使用和数据丢失。</p>
<p><strong>注意: 生产环境一般建议master节点为奇数个,比如:3,5,7,以防止脑裂现象。</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#使用以下命令添加新节点，要添加的新Redis节点IP和端口添加到的已有的集群中任意节点的IP:端口</span>
add-node new_host:new_port existing_host:existing_port <span class="token punctuation">[</span>--slave --master-id<span class="token operator">&lt;</span>arg<span class="token operator">></span><span class="token punctuation">]</span>
	new_host:new_port <span class="token comment">#为新添加的主机的IP和端口</span>
	existing_host:existing_port <span class="token comment">#为已有的集群中任意节点的IP和端口</span></code></pre></div></figure>



<p><strong>添加新的master节点到集群：</strong></p>
<figure><div class="code-wrapper"><pre class="language-SHELL" data-language="SHELL"><code class="language-SHELL">#将一台新的主机192.168.1.16加入集群,以下示例中192.168.1.10可以是任意存在的集群节点。
[root@node10 ~]# redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning --cluster add-node 192.168.1.16:6379 192.168.1.10:6379
&gt;&gt;&gt; Adding node 192.168.1.16:6379 to cluster 192.168.1.10:6379
&gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.10:6379)
M: 30825a8ad0835ae99dbf85239551f65a1f20bfaa 192.168.1.10:6379
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
M: b666f51a7819dffa33669f5f8a809122e5ce92d6 192.168.1.12:6379
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
M: e94943e4670476e4c39bf0d7acc7a8ad114314da 192.168.1.15:6379
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
S: 4a7175160eb05b564006690320e15837e4f2698f 192.168.1.13:6379
   slots: (0 slots) slave
   replicates b666f51a7819dffa33669f5f8a809122e5ce92d6
S: d96ec7cfb7cc36df811fba636a27fce5ed378a17 192.168.1.14:6379
   slots: (0 slots) slave
   replicates 30825a8ad0835ae99dbf85239551f65a1f20bfaa
S: d42907fa14783afc68bbb4a751499a9e0bf032ae 192.168.1.11:6379
   slots: (0 slots) slave
   replicates e94943e4670476e4c39bf0d7acc7a8ad114314da
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
&gt;&gt;&gt; Send CLUSTER MEET to node 192.168.1.16:6379 to make it join the cluster.
[OK] New node added correctly.

#观察到该节点已经加入成功，但此节点上没有slot位,也无从节点，而且新的节点是master
[root@node10 ~]# redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning --cluster info 192.168.1.10:6379
192.168.1.10:6379 (30825a8a...) -&gt; 3331 keys | 5461 slots | 1 slaves.
192.168.1.12:6379 (b666f51a...) -&gt; 3329 keys | 5461 slots | 1 slaves.
192.168.1.15:6379 (e94943e4...) -&gt; 3340 keys | 5462 slots | 1 slaves.
192.168.1.16:6379 (3773d6d8...) -&gt; 0 keys | 0 slots | 0 slaves.
[OK] 10000 keys in 4 masters.
0.61 keys per slot on average.

[root@node10 ~]# redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning --cluster check 192.168.1.10:6379
192.168.1.10:6379 (30825a8a...) -&gt; 3331 keys | 5461 slots | 1 slaves.
192.168.1.12:6379 (b666f51a...) -&gt; 3329 keys | 5461 slots | 1 slaves.
192.168.1.15:6379 (e94943e4...) -&gt; 3340 keys | 5462 slots | 1 slaves.
192.168.1.16:6379 (3773d6d8...) -&gt; 0 keys | 0 slots | 0 slaves.
[OK] 10000 keys in 4 masters.
0.61 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check (using node 192.168.1.10:6379)
M: 30825a8ad0835ae99dbf85239551f65a1f20bfaa 192.168.1.10:6379
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
M: b666f51a7819dffa33669f5f8a809122e5ce92d6 192.168.1.12:6379
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
M: e94943e4670476e4c39bf0d7acc7a8ad114314da 192.168.1.15:6379
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
M: 3773d6d8b7f679b9d36545af0df3ed2f189aedc3 192.168.1.16:6379
   slots: (0 slots) master
S: 4a7175160eb05b564006690320e15837e4f2698f 192.168.1.13:6379
   slots: (0 slots) slave
   replicates b666f51a7819dffa33669f5f8a809122e5ce92d6
S: d96ec7cfb7cc36df811fba636a27fce5ed378a17 192.168.1.14:6379
   slots: (0 slots) slave
   replicates 30825a8ad0835ae99dbf85239551f65a1f20bfaa
S: d42907fa14783afc68bbb4a751499a9e0bf032ae 192.168.1.11:6379
   slots: (0 slots) slave
   replicates e94943e4670476e4c39bf0d7acc7a8ad114314da
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

[root@node10 ~]# redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning cluster nodes
b666f51a7819dffa33669f5f8a809122e5ce92d6 192.168.1.12:6379@16379 master - 0 1676792333261 3 connected 10923-16383
30825a8ad0835ae99dbf85239551f65a1f20bfaa 192.168.1.10:6379@16379 myself,master - 0 1676792329000 1 connected 0-5460
e94943e4670476e4c39bf0d7acc7a8ad114314da 192.168.1.15:6379@16379 master - 0 1676792331000 7 connected 5461-10922
3773d6d8b7f679b9d36545af0df3ed2f189aedc3 192.168.1.16:6379@16379 master - 0 1676792334266 0 connected
4a7175160eb05b564006690320e15837e4f2698f 192.168.1.13:6379@16379 slave b666f51a7819dffa33669f5f8a809122e5ce92d6 0 1676792331000 3 connected
d96ec7cfb7cc36df811fba636a27fce5ed378a17 192.168.1.14:6379@16379 slave 30825a8ad0835ae99dbf85239551f65a1f20bfaa 0 1676792332249 1 connected
d42907fa14783afc68bbb4a751499a9e0bf032ae 192.168.1.11:6379@16379 slave e94943e4670476e4c39bf0d7acc7a8ad114314da 0 1676792333000 7 connected

[root@node10 ~]# redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:7
cluster_size:3
cluster_current_epoch:7
cluster_my_epoch:1
cluster_stats_messages_ping_sent:2482
cluster_stats_messages_pong_sent:2486
cluster_stats_messages_fail_sent:4
cluster_stats_messages_auth-ack_sent:1
cluster_stats_messages_sent:4973
cluster_stats_messages_ping_received:2480
cluster_stats_messages_pong_received:2482
cluster_stats_messages_meet_received:6
cluster_stats_messages_fail_received:1
cluster_stats_messages_auth-req_received:1
cluster_stats_messages_received:4970</code></pre></div></figure>



<p><strong>在新的master上重新分配槽位：</strong></p>
<p>新的node节点加到集群之后,默认是master节点，但是没有slots，需要重新分配，添加主机之后需要对添加至集群中的新主机重新分片,否则其没有分片也就无法写入数据。 </p>
<p><strong>注意: 重新分配槽位需要清空数据,所以需要先备份数据,扩展后再恢复数据。</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning --cluster reshard 192.168.1.10:6379</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.
<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered.
How many slots <span class="token keyword">do</span> you want to move <span class="token punctuation">(</span>from <span class="token number">1</span> to <span class="token number">16384</span><span class="token punctuation">)</span>?4096 <span class="token comment">#新分配多少个槽位=16384/master个数</span>
What is the receiving <span class="token function">node</span> ID? d6e2eca6b338b717923f64866bd31d42e52edc98 <span class="token comment">#新的master的ID</span>
Please enter all the <span class="token builtin class-name">source</span> <span class="token function">node</span> IDs.
Type <span class="token string">'all'</span> to use all the nodes as <span class="token builtin class-name">source</span> nodes <span class="token keyword">for</span> the <span class="token builtin class-name">hash</span> slots.
Type <span class="token string">'done'</span> once you entered all the <span class="token builtin class-name">source</span> nodes IDs.
Source <span class="token function">node</span> <span class="token comment">#1: all #输入all,将哪些源主机的槽位分配给新的节点，all是自动在所有的redisnode选择划分，如果是从redis cluster删除某个主机可以使用此方式将指定主机上的槽位全部移动到别的redis主机。</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
Do you want to proceed with the proposed reshard plan <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>? <span class="token function">yes</span> <span class="token comment">#确认分配</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
Moving slot <span class="token number">12282</span> from <span class="token number">192.168</span>.1.12:6379 to <span class="token number">192.168</span>.1.16:6379: 
Moving slot <span class="token number">12283</span> from <span class="token number">192.168</span>.1.12:6379 to <span class="token number">192.168</span>.1.16:6379: <span class="token builtin class-name">.</span>
Moving slot <span class="token number">12284</span> from <span class="token number">192.168</span>.1.12:6379 to <span class="token number">192.168</span>.1.16:6379: 
Moving slot <span class="token number">12285</span> from <span class="token number">192.168</span>.1.12:6379 to <span class="token number">192.168</span>.1.16:6379: <span class="token builtin class-name">.</span>
Moving slot <span class="token number">12286</span> from <span class="token number">192.168</span>.1.12:6379 to <span class="token number">192.168</span>.1.16:6379: 
Moving slot <span class="token number">12287</span> from <span class="token number">192.168</span>.1.12:6379 to <span class="token number">192.168</span>.1.16:6379:

<span class="token comment">#确定slot分配成功</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning --cluster check 192.168.1.10:6379</span>
<span class="token number">192.168</span>.1.10:6379 <span class="token punctuation">(</span>30825a8a<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">2511</span> keys <span class="token operator">|</span> <span class="token number">4096</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.12:6379 <span class="token punctuation">(</span>b666f51a<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">2500</span> keys <span class="token operator">|</span> <span class="token number">4096</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.15:6379 <span class="token punctuation">(</span>e94943e4<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">2515</span> keys <span class="token operator">|</span> <span class="token number">4096</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.16:6379 <span class="token punctuation">(</span>3773d6d8<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">2474</span> keys <span class="token operator">|</span> <span class="token number">4096</span> slots <span class="token operator">|</span> <span class="token number">0</span> slaves.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> <span class="token number">10000</span> keys <span class="token keyword">in</span> <span class="token number">4</span> masters.
<span class="token number">0.61</span> keys per slot on average.
<span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using <span class="token function">node</span> <span class="token number">192.168</span>.1.10:6379<span class="token punctuation">)</span>
M: 30825a8ad0835ae99dbf85239551f65a1f20bfaa <span class="token number">192.168</span>.1.10:6379
   slots:<span class="token punctuation">[</span><span class="token number">1365</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: b666f51a7819dffa33669f5f8a809122e5ce92d6 <span class="token number">192.168</span>.1.12:6379
   slots:<span class="token punctuation">[</span><span class="token number">12288</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: e94943e4670476e4c39bf0d7acc7a8ad114314da <span class="token number">192.168</span>.1.15:6379
   slots:<span class="token punctuation">[</span><span class="token number">6827</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: 3773d6d8b7f679b9d36545af0df3ed2f189aedc3 <span class="token number">192.168</span>.1.16:6379
   slots:<span class="token punctuation">[</span><span class="token number">0</span>-1364<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">5461</span>-6826<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">10923</span>-12287<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
S: 4a7175160eb05b564006690320e15837e4f2698f <span class="token number">192.168</span>.1.13:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates b666f51a7819dffa33669f5f8a809122e5ce92d6
S: d96ec7cfb7cc36df811fba636a27fce5ed378a17 <span class="token number">192.168</span>.1.14:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 30825a8ad0835ae99dbf85239551f65a1f20bfaa
S: d42907fa14783afc68bbb4a751499a9e0bf032ae <span class="token number">192.168</span>.1.11:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates e94943e4670476e4c39bf0d7acc7a8ad114314da
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.
<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered.</code></pre></div></figure>



<p><strong>为新的master添加新的slave节点：</strong></p>
<p>需要再向当前的Redis集群中添加一个Redis单机服务器192.168.1.17，用于解决当前192.168.1.16单机的潜在宕机问题，即实现相应的高可用功能，有两种方式：  </p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#方式一：在新加节点到集群时，直接将之设置为slave</span>
redis-cli <span class="token parameter variable">-a</span> <span class="token number">123456</span> <span class="token parameter variable">--cluster</span> add-node <span class="token number">10.0</span>.0.78:6379 <span class="token operator">&lt;</span>任意集群节点<span class="token operator">></span>:6379 --cluster-slave --cluster-master-id <span class="token operator">&lt;</span>master ID<span class="token operator">></span>

<span class="token comment">#直接加为slave节点</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -a 123456 --cluster add-node 192.168.1.17:6379 192.168.1.10:6379 --cluster-slave --cluster-master-id 3773d6d8b7f679b9d36545af0df3ed2f189aedc3</span>
Warning: Using a password with <span class="token string">'-a'</span> or <span class="token string">'-u'</span> option on the <span class="token builtin class-name">command</span> line interface may not be safe.
<span class="token operator">>></span><span class="token operator">></span> Adding <span class="token function">node</span> <span class="token number">192.168</span>.1.17:6379 to cluster <span class="token number">192.168</span>.1.10:6379
<span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using <span class="token function">node</span> <span class="token number">192.168</span>.1.10:6379<span class="token punctuation">)</span>
M: 30825a8ad0835ae99dbf85239551f65a1f20bfaa <span class="token number">192.168</span>.1.10:6379
   slots:<span class="token punctuation">[</span><span class="token number">1365</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: b666f51a7819dffa33669f5f8a809122e5ce92d6 <span class="token number">192.168</span>.1.12:6379
   slots:<span class="token punctuation">[</span><span class="token number">12288</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: e94943e4670476e4c39bf0d7acc7a8ad114314da <span class="token number">192.168</span>.1.15:6379
   slots:<span class="token punctuation">[</span><span class="token number">6827</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: 3773d6d8b7f679b9d36545af0df3ed2f189aedc3 <span class="token number">192.168</span>.1.16:6379
   slots:<span class="token punctuation">[</span><span class="token number">0</span>-1364<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">5461</span>-6826<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">10923</span>-12287<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
S: 4a7175160eb05b564006690320e15837e4f2698f <span class="token number">192.168</span>.1.13:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates b666f51a7819dffa33669f5f8a809122e5ce92d6
S: d96ec7cfb7cc36df811fba636a27fce5ed378a17 <span class="token number">192.168</span>.1.14:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 30825a8ad0835ae99dbf85239551f65a1f20bfaa
S: d42907fa14783afc68bbb4a751499a9e0bf032ae <span class="token number">192.168</span>.1.11:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates e94943e4670476e4c39bf0d7acc7a8ad114314da
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.
<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered.
<span class="token operator">>></span><span class="token operator">></span> Send CLUSTER MEET to <span class="token function">node</span> <span class="token number">192.168</span>.1.17:6379 to <span class="token function">make</span> it <span class="token function">join</span> the cluster.
Waiting <span class="token keyword">for</span> the cluster to <span class="token function">join</span>

<span class="token operator">>></span><span class="token operator">></span> Configure <span class="token function">node</span> as replica of <span class="token number">192.168</span>.1.16:6379.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> New <span class="token function">node</span> added correctly.

<span class="token comment">#验证是否添加成功</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning --cluster check 192.168.1.10:6379</span>
<span class="token number">192.168</span>.1.10:6379 <span class="token punctuation">(</span>30825a8a<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">2511</span> keys <span class="token operator">|</span> <span class="token number">4096</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.12:6379 <span class="token punctuation">(</span>b666f51a<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">2500</span> keys <span class="token operator">|</span> <span class="token number">4096</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.15:6379 <span class="token punctuation">(</span>e94943e4<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">2515</span> keys <span class="token operator">|</span> <span class="token number">4096</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.16:6379 <span class="token punctuation">(</span>3773d6d8<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">2474</span> keys <span class="token operator">|</span> <span class="token number">4096</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> <span class="token number">10000</span> keys <span class="token keyword">in</span> <span class="token number">4</span> masters.
<span class="token number">0.61</span> keys per slot on average.
<span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using <span class="token function">node</span> <span class="token number">192.168</span>.1.10:6379<span class="token punctuation">)</span>
M: 30825a8ad0835ae99dbf85239551f65a1f20bfaa <span class="token number">192.168</span>.1.10:6379
   slots:<span class="token punctuation">[</span><span class="token number">1365</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: b666f51a7819dffa33669f5f8a809122e5ce92d6 <span class="token number">192.168</span>.1.12:6379
   slots:<span class="token punctuation">[</span><span class="token number">12288</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: e94943e4670476e4c39bf0d7acc7a8ad114314da <span class="token number">192.168</span>.1.15:6379
   slots:<span class="token punctuation">[</span><span class="token number">6827</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: b729c6b6f3551bba304fffbba947d67d65e264a8 <span class="token number">192.168</span>.1.17:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 3773d6d8b7f679b9d36545af0df3ed2f189aedc3
M: 3773d6d8b7f679b9d36545af0df3ed2f189aedc3 <span class="token number">192.168</span>.1.16:6379
   slots:<span class="token punctuation">[</span><span class="token number">0</span>-1364<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">5461</span>-6826<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">10923</span>-12287<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: 4a7175160eb05b564006690320e15837e4f2698f <span class="token number">192.168</span>.1.13:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates b666f51a7819dffa33669f5f8a809122e5ce92d6
S: d96ec7cfb7cc36df811fba636a27fce5ed378a17 <span class="token number">192.168</span>.1.14:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 30825a8ad0835ae99dbf85239551f65a1f20bfaa
S: d42907fa14783afc68bbb4a751499a9e0bf032ae <span class="token number">192.168</span>.1.11:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates e94943e4670476e4c39bf0d7acc7a8ad114314da
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.
<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered.

<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning cluster info</span>
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:8
cluster_size:4
cluster_current_epoch:8
cluster_my_epoch:1
cluster_stats_messages_ping_sent:3337
cluster_stats_messages_pong_sent:3323
cluster_stats_messages_fail_sent:4
cluster_stats_messages_auth-ack_sent:1
cluster_stats_messages_update_sent:9
cluster_stats_messages_sent:6674
cluster_stats_messages_ping_received:3316
cluster_stats_messages_pong_received:7433
cluster_stats_messages_meet_received:7
cluster_stats_messages_fail_received:1
cluster_stats_messages_auth-req_received:1
cluster_stats_messages_received:10758</code></pre></div></figure>



<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#方式二：先将新节点加入集群，再修改为slave</span>
<span class="token comment">#将192.168.1.17添加到集群中。</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning --cluster add-node 192.168.1.17:6379 192.168.1.10:6379</span>

<span class="token comment">#更改新节点更改状态为slave</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 192.168.1.17 -p 6379 -a 123456 --no-auth-warning</span>
<span class="token number">192.168</span>.1.17:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> CLUSTER NODES <span class="token comment">##查看当前集群节点，找到目标master的ID</span>
<span class="token number">192.168</span>.1.17:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> CLUSTER REPLICATE 3773d6d8b7f679b9d36545af0df3ed2f189aedc3 <span class="token comment">#将其设置slave，命令格式为CLUSTER REPLICATE MASTER_ID</span>
<span class="token number">192.168</span>.1.17:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> CLUSTER NODES <span class="token comment">#再次查看集群节点状态，验证节点是否已经更改为指定master的slave</span></code></pre></div></figure>



<h3 id="4-3-2-集群维护之动态缩容"><a href="#4-3-2-集群维护之动态缩容" class="headerlink" title="4.3.2 集群维护之动态缩容"></a>4.3.2 集群维护之动态缩容</h3><p>场景：由于192.168.1.12服务器故障，需将现有Redis集群的8台主服务器中的master 192.168.1.12和对应的slave 192.168.1.13下线。</p>
<p><strong>删除节点过程：</strong>添加节点的时候是先添加node节点到集群，然后分配槽位，删除节点的操作与添加节点的操作正好相反，是先将被要删除的Redis node上的槽位迁移到集群中的其他Redis node节点上，然后再将其删除，如果一个Redis node节点上的槽位没有被完全迁移，删除该node的时候会提示有数据且无法删除。  </p>
<p><strong>注意: 被迁移Redis master源服务器必须保证没有数据，否则迁移报错并会被强制中断。</strong></p>
<p><strong>迁移master 的槽位之其他master ：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#查看当前状态</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment">#  redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning --cluster check 192.168.1.10:6379</span>
<span class="token number">192.168</span>.1.10:6379 <span class="token punctuation">(</span>30825a8a<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">2511</span> keys <span class="token operator">|</span> <span class="token number">4096</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.12:6379 <span class="token punctuation">(</span>b666f51a<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">2500</span> keys <span class="token operator">|</span> <span class="token number">4096</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.15:6379 <span class="token punctuation">(</span>e94943e4<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">2515</span> keys <span class="token operator">|</span> <span class="token number">4096</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.16:6379 <span class="token punctuation">(</span>3773d6d8<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">2474</span> keys <span class="token operator">|</span> <span class="token number">4096</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> <span class="token number">10000</span> keys <span class="token keyword">in</span> <span class="token number">4</span> masters.
<span class="token number">0.61</span> keys per slot on average.
<span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using <span class="token function">node</span> <span class="token number">192.168</span>.1.10:6379<span class="token punctuation">)</span>
M: 30825a8ad0835ae99dbf85239551f65a1f20bfaa <span class="token number">192.168</span>.1.10:6379
   slots:<span class="token punctuation">[</span><span class="token number">1365</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: b666f51a7819dffa33669f5f8a809122e5ce92d6 <span class="token number">192.168</span>.1.12:6379
   slots:<span class="token punctuation">[</span><span class="token number">12288</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: e94943e4670476e4c39bf0d7acc7a8ad114314da <span class="token number">192.168</span>.1.15:6379
   slots:<span class="token punctuation">[</span><span class="token number">6827</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: b729c6b6f3551bba304fffbba947d67d65e264a8 <span class="token number">192.168</span>.1.17:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 3773d6d8b7f679b9d36545af0df3ed2f189aedc3
M: 3773d6d8b7f679b9d36545af0df3ed2f189aedc3 <span class="token number">192.168</span>.1.16:6379
   slots:<span class="token punctuation">[</span><span class="token number">0</span>-1364<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">5461</span>-6826<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">10923</span>-12287<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: 4a7175160eb05b564006690320e15837e4f2698f <span class="token number">192.168</span>.1.13:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates b666f51a7819dffa33669f5f8a809122e5ce92d6
S: d96ec7cfb7cc36df811fba636a27fce5ed378a17 <span class="token number">192.168</span>.1.14:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 30825a8ad0835ae99dbf85239551f65a1f20bfaa
S: d42907fa14783afc68bbb4a751499a9e0bf032ae <span class="token number">192.168</span>.1.11:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates e94943e4670476e4c39bf0d7acc7a8ad114314da
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.
<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered.

<span class="token comment">#连接到任意集群节点，#最后1365个slot从192.168.1.12移动到第一个master节点192.168.1.10上</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning --cluster reshard 192.168.1.10:6379</span>
<span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using <span class="token function">node</span> <span class="token number">192.168</span>.1.10:6379<span class="token punctuation">)</span>
M: 30825a8ad0835ae99dbf85239551f65a1f20bfaa <span class="token number">192.168</span>.1.10:6379
   slots:<span class="token punctuation">[</span><span class="token number">1365</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: b666f51a7819dffa33669f5f8a809122e5ce92d6 <span class="token number">192.168</span>.1.12:6379
   slots:<span class="token punctuation">[</span><span class="token number">12288</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: e94943e4670476e4c39bf0d7acc7a8ad114314da <span class="token number">192.168</span>.1.15:6379
   slots:<span class="token punctuation">[</span><span class="token number">6827</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: b729c6b6f3551bba304fffbba947d67d65e264a8 <span class="token number">192.168</span>.1.17:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 3773d6d8b7f679b9d36545af0df3ed2f189aedc3
M: 3773d6d8b7f679b9d36545af0df3ed2f189aedc3 <span class="token number">192.168</span>.1.16:6379
   slots:<span class="token punctuation">[</span><span class="token number">0</span>-1364<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">5461</span>-6826<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">10923</span>-12287<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">4096</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: 4a7175160eb05b564006690320e15837e4f2698f <span class="token number">192.168</span>.1.13:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates b666f51a7819dffa33669f5f8a809122e5ce92d6
S: d96ec7cfb7cc36df811fba636a27fce5ed378a17 <span class="token number">192.168</span>.1.14:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 30825a8ad0835ae99dbf85239551f65a1f20bfaa
S: d42907fa14783afc68bbb4a751499a9e0bf032ae <span class="token number">192.168</span>.1.11:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates e94943e4670476e4c39bf0d7acc7a8ad114314da
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.
<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered.
How many slots <span class="token keyword">do</span> you want to move <span class="token punctuation">(</span>from <span class="token number">1</span> to <span class="token number">16384</span><span class="token punctuation">)</span>? <span class="token number">1356</span> <span class="token comment">#共4096/3分别给其它三个master节点</span>
What is the receiving <span class="token function">node</span> ID? 30825a8ad0835ae99dbf85239551f65a1f20bfaa <span class="token comment">#要迁移哪个master的ID(192.168.1.10的ID)</span>
Please enter all the <span class="token builtin class-name">source</span> <span class="token function">node</span> IDs.
  Type <span class="token string">'all'</span> to use all the nodes as <span class="token builtin class-name">source</span> nodes <span class="token keyword">for</span> the <span class="token builtin class-name">hash</span> slots.
  Type <span class="token string">'done'</span> once you entered all the <span class="token builtin class-name">source</span> nodes IDs.
Source <span class="token function">node</span> <span class="token comment">#1: b666f51a7819dffa33669f5f8a809122e5ce92d6 #输入要删除节点192.168.1.12的ID</span>
Source <span class="token function">node</span> <span class="token comment">#2: done</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
    Moving slot <span class="token number">13636</span> from b666f51a7819dffa33669f5f8a809122e5ce92d6
    Moving slot <span class="token number">13637</span> from b666f51a7819dffa33669f5f8a809122e5ce92d6
    Moving slot <span class="token number">13638</span> from b666f51a7819dffa33669f5f8a809122e5ce92d6
    Moving slot <span class="token number">13639</span> from b666f51a7819dffa33669f5f8a809122e5ce92d6
    Moving slot <span class="token number">13640</span> from b666f51a7819dffa33669f5f8a809122e5ce92d6
    Moving slot <span class="token number">13641</span> from b666f51a7819dffa33669f5f8a809122e5ce92d6
    Moving slot <span class="token number">13642</span> from b666f51a7819dffa33669f5f8a809122e5ce92d6
    Moving slot <span class="token number">13643</span> from b666f51a7819dffa33669f5f8a809122e5ce92d6
Do you want to proceed with the proposed reshard plan <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>? <span class="token function">yes</span>

<span class="token comment">#非交互式方式:再将1365个slot从192.168.1.12移动到第二个master节点192.168.1.15上</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -a 123456 --cluster reshard 192.168.1.10:6379 --cluster-slots 1365 --cluster-from b666f51a7819dffa33669f5f8a809122e5ce92d6 --cluster-to e94943e4670476e4c39bf0d7acc7a8ad114314da --cluster-yes</span>

<span class="token comment">#最后的slot从192.168.1.12移动到第三个master节点192.168.1.16上</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -a 123456 --cluster reshard 192.168.1.10:6379 --cluster-slots 1375 --cluster-from b666f51a7819dffa33669f5f8a809122e5ce92d6 --cluster-to 3773d6d8b7f679b9d36545af0df3ed2f189aedc3 --cluster-yes</span>

<span class="token comment">#确认192.168.1.12的所有slot都移走了，上面的slave也自动删除，成为其它master的slave</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning --cluster check 192.168.1.10:6379</span>
<span class="token number">192.168</span>.1.10:6379 <span class="token punctuation">(</span>30825a8a<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">3351</span> keys <span class="token operator">|</span> <span class="token number">5452</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.12:6379 <span class="token punctuation">(</span>b666f51a<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">0</span> keys <span class="token operator">|</span> <span class="token number">0</span> slots <span class="token operator">|</span> <span class="token number">0</span> slaves.
<span class="token number">192.168</span>.1.15:6379 <span class="token punctuation">(</span>e94943e4<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">3335</span> keys <span class="token operator">|</span> <span class="token number">5461</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.16:6379 <span class="token punctuation">(</span>3773d6d8<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">3314</span> keys <span class="token operator">|</span> <span class="token number">5471</span> slots <span class="token operator">|</span> <span class="token number">2</span> slaves.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> <span class="token number">10000</span> keys <span class="token keyword">in</span> <span class="token number">4</span> masters.
<span class="token number">0.61</span> keys per slot on average.
<span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using <span class="token function">node</span> <span class="token number">192.168</span>.1.10:6379<span class="token punctuation">)</span>
M: 30825a8ad0835ae99dbf85239551f65a1f20bfaa <span class="token number">192.168</span>.1.10:6379
   slots:<span class="token punctuation">[</span><span class="token number">1365</span>-5460<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">12288</span>-13643<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5452</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: b666f51a7819dffa33669f5f8a809122e5ce92d6 <span class="token number">192.168</span>.1.12:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> master
M: e94943e4670476e4c39bf0d7acc7a8ad114314da <span class="token number">192.168</span>.1.15:6379
   slots:<span class="token punctuation">[</span><span class="token number">6827</span>-10922<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">13644</span>-15008<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: b729c6b6f3551bba304fffbba947d67d65e264a8 <span class="token number">192.168</span>.1.17:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 3773d6d8b7f679b9d36545af0df3ed2f189aedc3
M: 3773d6d8b7f679b9d36545af0df3ed2f189aedc3 <span class="token number">192.168</span>.1.16:6379
   slots:<span class="token punctuation">[</span><span class="token number">0</span>-1364<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">5461</span>-6826<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">10923</span>-12287<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">15009</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5471</span> slots<span class="token punctuation">)</span> master
   <span class="token number">2</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: 4a7175160eb05b564006690320e15837e4f2698f <span class="token number">192.168</span>.1.13:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 3773d6d8b7f679b9d36545af0df3ed2f189aedc3
S: d96ec7cfb7cc36df811fba636a27fce5ed378a17 <span class="token number">192.168</span>.1.14:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 30825a8ad0835ae99dbf85239551f65a1f20bfaa
S: d42907fa14783afc68bbb4a751499a9e0bf032ae <span class="token number">192.168</span>.1.11:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates e94943e4670476e4c39bf0d7acc7a8ad114314da
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.
<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered.</code></pre></div></figure>



<p><strong>从集群删除服务器：</strong></p>
<p>虽然槽位已经迁移完成，但是服务器IP信息还在集群当中，因此还需要将IP信息从集群删除。</p>
<p><strong>注意: 删除服务器前,必须清除主机上面的槽位,否则会删除主机失败。</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">-a</span> <span class="token number">123456</span> <span class="token parameter variable">--cluster</span> del-node <span class="token operator">&lt;</span>任意cluster节点的IP:port<span class="token operator">></span> <span class="token operator">&lt;</span>删除节点的ID<span class="token operator">></span>

<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning --cluster del-node 192.168.1.10:6379 b666f51a7819dffa33669f5f8a809122e5ce92d6</span>
<span class="token operator">>></span><span class="token operator">></span> Removing <span class="token function">node</span> b666f51a7819dffa33669f5f8a809122e5ce92d6 from cluster <span class="token number">192.168</span>.1.10:6379
<span class="token operator">>></span><span class="token operator">></span> Sending CLUSTER FORGET messages to the cluster<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> Sending CLUSTER RESET SOFT to the deleted node.

<span class="token comment">#删除多余的slave从节点</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning --cluster del-node 192.168.1.10:6379 4a7175160eb05b564006690320e15837e4f2698f</span>
<span class="token operator">>></span><span class="token operator">></span> Removing <span class="token function">node</span> 4a7175160eb05b564006690320e15837e4f2698f from cluster <span class="token number">192.168</span>.1.10:6379
<span class="token operator">>></span><span class="token operator">></span> Sending CLUSTER FORGET messages to the cluster<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> Sending CLUSTER RESET SOFT to the deleted node.

<span class="token comment">#查看集群状态</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -c -h 192.168.1.10 -a 123456 --no-auth-warning --cluster check 192.168.1.10:6379</span>
<span class="token number">192.168</span>.1.10:6379 <span class="token punctuation">(</span>30825a8a<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">3351</span> keys <span class="token operator">|</span> <span class="token number">5452</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.15:6379 <span class="token punctuation">(</span>e94943e4<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">3335</span> keys <span class="token operator">|</span> <span class="token number">5461</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token number">192.168</span>.1.16:6379 <span class="token punctuation">(</span>3773d6d8<span class="token punctuation">..</span>.<span class="token punctuation">)</span> -<span class="token operator">></span> <span class="token number">3314</span> keys <span class="token operator">|</span> <span class="token number">5471</span> slots <span class="token operator">|</span> <span class="token number">1</span> slaves.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> <span class="token number">10000</span> keys <span class="token keyword">in</span> <span class="token number">3</span> masters.
<span class="token number">0.61</span> keys per slot on average.
<span class="token operator">>></span><span class="token operator">></span> Performing Cluster Check <span class="token punctuation">(</span>using <span class="token function">node</span> <span class="token number">192.168</span>.1.10:6379<span class="token punctuation">)</span>
M: 30825a8ad0835ae99dbf85239551f65a1f20bfaa <span class="token number">192.168</span>.1.10:6379
   slots:<span class="token punctuation">[</span><span class="token number">1365</span>-5460<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">12288</span>-13643<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5452</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: e94943e4670476e4c39bf0d7acc7a8ad114314da <span class="token number">192.168</span>.1.15:6379
   slots:<span class="token punctuation">[</span><span class="token number">6827</span>-10922<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">13644</span>-15008<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: b729c6b6f3551bba304fffbba947d67d65e264a8 <span class="token number">192.168</span>.1.17:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 3773d6d8b7f679b9d36545af0df3ed2f189aedc3
M: 3773d6d8b7f679b9d36545af0df3ed2f189aedc3 <span class="token number">192.168</span>.1.16:6379
   slots:<span class="token punctuation">[</span><span class="token number">0</span>-1364<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">5461</span>-6826<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">10923</span>-12287<span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">15009</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5471</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: d96ec7cfb7cc36df811fba636a27fce5ed378a17 <span class="token number">192.168</span>.1.14:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 30825a8ad0835ae99dbf85239551f65a1f20bfaa
S: d42907fa14783afc68bbb4a751499a9e0bf032ae <span class="token number">192.168</span>.1.11:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates e94943e4670476e4c39bf0d7acc7a8ad114314da
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.
<span class="token operator">>></span><span class="token operator">></span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.
<span class="token operator">>></span><span class="token operator">></span> Check slots coverage<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered.</code></pre></div></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Linux/" class="category-chain-item">Linux</a>
  
  
    <span>></span>
    
  <a href="/categories/Linux/Redis/" class="category-chain-item">Redis</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Redis/">#Redis</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>(6).Redis之Cluster集群</div>
      <div>https://chsblogs.gitee.io/2023/02/19/NoSQL/Redis/redis06/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>陈怀森</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年2月19日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/02/28/Web/Tomcat/tomcat01/" title="(1).Tomcat之JDK安装">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">(1).Tomcat之JDK安装</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/02/18/NoSQL/Redis/redis05/" title="(5).Redis哨兵机制">
                        <span class="hidden-mobile">(5).Redis哨兵机制</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    
      <script type="text/javascript">
        var disqus_config = function() {
          this.page.url = 'https://chsblogs.gitee.io/2023/02/19/NoSQL/Redis/redis06/';
          this.page.identifier = '/2023/02/19/NoSQL/Redis/redis06/';
        };
        Fluid.utils.loadComments('#disqus_thread', function() {
          var d = document, s = d.createElement('script');
          s.src = '//' + 'fluid' + '.disqus.com/embed.js';
          s.setAttribute('data-timestamp', new Date());
          (d.head || d.body).appendChild(s);
        });
      </script>
    
    <noscript>Please enable JavaScript to view the comments</noscript>
  </div>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar category-bar" style="margin-left: -1rem">
    





<div class="category-list">
  
  
    
    
    
    <div class="category row nomargin-x">
      <a class="category-item 
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Redis"
        id="heading-e111446745a1825b862f8727ae63bce4" role="tab" data-toggle="collapse" href="#collapse-e111446745a1825b862f8727ae63bce4"
        aria-expanded="true"
      >
        Redis
        <span class="list-group-count">(6)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse show" id="collapse-e111446745a1825b862f8727ae63bce4"
           role="tabpanel" aria-labelledby="heading-e111446745a1825b862f8727ae63bce4">
        
        
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2023/02/16/NoSQL/Redis/redis01/" title="(1).Redis简介及安装"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(1).Redis简介及安装</span>
        </a>
      
    
      
      
        <a href="/2023/02/16/NoSQL/Redis/redis02/" title="(2).Redis配置详解"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(2).Redis配置详解</span>
        </a>
      
    
      
      
        <a href="/2023/02/16/NoSQL/Redis/redis03/" title="(3).Redis持久化"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(3).Redis持久化</span>
        </a>
      
    
      
      
        <a href="/2023/02/18/NoSQL/Redis/redis04/" title="(4).Redis主从复制"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(4).Redis主从复制</span>
        </a>
      
    
      
      
        <a href="/2023/02/18/NoSQL/Redis/redis05/" title="(5).Redis哨兵机制"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(5).Redis哨兵机制</span>
        </a>
      
    
      
      
        <a href="/2023/02/19/NoSQL/Redis/redis06/" title="(6).Redis之Cluster集群"
           class="list-group-item list-group-item-action
           active">
          <span class="category-post">(6).Redis之Cluster集群</span>
        </a>
      
    
  </div>

        
      </div>
    </div>
  
</div>


  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      Copyright © 2023 by 陈怀森
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=20005950"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>赣ICP备20005950号-1</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>



<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/default.ico">
  <link rel="icon" href="/img/default.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="陈怀森">
  <meta name="keywords" content="">
  
    <meta name="description" content="1.HAProxy高级功能及配置1.1 基于cookie的会话保持Cookie Value：为当前Server指定Cookie值，实现基于Cookie的会话黏性。 官方文档：https:&#x2F;&#x2F;cbonte.github.io&#x2F;haproxy-dconv&#x2F;2.4&#x2F;snapshot&#x2F;configuration.html#4-cookie #配置选项 cookie &lt;name&gt; [ rewrite">
<meta property="og:type" content="article">
<meta property="og:title" content="(4).HAProxy高级功能及配置">
<meta property="og:url" content="https://chsblogs.com/2023/02/14/LB/HAProxy/haproxy04/index.html">
<meta property="og:site_name" content="陈怀森の运维笔记">
<meta property="og:description" content="1.HAProxy高级功能及配置1.1 基于cookie的会话保持Cookie Value：为当前Server指定Cookie值，实现基于Cookie的会话黏性。 官方文档：https:&#x2F;&#x2F;cbonte.github.io&#x2F;haproxy-dconv&#x2F;2.4&#x2F;snapshot&#x2F;configuration.html#4-cookie #配置选项 cookie &lt;name&gt; [ rewrite">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-02-14T05:44:46.000Z">
<meta property="article:modified_time" content="2023-03-15T03:20:19.997Z">
<meta property="article:author" content="陈怀森">
<meta property="article:tag" content="HAProxy">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>(4).HAProxy高级功能及配置 - 陈怀森の运维笔记</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"chsblogs.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"SHELL"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":6},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>陈怀森 の 运维笔记</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="(4).HAProxy高级功能及配置"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-02-14 13:44" pubdate>
          2023年2月14日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          14k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          10 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">(4).HAProxy高级功能及配置</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="1-HAProxy高级功能及配置"><a href="#1-HAProxy高级功能及配置" class="headerlink" title="1.HAProxy高级功能及配置"></a>1.HAProxy高级功能及配置</h1><h2 id="1-1-基于cookie的会话保持"><a href="#1-1-基于cookie的会话保持" class="headerlink" title="1.1 基于cookie的会话保持"></a>1.1 基于cookie的会话保持</h2><p>Cookie Value：为当前Server指定Cookie值，实现基于Cookie的会话黏性。</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4-cookie">https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4-cookie</a></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#配置选项</span>
cookie <span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">[</span> rewrite <span class="token operator">|</span> insert <span class="token operator">|</span> prefix <span class="token punctuation">]</span> <span class="token punctuation">[</span> indirect <span class="token punctuation">]</span> <span class="token punctuation">[</span> nocache <span class="token punctuation">]</span>
              <span class="token punctuation">[</span> postonly <span class="token punctuation">]</span> <span class="token punctuation">[</span> preserve <span class="token punctuation">]</span> <span class="token punctuation">[</span> httponly <span class="token punctuation">]</span> <span class="token punctuation">[</span> secure <span class="token punctuation">]</span>
              <span class="token punctuation">[</span> domain <span class="token operator">&lt;</span>domain<span class="token operator">></span> <span class="token punctuation">]</span>* <span class="token punctuation">[</span> maxidle <span class="token operator">&lt;</span>idle<span class="token operator">></span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> maxlife <span class="token operator">&lt;</span>life<span class="token operator">></span> <span class="token punctuation">]</span>
              <span class="token punctuation">[</span> dynamic <span class="token punctuation">]</span> <span class="token punctuation">[</span> attr <span class="token operator">&lt;</span>value<span class="token operator">></span> <span class="token punctuation">]</span>*

<span class="token operator">&lt;</span>name<span class="token operator">></span>     <span class="token comment">#Cookie的Key名称，用于实现持久连接。</span>
insert     <span class="token comment">#插入新的Cookie，默认不插入Cookie</span>
indirect   <span class="token comment">#如果客户端已经有Cookie,则不会再发送Cookie信息</span>
nocache    <span class="token comment">#当Client和HAProxy之间有缓存服务器（如：CDN）时，不允许中间缓存器缓存cookie，因为这会导致很多经过同一个CDN的请求都发送到同一台后端服务器</span>

<span class="token comment">#配置示例</span>
listen web_port
  <span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.1.11:80
  balance roundrobin
  mode http
  log global
  cookie WEBSRV insert nocache indirect
  server web1 <span class="token number">192.168</span>.1.13:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span> cookie web1
  server web2 <span class="token number">192.168</span>.1.14:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span> cookie web2</code></pre></div></figure>

<p><strong>注意：不支持TCP Mode，使用HTTP Mode</strong></p>
<h2 id="1-2-HAProxy状态页"><a href="#1-2-HAProxy状态页" class="headerlink" title="1.2 HAProxy状态页"></a>1.2 HAProxy状态页</h2><p>通过Web页面，显示当前HAProxy状态</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4-stats">https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4-stats</a></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#配置选项</span>
stats <span class="token builtin class-name">enable</span>                       <span class="token comment">#基于默认的参数启用stats page</span>
stats hide-version                 <span class="token comment">#将状态页中haproxy版本隐藏</span>
stats refresh <span class="token operator">&lt;</span>delay<span class="token operator">></span>              <span class="token comment">#设定自动刷新时间间隔，默认不自动刷新,以秒为单位</span>
stats uri <span class="token operator">&lt;</span>prefix<span class="token operator">></span>                 <span class="token comment">#自定义stats page uri，默认值：/haproxy?stats</span>
stats realm <span class="token operator">&lt;</span>realm<span class="token operator">></span>                <span class="token comment">#账户认证时的提示信息，示例：stats realm HAProxy\</span>
stats auth <span class="token operator">&lt;</span>user<span class="token operator">></span>:<span class="token operator">&lt;</span>passwd<span class="token operator">></span>         <span class="token comment">#认证时的账号和密码，可定义多个用户,每行指定一个用户.默认：no</span>
stats admin <span class="token punctuation">&#123;</span> <span class="token keyword">if</span> <span class="token operator">|</span> unless <span class="token punctuation">&#125;</span> <span class="token operator">&lt;</span>cond<span class="token operator">></span> <span class="token comment">#启用stats page中的管理功能</span>

<span class="token comment">#启用状态页</span>
listen stats
  mode http
  <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:8888
  stats <span class="token builtin class-name">enable</span>
  log global
  stats uri /haproxy-status
  stats auth admin:123456
  
<span class="token comment">#登录状态页</span>
<span class="token comment">#pid为当前pid号，process为当前进程号，nbproc和nbthread为一共多少进程和每个进程多少个线程</span>
pid <span class="token operator">=</span> <span class="token number">25462</span> <span class="token punctuation">(</span>process <span class="token comment">#1, nbproc = 1, nbthread = 4)</span>
<span class="token comment">#启动了多长时间</span>
<span class="token function">uptime</span> <span class="token operator">=</span> 0d 0h02m59s
<span class="token comment">#系统资源限制：内存/最大打开文件数</span>
system limits: memmax <span class="token operator">=</span> unlimited<span class="token punctuation">;</span> ulimit-n <span class="token operator">=</span> <span class="token number">200058</span>
<span class="token comment">#最大socket连接数/单进程最大连接数/最大管道数maxpipes</span>
maxsock <span class="token operator">=</span> <span class="token number">200058</span><span class="token punctuation">;</span> maxconn <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span> maxpipes <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">#当前连接数/当前管道数/当前连接速率</span>
current conns <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> current pipes <span class="token operator">=</span> <span class="token number">0</span>/0<span class="token punctuation">;</span> conn rate <span class="token operator">=</span> <span class="token number">1</span>/sec<span class="token punctuation">;</span> bit rate <span class="token operator">=</span> <span class="token number">0.000</span> kbps
<span class="token comment">#运行的任务/当前空闲率</span>
Running tasks: <span class="token number">1</span>/18<span class="token punctuation">;</span> idle <span class="token operator">=</span> <span class="token number">100</span> %
<span class="token comment">#在线服务器</span>
active UP
<span class="token comment">#标记为backup的服务器</span>
backup UP
<span class="token comment">#监测未通过正在进入down过程</span>
active UP, going down
<span class="token comment">#备份服务器正在进入down过程</span>
backup UP, going down
<span class="token comment">#down的服务器正在进入up过程</span>
active DOWN, going up	
<span class="token comment">#备份服务器正在进入up过程</span>
backup DOWN, going up
<span class="token comment">#在线的服务器或者是backup的服务器已经转换成了down状态</span>
active or backup DOWN
<span class="token comment">#标记为不监测的服务器</span>
not checked
<span class="token comment">#active或者backup服务器人为下线的</span>
active or backup DOWN <span class="token keyword">for</span> maintenance <span class="token punctuation">(</span>MAINT<span class="token punctuation">)</span>
<span class="token comment">#active或者backup被人为软下线(人为将weight改成0)</span>
active or backup SOFT STOPPED <span class="token keyword">for</span> maintenance</code></pre></div></figure>

<p><strong>Backend Server信息</strong></p>
<table>
<thead>
<tr>
<th>session rate(每秒的连接会话信息)：</th>
<th>Errors(错误统计信息)：</th>
</tr>
</thead>
<tbody><tr>
<td>cur:每秒的当前会话数量</td>
<td>Req:错误请求量</td>
</tr>
<tr>
<td>max:每秒新的最大会话数量</td>
<td>conn:错误链接量</td>
</tr>
<tr>
<td>limit:每秒新的会话限制量</td>
<td>Resp:错误响应量</td>
</tr>
<tr>
<td>sessions(会话信息)：</td>
<td>Warnings(警告统计信息)：</td>
</tr>
<tr>
<td>cur:当前会话量</td>
<td>Retr:重新尝试次数</td>
</tr>
<tr>
<td>max:最大会话量</td>
<td>Redis:再次发送次数</td>
</tr>
<tr>
<td>limit: 限制会话量</td>
<td></td>
</tr>
<tr>
<td>Total:总共会话量</td>
<td>Server(real server信息)：</td>
</tr>
<tr>
<td>LBTot:选中一台服务器所用的总时间</td>
<td>Status:后端机的状态，包括UP和DOWN</td>
</tr>
<tr>
<td>Last：和服务器的持续连接时间</td>
<td>LastChk:持续检查后端服务器的时间</td>
</tr>
<tr>
<td>Wght:权重</td>
<td></td>
</tr>
<tr>
<td>Bytes(流量统计)：</td>
<td>Act:活动链接数量</td>
</tr>
<tr>
<td>In:网络的字节输入总量</td>
<td>Bck:备份的服务器数量</td>
</tr>
<tr>
<td>Out:网络的字节输出总量</td>
<td>Chk:心跳检测时间</td>
</tr>
<tr>
<td>Dwn:后端服务器连接后都是DOWN的数量</td>
<td></td>
</tr>
<tr>
<td>Denied(拒绝统计信息)：</td>
<td>Dwntme:总的downtime时间</td>
</tr>
<tr>
<td>Req:拒绝请求量</td>
<td>Thrtle:server 状态</td>
</tr>
<tr>
<td>Resp:拒绝回复量</td>
<td></td>
</tr>
</tbody></table>
<p>利用状态页实现HAProxy服务器的健康性检查：</p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@node11 ~<span class="token punctuation">]</span><span class="token comment"># curl -I http://admin:123456@192.168.1.11:8888/haproxy-status</span>
HTTP/1.1 <span class="token number">200</span> OK
cache-control: no-cache
content-type: text/html</code></pre></div></figure>

<h2 id="1-3-IP地址透传"><a href="#1-3-IP地址透传" class="headerlink" title="1.3 IP地址透传"></a>1.3 IP地址透传</h2><p>Web服务器中需要记录客户端的真实IP地址，用于做访问统计、安全防护、行为分析、区域排行等场景。</p>
<p><strong>四层负载：</strong>IP+PORT转发</p>
<p>​		在四层负载设备中，把client发送的报文目标地址(原来是负载均衡设备的IP地址)，根据均衡设备设置的选择web服务器的规则选择对应的web服务器IP地址，这样client就可以直接跟此服务器建立TCP连接并发送数据，而四层负载自身不参与建立连接，而和LVS不同，haproxy是伪四层负载均衡，因为haproxy需要分别和前端客户端及后端服务器建立连接。</p>
<p><strong>七层负载：</strong>协议+内容交换</p>
<p>​		七层负载均衡服务器起了一个反向代理服务器的作用，服务器建立一次TCP连接要三次握手，而client要访问Web Server要先与七层负载设备进行三次握手后建立TCP连接，把要访问的报文信息发送给七层负载均衡；然后七层负载均衡再根据设置的均衡规则选择特定的 Web Server，然后通过三次握手与此台Web Server建立TCP连接，然后Web Server把需要的数据发送给七层负载均衡设备，负载均衡设备再把数据发送给client；所以，七层负载均衡设备起到了代理服务器的作用，七层代理需要和Client和后端服务器分别建立连接。</p>
<h3 id="1-3-1-四层IP地址透传"><a href="#1-3-1-四层IP地址透传" class="headerlink" title="1.3.1 四层IP地址透传"></a>1.3.1 四层IP地址透传</h3><figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#haproxy配置</span>
listen web_http
  <span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.1.11:80
  balance roundrobin
  mode tcp <span class="token comment">#不支持http协议</span>
  log global
  server web1 <span class="token number">192.168</span>.1.13:80 send-proxy check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span> <span class="token comment">#添加send-proxy</span>
  server web2 <span class="token number">192.168</span>.1.14:80 send-proxy check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span> <span class="token comment">#添加send-proxy</span>

<span class="token comment">#nginx配置</span>
http <span class="token punctuation">&#123;</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

    <span class="token comment">#变量$proxy_protocol_addr记录透传过来的客户端IP</span>
    log_format  main  <span class="token string">'$remote_addr - $remote_user [$time_local] "$request" "$proxy_protocol_addr"'</span>
                      <span class="token string">'$status $body_bytes_sent "$http_referer" '</span>
                      <span class="token string">'"$http_user_agent" "$http_x_forwarded_for"'</span><span class="token punctuation">;</span>
                      
                      
    server <span class="token punctuation">&#123;</span>
    	listen       <span class="token number">80</span> proxy_protocol<span class="token punctuation">;</span><span class="token comment">#启用此项，将无法直接访问此网站，只能通过四层代理访问。</span>
    	server_name  localhost<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token punctuation">&#125;</span></code></pre></div></figure>

<h3 id="1-3-2-七层IP地址透传"><a href="#1-3-2-七层IP地址透传" class="headerlink" title="1.3.2 七层IP地址透传"></a>1.3.2 七层IP地址透传</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4-option%20forwardfor">https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4-option%20forwardfor</a></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#配置选项</span>
option forwardfor <span class="token punctuation">[</span> except <span class="token operator">&lt;</span>network<span class="token operator">></span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> header <span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> header <span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">]</span>
except <span class="token operator">&lt;</span>network<span class="token operator">></span>  <span class="token comment">#请求报请来自此处指定的网络时不予添加此首部，如haproxy自身所在网络</span>
header <span class="token operator">&lt;</span>name<span class="token operator">></span>     <span class="token comment">#使用自定义的首部名称，而非“X-Forwarded-For"，示例：X-client</span>
header <span class="token operator">&lt;</span>name<span class="token operator">></span>     <span class="token comment">#如果没有首部才添加首部，如果有使用默认值</span>


<span class="token comment">#配置示例</span>
<span class="token comment">#haproxy 配置</span>
defaults
  <span class="token comment">#此为默认值,首部字段默认为：X-Forwarded-For</span>
  option forwardfor
  <span class="token comment">#或者自定义首部,如:X-client</span>
  option forwardfor except <span class="token number">127.0</span>.0.0/8 header X-client

<span class="token comment">#listen配置</span>
listen web_host
  <span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.1.11:80
  mode http
  log global
  balance random
  server web1 <span class="token number">192.168</span>.1.13:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
  server web2 <span class="token number">192.168</span>.1.14:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
  
<span class="token comment">#Web服务器日志格式配置</span>
<span class="token comment">#apache 配置：</span>
LogFormat <span class="token string">"%&#123;X-Forwarded-For&#125;i %a %l %u %t <span class="token entity" title="\&quot;">\"</span>%r<span class="token entity" title="\&quot;">\"</span> %>s %b <span class="token entity" title="\&quot;">\"</span>%&#123;Referer&#125;i<span class="token entity" title="\&quot;">\"</span> <span class="token entity" title="\&quot;">\"</span>%
&#123;User-Agent&#125;i<span class="token entity" title="\&quot;">\"</span>"</span> combined

<span class="token comment">#nginx配置</span>
http <span class="token punctuation">&#123;</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

    <span class="token comment">#$proxy_add_x_forwarded_for：包括客户端IP和中间经过的所有代理的IP</span>
    <span class="token comment">#$http_x_forwarded_For：只有客户端IP</span>
    log_format  main  <span class="token string">'$remote_addr - $remote_user [$time_local] "$request" "$proxy_protocol_addr"'</span>
                      <span class="token string">'$status $body_bytes_sent "$http_referer" '</span>
                      <span class="token string">'"$http_user_agent" "$http_x_forwarded_for"'</span><span class="token punctuation">;</span>
                      
                      
    server <span class="token punctuation">&#123;</span>
    	listen       <span class="token number">80</span><span class="token punctuation">;</span>
    	server_name  localhost<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token punctuation">&#125;</span></code></pre></div></figure>

<h2 id="1-4-报文修改"><a href="#1-4-报文修改" class="headerlink" title="1.4 报文修改"></a>1.4 报文修改</h2><h3 id="1-4-1-HAProxy2-1版本前"><a href="#1-4-1-HAProxy2-1版本前" class="headerlink" title="1.4.1 HAProxy2.1版本前"></a>1.4.1 HAProxy2.1版本前</h3><p>2.1版本以下通过rspadd与rspidel在响应报文中添加与删除字段。</p>
<p>官方文档：</p>
<p><a target="_blank" rel="noopener" href="https://cbonte.github.io/haproxy-dconv/2.0/snapshot/configuration.html#4-reqadd">https://cbonte.github.io/haproxy-dconv/2.0/snapshot/configuration.html#4-reqadd</a></p>
<p><a target="_blank" rel="noopener" href="https://cbonte.github.io/haproxy-dconv/2.0/snapshot/configuration.html#4-reqdel">https://cbonte.github.io/haproxy-dconv/2.0/snapshot/configuration.html#4-reqdel</a></p>
<h3 id="1-4-2-HAProxy2-1版本后"><a href="#1-4-2-HAProxy2-1版本后" class="headerlink" title="1.4.2 HAProxy2.1版本后"></a>1.4.2 HAProxy2.1版本后</h3><p>2.1版本以上用下面指令http-request和http-response代替</p>
<p>官方文档：</p>
<p><a target="_blank" rel="noopener" href="https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4-http-request">https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4-http-request</a></p>
<p><a target="_blank" rel="noopener" href="https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4-http-response">https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4-http-response</a></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#配置选项</span>
http-response add-header <span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token operator">&lt;</span>fmt<span class="token operator">></span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token keyword">if</span> <span class="token operator">|</span> unless <span class="token punctuation">&#125;</span> <span class="token operator">&lt;</span>condition<span class="token operator">></span> <span class="token punctuation">]</span>
http-response del-header <span class="token operator">&lt;</span>name<span class="token operator">></span> <span class="token punctuation">[</span> <span class="token parameter variable">-m</span> <span class="token operator">&lt;</span>meth<span class="token operator">></span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">&#123;</span> <span class="token keyword">if</span> <span class="token operator">|</span> unless <span class="token punctuation">&#125;</span> <span class="token operator">&lt;</span>condition<span class="token operator">></span> <span class="token punctuation">]</span>

<span class="token comment">#配置示例</span>
listen web_host
  <span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.1.11:80
  balance roundrobin
  mode http
  log global
  option httplog
  http-request add-header X-Haproxy-Current-Date %T <span class="token comment">#添加首部</span>
  http-response del-header server                   <span class="token comment">#删除首部</span>
  server web1 <span class="token number">192.168</span>.1.13:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
  server web2 <span class="token number">192.168</span>.1.14:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span></code></pre></div></figure>

<h2 id="1-5-自定义日志格式"><a href="#1-5-自定义日志格式" class="headerlink" title="1.5  自定义日志格式"></a>1.5  自定义日志格式</h2><figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#官方文档：https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4.2-log%20global</span>
log global                                  <span class="token comment">#开启记录日志，默认不开启</span>
<span class="token comment">#官方文档：https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4.2-option%20httplog</span>
option httplog                              <span class="token comment">#开启记录httplog日志格式选项</span>
<span class="token comment">#官方文档：https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4.2-capture%20cookie</span>
capture cookie <span class="token operator">&lt;</span>name<span class="token operator">></span> len <span class="token operator">&lt;</span>length<span class="token operator">></span>          <span class="token comment">#捕获请求和响应报文中的 cookie及值的长度,将之记录到日志</span>
<span class="token comment">#官方文档：https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4-capture%20request%20header</span>
capture request header <span class="token operator">&lt;</span>name<span class="token operator">></span> len <span class="token operator">&lt;</span>length<span class="token operator">></span>  <span class="token comment">#捕获请求报文中指定的首部内容和长度并记录日志</span>
<span class="token comment">#官方文档：https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4-capture%20response%20header</span>
capture response header <span class="token operator">&lt;</span>name<span class="token operator">></span> len <span class="token operator">&lt;</span>length<span class="token operator">></span> <span class="token comment">#捕获响应报文中指定的内容和长度首部并记录日志</span>

<span class="token comment">#配置示例：</span>
log global
option httplog
capture request header Host len <span class="token number">256</span>
capture request header User-Agent len <span class="token number">512</span>
capture request header Referer len <span class="token number">15</span>
capture request header X-Forwarded-For len <span class="token number">15</span></code></pre></div></figure>

<p><strong>HAProxy配置自定义日志格式：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@node11 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/haproxy/haproxy.cfg</span>
listen web_host
  <span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.1.11:80
  balance roundrobin
  mode http
  log global
  option httplog
  capture request header User-Agent len <span class="token number">512</span>
  capture request header Host len <span class="token number">256</span>
  server web1 <span class="token number">192.168</span>.1.13:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
  server web2 <span class="token number">192.168</span>.1.14:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>

<span class="token comment">#验证日志</span>
<span class="token punctuation">[</span>root@node11 ~<span class="token punctuation">]</span><span class="token comment"># tail -f /var/log/haproxy.log </span>
Feb <span class="token number">15</span> <span class="token number">23</span>:37:06 localhost haproxy<span class="token punctuation">[</span><span class="token number">9677</span><span class="token punctuation">]</span>: <span class="token number">192.168</span>.1.200:60614 <span class="token punctuation">[</span><span class="token number">15</span>/Feb/2023:23:37:06.269<span class="token punctuation">]</span> web_host web_host/web1 <span class="token number">0</span>/0/1/0/1 <span class="token number">200</span> <span class="token number">211</span> - - ---- <span class="token number">3</span>/1/0/0/0 <span class="token number">0</span>/0 <span class="token punctuation">&#123;</span>Mozilla/5.0 <span class="token punctuation">(</span>Windows NT <span class="token number">10.0</span><span class="token punctuation">;</span> Win64<span class="token punctuation">;</span> x64<span class="token punctuation">)</span> AppleWebKit/537.36 <span class="token punctuation">(</span>KHTML, like Gecko<span class="token punctuation">)</span> Chrome/110.0.0.0 Safari/537.36<span class="token operator">|</span><span class="token number">192.168</span>.1.11<span class="token punctuation">&#125;</span> <span class="token string">"GET / HTTP/1.1"</span>
Feb <span class="token number">15</span> <span class="token number">23</span>:37:34 localhost haproxy<span class="token punctuation">[</span><span class="token number">9677</span><span class="token punctuation">]</span>: <span class="token number">192.168</span>.1.200:60614 <span class="token punctuation">[</span><span class="token number">15</span>/Feb/2023:23:37:34.155<span class="token punctuation">]</span> web_host web_host/web1 <span class="token number">0</span>/0/0/2/2 <span class="token number">304</span> <span class="token number">153</span> - - ---- <span class="token number">3</span>/2/0/0/0 <span class="token number">0</span>/0 <span class="token punctuation">&#123;</span>Mozilla/5.0 <span class="token punctuation">(</span>Windows NT <span class="token number">10.0</span><span class="token punctuation">;</span> Win64<span class="token punctuation">;</span> x64<span class="token punctuation">)</span> AppleWebKit/537.36 <span class="token punctuation">(</span>KHTML, like Gecko<span class="token punctuation">)</span> Chrome/110.0.0.0 Safari/537.36<span class="token operator">|</span><span class="token number">192.168</span>.1.11<span class="token punctuation">&#125;</span> <span class="token string">"GET / HTTP/1.1"</span></code></pre></div></figure>

<h2 id="1-6-压缩功能"><a href="#1-6-压缩功能" class="headerlink" title="1.6 压缩功能"></a>1.6 压缩功能</h2><p>对响应给客户端的报文进行压缩</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4.2-compression%20algo">https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4.2-compression%20algo</a></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#配置选项</span>
compression algo <span class="token operator">&lt;</span>algorithm<span class="token operator">></span> <span class="token punctuation">..</span>.

<span class="token operator">&lt;</span>algorithm<span class="token operator">></span>   <span class="token comment">#压缩算法&lt;algorithm>支持下面类型：</span>
  identity    <span class="token comment">#debug调试使用的压缩方式。</span>
  <span class="token function">gzip</span>        <span class="token comment">#常用的压缩方式，与各浏览器兼容较好。</span>
  deflate     <span class="token comment">#有些浏览器不支持。</span>
  raw-deflate <span class="token comment">#新式的压缩方式。</span>
  
compression   <span class="token comment">#要压缩的文件类型</span>

<span class="token comment">#配置示例</span>
compression algo <span class="token function">gzip</span>
compression <span class="token builtin class-name">type</span> text/html text/plain

<span class="token comment">#haproxy配置压缩</span>
listen web_http
  <span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.1.11:80
  balance roundrobin
  mode http
  log global
  option httplog
  compression algo <span class="token function">gzip</span>
  compression <span class="token builtin class-name">type</span> text/html text/plain
  server web1 <span class="token number">192.168</span>.1.13:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
  server web2 <span class="token number">192.168</span>.1.14:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
  
<span class="token comment">#后端服务器准备文本文件</span>
<span class="token punctuation">[</span>root@node13 ~<span class="token punctuation">]</span><span class="token comment"># ll -h /usr/share/nginx/html/test.txt </span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">94</span> Feb <span class="token number">15</span> <span class="token number">20</span>:52 /usr/share/nginx/html/test.txt
<span class="token punctuation">[</span>root@node14 ~<span class="token punctuation">]</span><span class="token comment"># ll -h /usr/share/nginx/html/test.txt</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">94</span> Feb <span class="token number">15</span> <span class="token number">20</span>:52 /usr/share/nginx/html/test.txt

<span class="token comment">#验证压缩功能</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># curl -is --compressed 192.168.1.11/test.txt | grep "content-encoding"</span>
content-encoding: <span class="token function">gzip</span></code></pre></div></figure>

<h2 id="1-7-Web服务器状态监测"><a href="#1-7-Web服务器状态监测" class="headerlink" title="1.7 Web服务器状态监测"></a>1.7 Web服务器状态监测</h2><p>官方文档：<a target="_blank" rel="noopener" href="https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4-option%20httpchk">https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4-option%20httpchk</a></p>
<p><strong>三种状态监测方式：</strong></p>
<ul>
<li>基于四层的传输端口做状态监测，此为默认方式。</li>
<li>基于指定 URI 做状态监测,需要访问整个页面资源,占用更多带宽。</li>
<li>基于指定 URI 的request请求头部内容做状态监测，占用较少带宽,建议使用此方式。</li>
</ul>
<p><strong>基于应用层http协议进行健康性检测：</strong></p>
<p>​		基于应用层http协议，采有不同的监测方式，对后端real server进行状态监测，此方式会导致在后端服务器生成很多的HAProxy发起的访问日志。</p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#配置选项</span>
option httpchk                           <span class="token comment">#启用七层健康性检测，对TCP和HTTP模式都支持，默认为：OPTIONS HTTP/1.0</span>
option httpchk <span class="token operator">&lt;</span>uri<span class="token operator">></span>                     
option httpchk <span class="token operator">&lt;</span>method<span class="token operator">></span> <span class="token operator">&lt;</span>uri<span class="token operator">></span>            
option httpchk <span class="token operator">&lt;</span>method<span class="token operator">></span> <span class="token operator">&lt;</span>uri<span class="token operator">></span> <span class="token operator">&lt;</span>version<span class="token operator">></span>

<span class="token comment">#http-check expect官方文档：https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4.2-http-check%20expect</span>
<span class="token comment">#期望以上检查得到的响应码</span>
http-check <span class="token function">expect</span> <span class="token punctuation">[</span>min-recv <span class="token operator">&lt;</span>int<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">[</span>comment <span class="token operator">&lt;</span>msg<span class="token operator">></span><span class="token punctuation">]</span>
                  <span class="token punctuation">[</span>ok-status <span class="token operator">&lt;</span>st<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">[</span>error-status <span class="token operator">&lt;</span>st<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">[</span>tout-status <span class="token operator">&lt;</span>st<span class="token operator">></span><span class="token punctuation">]</span>
                  <span class="token punctuation">[</span>on-success <span class="token operator">&lt;</span>fmt<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">[</span>on-error <span class="token operator">&lt;</span>fmt<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">[</span>status-code <span class="token operator">&lt;</span>expr<span class="token operator">></span><span class="token punctuation">]</span>
                  <span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>match<span class="token operator">></span> <span class="token operator">&lt;</span>pattern<span class="token operator">></span>
                  
<span class="token comment">#http-check expect示例</span>
http-check <span class="token function">expect</span> status <span class="token number">200,201</span>,300-310
http-check <span class="token function">expect</span> header name <span class="token string">"set-cookie"</span> value <span class="token parameter variable">-m</span> beg <span class="token string">"sessid="</span>
http-check <span class="token function">expect</span> <span class="token operator">!</span> string SQL<span class="token punctuation">\</span> Error
http-check <span class="token function">expect</span> <span class="token operator">!</span> rstatus ^5
http-check <span class="token function">expect</span> rstring <span class="token operator">&lt;</span><span class="token operator">!</span>--tag:<span class="token punctuation">[</span><span class="token number">0</span>-9a-f<span class="token punctuation">]</span>*--<span class="token operator">></span><span class="token operator">&lt;</span>/html<span class="token operator">></span></code></pre></div></figure>

<p><strong>HAProxy配置Web服务器状态监测：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@node11 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/haproxy/haproxy.cfg</span>
listen web_check
  <span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.1.11:80
  balance roundrobin
  <span class="token comment">#option httpchk GET /monitor/check.html #默认HTTP/1.0</span>
  <span class="token comment">#option httpchk GET /monitor/check.html HTTP/1.0</span>
  <span class="token comment">#option httpchk GET /monitor/check.html HTTP/1.1 #注意：HTTP/1.1强制要求必须有Host字段</span>
  option httpchk HEAD /monitor/check.html HTTP/1.1<span class="token punctuation">\</span>r<span class="token punctuation">\</span>nHost:<span class="token punctuation">\</span> <span class="token number">192.168</span>.1.11 <span class="token comment">#使用HEAD减少网络流量</span>
  mode http
  log global
  option httplog
  compression algo <span class="token function">gzip</span>
  compression <span class="token builtin class-name">type</span> text/html text/plain
  server web1 <span class="token number">192.168</span>.1.13:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
  server web2 <span class="token number">192.168</span>.1.14:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
  
<span class="token comment">#在所有后端服务建立检测页面</span>
<span class="token punctuation">[</span>root@node13 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /usr/share/nginx/html/monitor</span>
<span class="token punctuation">[</span>root@node13 ~<span class="token punctuation">]</span><span class="token comment"># echo "monitor" > /usr/share/nginx/html/monitor/check.html</span></code></pre></div></figure>

<h2 id="1-8-自定义HAProxy错误页面"><a href="#1-8-自定义HAProxy错误页面" class="headerlink" title="1.8 自定义HAProxy错误页面"></a>1.8 自定义HAProxy错误页面</h2><p>对指定的报错进行重定向。</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4.2-errorfile">https://cbonte.github.io/haproxy-dconv/2.4/snapshot/configuration.html#4.2-errorfile</a></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">errorfile <span class="token operator">&lt;</span>code<span class="token operator">></span> <span class="token operator">&lt;</span>file<span class="token operator">></span>
  <span class="token operator">&lt;</span>code<span class="token operator">></span> <span class="token comment">#HTTP status code.支持200, 400, 403, 405, 408, 425, 429, 500, 502，503,504</span>
  <span class="token operator">&lt;</span>file<span class="token operator">></span> <span class="token comment">#包含完整HTTP响应头的错误页文件的绝对路径。 建议后缀".http"，以和一般的html文件相区分。</span>
  
<span class="token comment">#配置示例</span>
errorfile <span class="token number">400</span> /etc/haproxy/errorfiles/400badreq.http
errorfile <span class="token number">408</span> /dev/null  <span class="token comment"># work around Chrome pre-connect bug</span>
errorfile <span class="token number">403</span> /etc/haproxy/errorfiles/403forbid.http
errorfile <span class="token number">503</span> /etc/haproxy/errorfiles/503sorry.http

<span class="token comment">#haproxy配置错误页面</span>
<span class="token punctuation">[</span>root@node11 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/haproxy/haproxy.cfg</span>
defaults
  option http-keep-alive
  option forwardfor
  maxconn <span class="token number">100000</span>
  mode http
  <span class="token function">timeout</span> connect 300000ms
  <span class="token function">timeout</span> client 300000ms
  <span class="token function">timeout</span> server 300000ms
  errorfile <span class="token number">500</span> /etc/haproxy/html/500.http
  errorfile <span class="token number">502</span> /etc/haproxy/html/502.http
  errorfile <span class="token number">503</span> /etc/haproxy/html/503.http

<span class="token comment">#创建错误页面</span>
<span class="token punctuation">[</span>root@node11 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/haproxy/html/503.http</span>
HTTP/1.1 <span class="token number">503</span> Service Unavailable
Content-Type:text/html<span class="token punctuation">;</span><span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8


<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">></span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">></span>
<span class="token operator">&lt;</span>head<span class="token operator">></span>
<span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">></span>
<span class="token operator">&lt;</span>title<span class="token operator">></span>报错页面<span class="token operator">&lt;</span>/title<span class="token operator">></span>
<span class="token operator">&lt;</span>/head<span class="token operator">></span>
<span class="token operator">&lt;</span>body<span class="token operator">></span>
<span class="token operator">&lt;</span>center<span class="token operator">></span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span>网站维护中<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>请稍候再试<span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token operator">&lt;</span>/center<span class="token operator">></span>
<span class="token operator">&lt;</span>center<span class="token operator">></span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">2</span>></span>联系电话：400-666-888<span class="token operator"><span class="token file-descriptor important">8</span>&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token operator">&lt;</span>/center<span class="token operator">></span>
<span class="token operator">&lt;</span>center<span class="token operator">></span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">3</span>></span><span class="token number">503</span> Service Unavailable<span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">3</span>></span><span class="token operator">&lt;</span>/center<span class="token operator">></span>
<span class="token operator">&lt;</span>/body<span class="token operator">></span>

<span class="token punctuation">[</span>root@node11 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart haproxy</span>

<span class="token comment">#测试</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># curl 192.168.1.11</span>

<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">></span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">></span>
<span class="token operator">&lt;</span>head<span class="token operator">></span>
<span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">></span>
<span class="token operator">&lt;</span>title<span class="token operator">></span>报错页面<span class="token operator">&lt;</span>/title<span class="token operator">></span>
<span class="token operator">&lt;</span>/head<span class="token operator">></span>
<span class="token operator">&lt;</span>body<span class="token operator">></span>
<span class="token operator">&lt;</span>center<span class="token operator">></span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span>网站维护中<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>请稍候再试<span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token operator">&lt;</span>/center<span class="token operator">></span>
<span class="token operator">&lt;</span>center<span class="token operator">></span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">2</span>></span>联系电话：400-666-888<span class="token operator"><span class="token file-descriptor important">8</span>&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token operator">&lt;</span>/center<span class="token operator">></span>
<span class="token operator">&lt;</span>center<span class="token operator">></span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">3</span>></span><span class="token number">503</span> Service Unavailable<span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">3</span>></span><span class="token operator">&lt;</span>/center<span class="token operator">></span>
<span class="token operator">&lt;</span>/body<span class="token operator">></span></code></pre></div></figure>

<h2 id="1-9-HAProxy四层负载"><a href="#1-9-HAProxy四层负载" class="headerlink" title="1.9 HAProxy四层负载"></a>1.9 HAProxy四层负载</h2><p>针对除HTTP以外的TCP协议应用服务访问的应用场景：</p>
<ul>
<li>MySQL</li>
<li>Redis</li>
<li>RabbitMQ</li>
</ul>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#</span>
listen redis_port
  <span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.1.11:6379
  mode tcp
  balance leastconn
  server server1 <span class="token number">192.168</span>.1.13:6379 check
  server server2 <span class="token number">192.168</span>.1.14:6379 check backup
  
listen mysql_port
  <span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.1.11:3306
  mode tcp
  balance leastconn
  server server1 <span class="token number">192.168</span>.1.13:3306 check
  server server2 <span class="token number">192.168</span>.1.14:3306 check backup
  
<span class="token comment">#安装mysql和redis服务</span>
<span class="token punctuation">[</span>root@node13 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install mariadb-server redis</span>
<span class="token comment">#配置数据库远程连接</span>
<span class="token punctuation">[</span>root@node13 ~<span class="token punctuation">]</span><span class="token comment"># mysql -e "grant all on *.* to root@'%' identified by '123456'"</span>
<span class="token punctuation">[</span>root@node13 ~<span class="token punctuation">]</span><span class="token comment"># sed -i 's@bind 127.0.0.1@bind 0.0.0.0@' /etc/redis.conf</span>
<span class="token punctuation">[</span>root@node13 ~<span class="token punctuation">]</span><span class="token comment"># systemctl start redis</span>

<span class="token comment">#测试访问</span>
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># redis-cli -h 192.168.1.11</span>
<span class="token number">192.168</span>.1.11:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> 
<span class="token punctuation">[</span>root@node10 ~<span class="token punctuation">]</span><span class="token comment"># mysql -u root -p123456 -h 192.168.1.11</span>
Welcome to the MariaDB monitor.  Commands end with <span class="token punctuation">;</span> or <span class="token punctuation">\</span>g.
Your MariaDB connection <span class="token function">id</span> is <span class="token number">3</span>
Server version: <span class="token number">5.5</span>.68-MariaDB MariaDB Server

Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>, <span class="token number">2018</span>, Oracle, MariaDB Corporation Ab and others.

Type <span class="token string">'help;'</span> or <span class="token string">'\h'</span> <span class="token keyword">for</span> help. Type <span class="token string">'\c'</span> to <span class="token function">clear</span> the current input statement.

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span> </code></pre></div></figure>

<h2 id="1-10-HAProxy配置HTTPS"><a href="#1-10-HAProxy配置HTTPS" class="headerlink" title="1.10 HAProxy配置HTTPS"></a>1.10 HAProxy配置HTTPS</h2><p>​		HAProxy可以实现https的证书安全,从用户到HAProxy为HTTPS,从HAProxy到后端服务器用HTTP通信但基于性能考虑,生产中证书都是在后端服务器比如Nginx上实现。</p>
<p><strong>配置选项：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#配置HAProxy支持https协议，支持ssl会话；</span>
<span class="token builtin class-name">bind</span> *:443 ssl crt /<span class="token environment constant">PATH</span>/TO/SOME_PEM_FILE

<span class="token comment">#指令 crt 后证书文件为PEM格式，需要同时包含证书和所有私钥</span>
<span class="token function">cat</span> demo.key demo.crt <span class="token operator">></span> demo.pem

<span class="token comment">#把80端口的请求重向定443</span>
<span class="token builtin class-name">bind</span> *:80
redirect scheme https <span class="token keyword">if</span> <span class="token operator">!</span><span class="token punctuation">&#123;</span> ssl_fc <span class="token punctuation">&#125;</span>

<span class="token comment">#向后端传递用户请求的协议和端口（frontend或backend）</span>
http_request set-header X-Forwarded-Port %<span class="token punctuation">[</span>dst_port<span class="token punctuation">]</span>
http_request add-header X-Forwared-Proto https <span class="token keyword">if</span> <span class="token punctuation">&#123;</span> ssl_fc <span class="token punctuation">&#125;</span></code></pre></div></figure>

<p><strong>证书制作：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@node11 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /etc/haproxy/certs</span>
<span class="token punctuation">[</span>root@node11 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/haproxy/certs/</span>
<span class="token punctuation">[</span>root@node11 certs<span class="token punctuation">]</span><span class="token comment"># openssl genrsa -out haproxy.key 2048</span>
<span class="token punctuation">[</span>root@node11 certs<span class="token punctuation">]</span><span class="token comment"># openssl req -new -x509 -key haproxy.key -out haproxy.crt -subj "/CN=www.chsblogs.com"</span>
<span class="token punctuation">[</span>root@node11 certs<span class="token punctuation">]</span><span class="token comment"># cat haproxy.key haproxy.crt > haproxy.pem</span>
<span class="token comment">#查看证书</span>
<span class="token punctuation">[</span>root@node11 certs<span class="token punctuation">]</span><span class="token comment"># openssl x509 -in haproxy.pem -noout -text</span></code></pre></div></figure>

<p><strong>HAProxy配置HTTPS：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@node11 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/haproxy/haproxy.cfg </span>
listen web_https
  <span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.1.11:80
  <span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.1.11:443 ssl crt /etc/haproxy/certs/haproxy.pem
  redirect scheme https <span class="token keyword">if</span> <span class="token operator">!</span><span class="token punctuation">&#123;</span> ssl_fc <span class="token punctuation">&#125;</span>
  http-request set-header X-forwarded-Port %<span class="token punctuation">[</span>dst_port<span class="token punctuation">]</span>
  http-request add-header X-forwarded-Proto https <span class="token keyword">if</span> <span class="token punctuation">&#123;</span> ssl_fc <span class="token punctuation">&#125;</span>
  balance roundrobin
  mode http
  log global
  option httplog
  compression algo <span class="token function">gzip</span>
  compression <span class="token builtin class-name">type</span> text/html text/plain
  server web1 <span class="token number">192.168</span>.1.13:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span>
  server web2 <span class="token number">192.168</span>.1.14:80 check inter <span class="token number">3000</span> fall <span class="token number">2</span> rise <span class="token number">5</span></code></pre></div></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Linux/" class="category-chain-item">Linux</a>
  
  
    <span>></span>
    
  <a href="/categories/Linux/HAProxy/" class="category-chain-item">HAProxy</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/HAProxy/">#HAProxy</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>(4).HAProxy高级功能及配置</div>
      <div>https://chsblogs.com/2023/02/14/LB/HAProxy/haproxy04/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>陈怀森</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年2月14日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/02/15/LB/HAProxy/haproxy05/" title="(5).HAProxy之ACL配置">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">(5).HAProxy之ACL配置</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/02/12/LB/HAProxy/haproxy03/" title="(3).HAProxy调度算法">
                        <span class="hidden-mobile">(3).HAProxy调度算法</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    
      <script type="text/javascript">
        var disqus_config = function() {
          this.page.url = 'https://chsblogs.com/2023/02/14/LB/HAProxy/haproxy04/';
          this.page.identifier = '/2023/02/14/LB/HAProxy/haproxy04/';
        };
        Fluid.utils.loadComments('#disqus_thread', function() {
          var d = document, s = d.createElement('script');
          s.src = '//' + 'fluid' + '.disqus.com/embed.js';
          s.setAttribute('data-timestamp', new Date());
          (d.head || d.body).appendChild(s);
        });
      </script>
    
    <noscript>Please enable JavaScript to view the comments</noscript>
  </div>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar category-bar" style="margin-left: -1rem">
    





<div class="category-list">
  
  
    
    
    
    <div class="category row nomargin-x">
      <a class="category-item 
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="HAProxy"
        id="heading-6a812150273423f1f875479281529d1a" role="tab" data-toggle="collapse" href="#collapse-6a812150273423f1f875479281529d1a"
        aria-expanded="true"
      >
        HAProxy
        <span class="list-group-count">(5)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse show" id="collapse-6a812150273423f1f875479281529d1a"
           role="tabpanel" aria-labelledby="heading-6a812150273423f1f875479281529d1a">
        
        
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2023/02/09/LB/HAProxy/haproxy01/" title="(1).HAProxy简介及安装"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(1).HAProxy简介及安装</span>
        </a>
      
    
      
      
        <a href="/2023/02/10/LB/HAProxy/haproxy02/" title="(2).HAProxy基础配置详解"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(2).HAProxy基础配置详解</span>
        </a>
      
    
      
      
        <a href="/2023/02/12/LB/HAProxy/haproxy03/" title="(3).HAProxy调度算法"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(3).HAProxy调度算法</span>
        </a>
      
    
      
      
        <a href="/2023/02/14/LB/HAProxy/haproxy04/" title="(4).HAProxy高级功能及配置"
           class="list-group-item list-group-item-action
           active">
          <span class="category-post">(4).HAProxy高级功能及配置</span>
        </a>
      
    
      
      
        <a href="/2023/02/15/LB/HAProxy/haproxy05/" title="(5).HAProxy之ACL配置"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(5).HAProxy之ACL配置</span>
        </a>
      
    
  </div>

        
      </div>
    </div>
  
</div>


  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      Copyright © 2023 by 陈怀森
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=20005950"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>赣ICP备20005950号-1</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>

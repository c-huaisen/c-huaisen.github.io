

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/default.ico">
  <link rel="icon" href="/img/default.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="陈怀森">
  <meta name="keywords" content="">
  
    <meta name="description" content="1.K8S基于ZooKeeper集群实现微服务动态注册和发现  1.1 构建zookeeper镜像创建zoo.cfg配置文件： root@deploy:&#x2F;opt&#x2F;dockerfile&#x2F;project&#x2F;zookeeper# vim zoo.cfg tickTime&#x3D;2000 initLimit&#x3D;10 syncLimit&#x3D;5 dataDir&#x3D;&#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;data data">
<meta property="og:type" content="article">
<meta property="og:title" content="(09).K8S基于ZooKeeper集群实现微服务动态注册和发现">
<meta property="og:url" content="http://chsblogs.com/2023/05/05/Container/Kubernetes/kubernetes09/index.html">
<meta property="og:site_name" content="陈怀森の运维笔记">
<meta property="og:description" content="1.K8S基于ZooKeeper集群实现微服务动态注册和发现  1.1 构建zookeeper镜像创建zoo.cfg配置文件： root@deploy:&#x2F;opt&#x2F;dockerfile&#x2F;project&#x2F;zookeeper# vim zoo.cfg tickTime&#x3D;2000 initLimit&#x3D;10 syncLimit&#x3D;5 dataDir&#x3D;&#x2F;usr&#x2F;local&#x2F;zookeeper&#x2F;data data">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://chsblogs.com/2023/05/05/Container/Kubernetes/kubernetes09/image-20230511193018816.png">
<meta property="og:image" content="http://chsblogs.com/2023/05/05/Container/Kubernetes/kubernetes09/image-20230511225316951.png">
<meta property="og:image" content="http://chsblogs.com/2023/05/05/Container/Kubernetes/kubernetes09/image-20230512194646736.png">
<meta property="article:published_time" content="2023-05-05T06:56:17.000Z">
<meta property="article:modified_time" content="2023-05-12T11:48:01.026Z">
<meta property="article:author" content="陈怀森">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://chsblogs.com/2023/05/05/Container/Kubernetes/kubernetes09/image-20230511193018816.png">
  
  
  
  <title>(09).K8S基于ZooKeeper集群实现微服务动态注册和发现 - 陈怀森の运维笔记</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"chsblogs.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"SHELL"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":6},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>陈怀森 の 运维笔记</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="(09).K8S基于ZooKeeper集群实现微服务动态注册和发现"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-05-05 14:56" pubdate>
          2023年5月5日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          25k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          18 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">(09).K8S基于ZooKeeper集群实现微服务动态注册和发现</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="1-K8S基于ZooKeeper集群实现微服务动态注册和发现"><a href="#1-K8S基于ZooKeeper集群实现微服务动态注册和发现" class="headerlink" title="1.K8S基于ZooKeeper集群实现微服务动态注册和发现"></a>1.K8S基于ZooKeeper集群实现微服务动态注册和发现</h1><p><img src="/2023/05/05/Container/Kubernetes/kubernetes09/image-20230511193018816.png" srcset="/img/loading.gif" lazyload alt="image-20230511193018816"> </p>
<h2 id="1-1-构建zookeeper镜像"><a href="#1-1-构建zookeeper镜像" class="headerlink" title="1.1 构建zookeeper镜像"></a>1.1 构建zookeeper镜像</h2><p><strong>创建zoo.cfg配置文件：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># vim zoo.cfg</span>
<span class="token assign-left variable">tickTime</span><span class="token operator">=</span><span class="token number">2000</span>
<span class="token assign-left variable">initLimit</span><span class="token operator">=</span><span class="token number">10</span>
<span class="token assign-left variable">syncLimit</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/usr/local/zookeeper/data
<span class="token assign-left variable">dataLogDir</span><span class="token operator">=</span>/usr/local/zookeeper/wal
<span class="token comment">#snapCount=100000</span>
<span class="token assign-left variable">autopurge.purgeInterval</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>
<span class="token assign-left variable">quorumListenOnAllIPs</span><span class="token operator">=</span>true</code></pre></div></figure>



<p><strong>日志配置文件：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># vim log4j.properties</span>
<span class="token comment"># Define some default values that can be overridden by system properties</span>
<span class="token assign-left variable">zookeeper.root.logger</span><span class="token operator">=</span>INFO, CONSOLE, ROLLINGFILE
<span class="token assign-left variable">zookeeper.console.threshold</span><span class="token operator">=</span>INFO
<span class="token assign-left variable">zookeeper.log.dir</span><span class="token operator">=</span>/usr/local/zookeeper/log
<span class="token assign-left variable">zookeeper.log.file</span><span class="token operator">=</span>zookeeper.log
<span class="token assign-left variable">zookeeper.log.threshold</span><span class="token operator">=</span>INFO
<span class="token assign-left variable">zookeeper.tracelog.dir</span><span class="token operator">=</span>/usr/local/zookeeper/log
<span class="token assign-left variable">zookeeper.tracelog.file</span><span class="token operator">=</span>zookeeper_trace.log
 
<span class="token comment">#</span>
<span class="token comment"># ZooKeeper Logging Configuration</span>
<span class="token comment">#</span>
 
<span class="token comment"># Format is "&lt;default threshold> (, &lt;appender>)+</span>
 
<span class="token comment"># DEFAULT: console appender only</span>
<span class="token assign-left variable">log4j.rootLogger</span><span class="token operator">=</span><span class="token variable">$&#123;zookeeper.root.logger&#125;</span>
 
<span class="token comment"># Example with rolling log file</span>
<span class="token comment">#log4j.rootLogger=DEBUG, CONSOLE, ROLLINGFILE</span>
 
<span class="token comment"># Example with rolling log file and tracing</span>
<span class="token comment">#log4j.rootLogger=TRACE, CONSOLE, ROLLINGFILE, TRACEFILE</span>
 
<span class="token comment">#</span>
<span class="token comment"># Log INFO level and above messages to the console</span>
<span class="token comment">#</span>
<span class="token assign-left variable">log4j.appender.CONSOLE</span><span class="token operator">=</span>org.apache.log4j.ConsoleAppender
<span class="token assign-left variable">log4j.appender.CONSOLE.Threshold</span><span class="token operator">=</span><span class="token variable">$&#123;zookeeper.console.threshold&#125;</span>
<span class="token assign-left variable">log4j.appender.CONSOLE.layout</span><span class="token operator">=</span>org.apache.log4j.PatternLayout
<span class="token assign-left variable">log4j.appender.CONSOLE.layout.ConversionPattern</span><span class="token operator">=</span>%d<span class="token punctuation">&#123;</span>ISO8601<span class="token punctuation">&#125;</span> <span class="token punctuation">[</span>myid:%X<span class="token punctuation">&#123;</span>myid<span class="token punctuation">&#125;</span><span class="token punctuation">]</span> - %-5p <span class="token punctuation">[</span>%t:%C<span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">&#125;</span>@%L<span class="token punctuation">]</span> - %m%n
 
<span class="token comment">#</span>
<span class="token comment"># Add ROLLINGFILE to rootLogger to get log file output</span>
<span class="token comment">#    Log DEBUG level and above messages to a log file</span>
<span class="token assign-left variable">log4j.appender.ROLLINGFILE</span><span class="token operator">=</span>org.apache.log4j.RollingFileAppender
<span class="token assign-left variable">log4j.appender.ROLLINGFILE.Threshold</span><span class="token operator">=</span><span class="token variable">$&#123;zookeeper.log.threshold&#125;</span>
<span class="token assign-left variable">log4j.appender.ROLLINGFILE.File</span><span class="token operator">=</span><span class="token variable">$&#123;zookeeper.log.dir&#125;</span>/<span class="token variable">$&#123;zookeeper.log.file&#125;</span>
 
<span class="token comment"># Max log file size of 10MB</span>
<span class="token assign-left variable">log4j.appender.ROLLINGFILE.MaxFileSize</span><span class="token operator">=</span>10MB
<span class="token comment"># uncomment the next line to limit number of backup files</span>
<span class="token assign-left variable">log4j.appender.ROLLINGFILE.MaxBackupIndex</span><span class="token operator">=</span><span class="token number">5</span>
 
<span class="token assign-left variable">log4j.appender.ROLLINGFILE.layout</span><span class="token operator">=</span>org.apache.log4j.PatternLayout
<span class="token assign-left variable">log4j.appender.ROLLINGFILE.layout.ConversionPattern</span><span class="token operator">=</span>%d<span class="token punctuation">&#123;</span>ISO8601<span class="token punctuation">&#125;</span> <span class="token punctuation">[</span>myid:%X<span class="token punctuation">&#123;</span>myid<span class="token punctuation">&#125;</span><span class="token punctuation">]</span> - %-5p <span class="token punctuation">[</span>%t:%C<span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">&#125;</span>@%L<span class="token punctuation">]</span> - %m%n
 
 
<span class="token comment">#</span>
<span class="token comment"># Add TRACEFILE to rootLogger to get log file output</span>
<span class="token comment">#    Log DEBUG level and above messages to a log file</span>
<span class="token assign-left variable">log4j.appender.TRACEFILE</span><span class="token operator">=</span>org.apache.log4j.FileAppender
<span class="token assign-left variable">log4j.appender.TRACEFILE.Threshold</span><span class="token operator">=</span>TRACE
<span class="token assign-left variable">log4j.appender.TRACEFILE.File</span><span class="token operator">=</span><span class="token variable">$&#123;zookeeper.tracelog.dir&#125;</span>/<span class="token variable">$&#123;zookeeper.tracelog.file&#125;</span>
 
<span class="token assign-left variable">log4j.appender.TRACEFILE.layout</span><span class="token operator">=</span>org.apache.log4j.PatternLayout
<span class="token comment">### Notice we are including log4j's NDC here (%x)</span>
<span class="token assign-left variable">log4j.appender.TRACEFILE.layout.ConversionPattern</span><span class="token operator">=</span>%d<span class="token punctuation">&#123;</span>ISO8601<span class="token punctuation">&#125;</span> <span class="token punctuation">[</span>myid:%X<span class="token punctuation">&#123;</span>myid<span class="token punctuation">&#125;</span><span class="token punctuation">]</span> - %-5p <span class="token punctuation">[</span>%t:%C<span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">&#125;</span>@%L<span class="token punctuation">]</span><span class="token punctuation">[</span>%x<span class="token punctuation">]</span> - %m%n</code></pre></div></figure>



<p><strong>创建zookeeper生成集群配置文件脚本：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># vim entrypoint.sh</span>
<span class="token comment">#!/bin/bash</span>
  
<span class="token builtin class-name">echo</span> <span class="token variable">$&#123;MYID<span class="token operator">:-</span>0&#125;</span> <span class="token operator">></span> /usr/local/zookeeper/data/myid
 
<span class="token comment">#k8s zookeeper集群service名称</span>
<span class="token assign-left variable">servers</span><span class="token operator">=</span><span class="token punctuation">(</span>zookeeper1 zookeeper2 zookeeper3<span class="token punctuation">)</span>
 
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$servers</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
   <span class="token keyword">for</span> <span class="token for-or-select variable">list</span> <span class="token keyword">in</span> <span class="token string">"<span class="token variable">$&#123;<span class="token operator">!</span>servers<span class="token punctuation">[</span>@<span class="token punctuation">]</span>&#125;</span>"</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
      <span class="token builtin class-name">printf</span> <span class="token string">"<span class="token entity" title="\n">\n</span>server.%s = %s:2888:3888"</span> <span class="token string">"<span class="token variable"><span class="token variable">$((</span><span class="token number">1</span> <span class="token operator">+</span> $list<span class="token variable">))</span></span>"</span> <span class="token string">"<span class="token variable">$&#123;servers<span class="token punctuation">[</span>$list<span class="token punctuation">]</span>&#125;</span>"</span> <span class="token operator">>></span> /usr/local/zookeeper/conf/zoo.cfg
   <span class="token keyword">done</span>
<span class="token keyword">fi</span>
 
<span class="token builtin class-name">exec</span> <span class="token string">"<span class="token variable">$@</span>"</span></code></pre></div></figure>



<p><strong>创建集群状态检查脚本：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># vim zkReady.sh</span>
<span class="token comment">#!/bin/bash</span>
 
/usr/local/zookeeper/bin/zkServer.sh status <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token string">'Mode: (standalone|leader|follower|observing)'</span></code></pre></div></figure>



<p><strong>创建Dockerfile镜像文件：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># vim Dockerfile</span>
FROM harbor.chsblogs.local/system/jdk-base:v8.341
  
ENV ZK_VERSION <span class="token number">3.5</span>.10
COPY apache-zookeeper-3.5.10-bin.tar.gz /usr/local

RUN <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /usr/local/zookeeper/data /usr/local/zookeeper/wal /usr/local/zookeeper/log
RUN <span class="token builtin class-name">cd</span> /usr/local/ <span class="token operator">&amp;&amp;</span>  <span class="token punctuation">\</span>
<span class="token function">tar</span> xf apache-zookeeper-3.5.10-bin.tar.gz <span class="token parameter variable">-C</span> /usr/local/zookeeper/ --strip-component<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> apache-zookeeper-3.5.10-bin.tar.gz

COPY zoo.cfg /usr/local/zookeeper/conf/
COPY zkReady.sh /usr/local/zookeeper/bin/
COPY entrypoint.sh /

ENV <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/zookeeper/bin:<span class="token variable">$&#123;<span class="token environment constant">PATH</span>&#125;</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">ZOO_LOG_DIR</span><span class="token operator">=</span>/usr/local/zookeeper/log <span class="token punctuation">\</span>
    <span class="token assign-left variable">ZOO_LOG4J_PROP</span><span class="token operator">=</span><span class="token string">"INFO, CONSOLE, ROLLINGFILE"</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">JMXPORT</span><span class="token operator">=</span><span class="token number">9010</span>

ENTRYPOINT <span class="token punctuation">[</span> <span class="token string">"/entrypoint.sh"</span> <span class="token punctuation">]</span>

CMD <span class="token punctuation">[</span> <span class="token string">"zkServer.sh"</span>, <span class="token string">"start-foreground"</span> <span class="token punctuation">]</span>

EXPOSE <span class="token number">2181</span> <span class="token number">2888</span> <span class="token number">3888</span> <span class="token number">9010</span></code></pre></div></figure>



<p><strong>创建镜像构建脚本：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># vim build-command.sh</span>
<span class="token comment">#!/bin/bash</span>
<span class="token assign-left variable">TAG</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> harbor.chsblogs.local/zookeeper/zookeeper:<span class="token variable">$&#123;TAG&#125;</span> <span class="token builtin class-name">.</span>

<span class="token function">docker</span> push harbor.chsblogs.local/zookeeper/zookeeper:<span class="token variable">$&#123;TAG&#125;</span></code></pre></div></figure>



<p><strong>构建zookeeper镜像：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># ./build-command.sh v3.5.10</span></code></pre></div></figure>



<h2 id="1-2-配置NFS"><a href="#1-2-配置NFS" class="headerlink" title="1.2 配置NFS"></a>1.2 配置NFS</h2><figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@ha1:/data/k8sdata<span class="token comment"># mkdir /data/k8sdata/zookeeper/zookeeper-datadir-&#123;1..3&#125; -p</span>
root@ha1:/data/k8sdata<span class="token comment"># cat /etc/exports</span>
/data/k8sdata *<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span> </code></pre></div></figure>



<h2 id="1-3-创建K8S资源"><a href="#1-3-创建K8S资源" class="headerlink" title="1.3 创建K8S资源"></a>1.3 创建K8S资源</h2><p><strong>创建测试zookeeper集群命名空间：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl create ns zookeeper</span>
namespace/zookeeper created</code></pre></div></figure>



<p><strong>创建zookeeper集群PV：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># vim zookeeper-pv.yaml</span>
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: zookeeper-datadir-pv-1
spec:
  capacity:
    storage: 20Gi
  accessModes:
    - ReadWriteOnce
  nfs:
    server: <span class="token number">192.168</span>.1.43
    path: /data/k8sdata/zookeeper/zookeeper-datadir-1

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: zookeeper-datadir-pv-2
spec:
  capacity:
    storage: 20Gi
  accessModes:
    - ReadWriteOnce
  nfs:
    server: <span class="token number">192.168</span>.1.43
    path: /data/k8sdata/zookeeper/zookeeper-datadir-2

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: zookeeper-datadir-pv-3
spec:
  capacity:
    storage: 20Gi
  accessModes:
    - ReadWriteOnce
  nfs:
    server: <span class="token number">192.168</span>.1.43
    path: /data/k8sdata/zookeeper/zookeeper-datadir-3

root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl apply -f zookeeper-pv.yaml </span>
persistentvolume/zookeeper-datadir-pv-1 created
persistentvolume/zookeeper-datadir-pv-2 created
persistentvolume/zookeeper-datadir-pv-3 created

root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl get pv | grep zook</span>
zookeeper-datadir-pv-1   20Gi       RWO            Retain           Available                                                12s
zookeeper-datadir-pv-2   20Gi       RWO            Retain           Available                                                12s
zookeeper-datadir-pv-3   20Gi       RWO            Retain           Available                                                12s</code></pre></div></figure>



<p><strong>创建zookeeper集群PVC：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># vim zookeeper-pvc.yaml</span>
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: zookeeper-datadir-pvc-1
  namespace: zookeeper
spec:
  accessModes:
    - ReadWriteOnce
  volumeName: zookeeper-datadir-pv-1
  resources:
    requests:
      storage: 10Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: zookeeper-datadir-pvc-2
  namespace: zookeeper
spec:
  accessModes:
    - ReadWriteOnce
  volumeName: zookeeper-datadir-pv-2
  resources:
    requests:
      storage: 10Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: zookeeper-datadir-pvc-3
  namespace: zookeeper
spec:
  accessModes:
    - ReadWriteOnce
  volumeName: zookeeper-datadir-pv-3
  resources:
    requests:
      storage: 10Gi
      
root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl apply -f zookeeper-pvc.yaml </span>
persistentvolumeclaim/zookeeper-datadir-pvc-1 created
persistentvolumeclaim/zookeeper-datadir-pvc-2 created
persistentvolumeclaim/zookeeper-datadir-pvc-3 created

root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl get pvc -n zookeeper</span>
NAME                      STATUS   VOLUME                   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
zookeeper-datadir-pvc-1   Bound    zookeeper-datadir-pv-1   20Gi       RWO                           17s
zookeeper-datadir-pvc-2   Bound    zookeeper-datadir-pv-2   20Gi       RWO                           17s
zookeeper-datadir-pvc-3   Bound    zookeeper-datadir-pv-3   20Gi       RWO                           17s

root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl get pv | grep zook</span>
zookeeper-datadir-pv-1   20Gi       RWO            Retain           Bound    zookeeper/zookeeper-datadir-pvc-1                           14m
zookeeper-datadir-pv-2   20Gi       RWO            Retain           Bound    zookeeper/zookeeper-datadir-pvc-2                           14m
zookeeper-datadir-pv-3   20Gi       RWO            Retain           Bound    zookeeper/zookeeper-datadir-pvc-3                           14m</code></pre></div></figure>



<p><strong>创建zookeeper资源清单文件deployment：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># vim zookeeper.yaml</span>
---
<span class="token comment">#创建zookeeper1</span>
kind: Deployment
apiVersion: apps/v1
metadata:
  name: zookeeper1
  namespace: zookeeper
spec:
  replicas: <span class="token number">1</span>
  selector:
    matchLabels:
      app: zookeeper
  template:
    metadata:
      labels:
        app: zookeeper
        server-id: <span class="token string">"1"</span>
    spec:
      volumes:
        - name: data
          emptyDir: <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        - name: wal
          emptyDir:
            medium: Memory <span class="token comment">#预写日志数据持久化到内存</span>
      containers:
        - name: server
          image: harbor.chsblogs.local/zookeeper/zookeeper:v3.5.10
          imagePullPolicy: IfNotPresent
          env:
            - name: MYID
              value: <span class="token string">"1"</span>
            - name: JVMFLAGS
              value: <span class="token string">"-Xmx2G"</span>
          ports:
            - containerPort: <span class="token number">2181</span>
            - containerPort: <span class="token number">2888</span>
            - containerPort: <span class="token number">3888</span>
          volumeMounts:
          - mountPath: <span class="token string">"/usr/local/zookeeper/data"</span>
            name: zookeeper-datadir-pvc-1
      volumes:
        - name: zookeeper-datadir-pvc-1
          persistentVolumeClaim:
            claimName: zookeeper-datadir-pvc-1

---
<span class="token comment">#创建zookeeper2实例</span>
kind: Deployment
apiVersion: apps/v1
metadata:
  name: zookeeper2
  namespace: zookeeper
spec:
  replicas: <span class="token number">1</span>
  selector:
    matchLabels:
      app: zookeeper
  template:
    metadata:
      labels:
        app: zookeeper
        server-id: <span class="token string">"2"</span>
    spec:
      volumes:
        - name: data
          emptyDir: <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        - name: wal
          emptyDir:
            medium: Memory
      containers:
        - name: server
          image: harbor.chsblogs.local/zookeeper/zookeeper:v3.5.10
          imagePullPolicy: IfNotPresent
          env:
            - name: MYID
              value: <span class="token string">"2"</span>
            - name: JVMFLAGS
              value: <span class="token string">"-Xmx2G"</span>
          ports:
            - containerPort: <span class="token number">2181</span>
            - containerPort: <span class="token number">2888</span>
            - containerPort: <span class="token number">3888</span>
          volumeMounts:
          - mountPath: <span class="token string">"/usr/local/zookeeper/data"</span>
            name: zookeeper-datadir-pvc-2
      volumes:
        - name: zookeeper-datadir-pvc-2
          persistentVolumeClaim:
            claimName: zookeeper-datadir-pvc-2

---
<span class="token comment">#创建zookeeper3实例</span>
kind: Deployment
apiVersion: apps/v1
metadata:
  name: zookeeper3
  namespace: zookeeper
spec:
  replicas: <span class="token number">1</span>
  selector:
    matchLabels:
      app: zookeeper
  template:
    metadata:
      labels:
        app: zookeeper
        server-id: <span class="token string">"3"</span>
    spec:
      volumes:
        - name: data
          emptyDir: <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        - name: wal
          emptyDir:
            medium: Memory
      containers:
        - name: server
          image: harbor.chsblogs.local/zookeeper/zookeeper:v3.5.10
          imagePullPolicy: IfNotPresent
          env:
            - name: MYID
              value: <span class="token string">"3"</span>
            - name: JVMFLAGS
              value: <span class="token string">"-Xmx2G"</span>
          ports:
            - containerPort: <span class="token number">2181</span>
            - containerPort: <span class="token number">2888</span>
            - containerPort: <span class="token number">3888</span>
          volumeMounts:
          - mountPath: <span class="token string">"/usr/local/zookeeper/data"</span>
            name: zookeeper-datadir-pvc-3
      volumes:
        - name: zookeeper-datadir-pvc-3
          persistentVolumeClaim:
           claimName: zookeeper-datadir-pvc-3

root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl apply -f zookeeper.yaml </span>
deployment.apps/zookeeper1 created
deployment.apps/zookeeper2 created
deployment.apps/zookeeper3 created

root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl get pod -n zookeeper</span>
NAME                          READY   STATUS    RESTARTS   AGE
zookeeper1-78df6bffb-hwszc    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          28s
zookeeper2-5868f54d65-hcg42   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          28s
zookeeper3-6dd44dbb-bdqv5     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          28s</code></pre></div></figure>





<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># vim zookeeper-svc.yaml</span>
<span class="token comment">#所有zookeeper节点内网访问client</span>
apiVersion: v1
kind: Service
metadata:
  name: zookeeper
  namespace: zookeeper
spec:
  ports:
    - name: client
      port: <span class="token number">2181</span>
  selector:
    app: zookeeper
 
---
<span class="token comment">#对外访问zookeeper1</span>
apiVersion: v1
kind: Service
metadata:
  name: zookeeper1
  namespace: zookeeper
spec:
  type: NodePort        
  ports:
    - name: client
      port: <span class="token number">2181</span>
      nodePort: <span class="token number">32181</span>
    - name: followers
      port: <span class="token number">2888</span>
    - name: election
      port: <span class="token number">3888</span>
  selector:
    app: zookeeper
    server-id: <span class="token string">"1"</span>
 
---
<span class="token comment">#对外访问zookeeper2</span>
apiVersion: v1
kind: Service
metadata:
  name: zookeeper2
  namespace: zookeeper
spec:
  type: NodePort        
  ports:
    - name: client
      port: <span class="token number">2181</span>
      nodePort: <span class="token number">32182</span>
    - name: followers
      port: <span class="token number">2888</span>
    - name: election
      port: <span class="token number">3888</span>
  selector:
    app: zookeeper
    server-id: <span class="token string">"2"</span>
 
---
<span class="token comment">#对外访问zookeeper3</span>
apiVersion: v1
kind: Service
metadata:
  name: zookeeper3
  namespace: zookeeper
spec:
  type: NodePort        
  ports:
    - name: client
      port: <span class="token number">2181</span>
      nodePort: <span class="token number">32183</span>
    - name: followers
      port: <span class="token number">2888</span>
    - name: election
      port: <span class="token number">3888</span>
  selector:
    app: zookeeper
    server-id: <span class="token string">"3"</span>
    
root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl apply -f zookeeper-svc.yaml </span>
service/zookeeper created
service/zookeeper1 created
service/zookeeper2 created
service/zookeeper3 created
root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl get svc -n zookeeper</span>
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                                        AGE
zookeeper    ClusterIP   <span class="token number">172.20</span>.86.133   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">2181</span>/TCP                                       11s
zookeeper1   NodePort    <span class="token number">172.20</span>.18.7     <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">2181</span>:32181/TCP,2888:48631/TCP,3888:40307/TCP   11s
zookeeper2   NodePort    <span class="token number">172.20</span>.96.95    <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">2181</span>:32182/TCP,2888:34687/TCP,3888:54242/TCP   11s
zookeeper3   NodePort    <span class="token number">172.20</span>.11.142   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">2181</span>:32183/TCP,2888:54471/TCP,3888:33958/TCP   11s
root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl get ep -n zookeeper</span>
NAME         ENDPOINTS                                                  AGE
zookeeper    <span class="token number">10.20</span>.132.217:2181,10.20.132.218:2181,10.20.178.241:2181   17s
zookeeper1   <span class="token number">10.20</span>.132.218:2181,10.20.132.218:2888,10.20.132.218:3888   17s
zookeeper2   <span class="token number">10.20</span>.132.217:2181,10.20.132.217:2888,10.20.132.217:3888   17s
zookeeper3   <span class="token number">10.20</span>.178.241:2181,10.20.178.241:2888,10.20.178.241:3888   17s</code></pre></div></figure>



<p><strong>观察验证zookeeper集群模式，leader和follower：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl get pod -n zookeeper</span>
NAME                          READY   STATUS    RESTARTS   AGE
zookeeper1-78df6bffb-hwszc    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19m
zookeeper2-5868f54d65-hcg42   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19m
zookeeper3-6dd44dbb-bdqv5     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19m
root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl exec -it zookeeper1-78df6bffb-hwszc -n zookeeper /usr/local/zookeeper/bin/zkServer.sh status</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> -- <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead.
ZooKeeper JMX enabled by default
ZooKeeper remote JMX Port <span class="token builtin class-name">set</span> to <span class="token number">9010</span>
ZooKeeper remote JMX authenticate <span class="token builtin class-name">set</span> to <span class="token boolean">false</span>
ZooKeeper remote JMX ssl <span class="token builtin class-name">set</span> to <span class="token boolean">false</span>
ZooKeeper remote JMX log4j <span class="token builtin class-name">set</span> to <span class="token boolean">true</span>
Using config: /usr/local/zookeeper/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Client port found: <span class="token number">2181</span>. Client address: localhost. Client SSL: false.
Mode: follower
root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl exec -it zookeeper2-5868f54d65-hcg42 -n zookeeper /usr/local/zookeeper/bin/zkServer.sh status</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> -- <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead.
ZooKeeper JMX enabled by default
ZooKeeper remote JMX Port <span class="token builtin class-name">set</span> to <span class="token number">9010</span>
ZooKeeper remote JMX authenticate <span class="token builtin class-name">set</span> to <span class="token boolean">false</span>
ZooKeeper remote JMX ssl <span class="token builtin class-name">set</span> to <span class="token boolean">false</span>
ZooKeeper remote JMX log4j <span class="token builtin class-name">set</span> to <span class="token boolean">true</span>
Using config: /usr/local/zookeeper/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Client port found: <span class="token number">2181</span>. Client address: localhost. Client SSL: false.
Mode: follower
root@deploy:/opt/dockerfile/project/zookeeper<span class="token comment"># kubectl exec -it zookeeper3-6dd44dbb-bdqv5 -n zookeeper /usr/local/zookeeper/bin/zkServer.sh status</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> -- <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead.
ZooKeeper JMX enabled by default
ZooKeeper remote JMX Port <span class="token builtin class-name">set</span> to <span class="token number">9010</span>
ZooKeeper remote JMX authenticate <span class="token builtin class-name">set</span> to <span class="token boolean">false</span>
ZooKeeper remote JMX ssl <span class="token builtin class-name">set</span> to <span class="token boolean">false</span>
ZooKeeper remote JMX log4j <span class="token builtin class-name">set</span> to <span class="token boolean">true</span>
Using config: /usr/local/zookeeper/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Client port found: <span class="token number">2181</span>. Client address: localhost. Client SSL: false.
Mode: leader</code></pre></div></figure>



<h2 id="1-4-zookeeper-dubbo微服务架构"><a href="#1-4-zookeeper-dubbo微服务架构" class="headerlink" title="1.4 zookeeper+dubbo微服务架构"></a>1.4 zookeeper+dubbo微服务架构</h2><p><img src="/2023/05/05/Container/Kubernetes/kubernetes09/image-20230511225316951.png" srcset="/img/loading.gif" lazyload alt="image-20230511225316951"> </p>
<h2 id="1-5-创建生产者资源"><a href="#1-5-创建生产者资源" class="headerlink" title="1.5 创建生产者资源"></a>1.5 创建生产者资源</h2><p><strong>创建dubbo provider生产者Dockerfile：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-provider<span class="token comment"># vim Dockerfile</span>
<span class="token comment">#Dubbo provider</span>
FROM harbor.chsblogs.local/system/jdk-base:v8.341

RUN <span class="token function">useradd</span> nginx
RUN <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">file</span> netcat-traditional <span class="token parameter variable">-y</span>
RUN <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /usr/local/dubbo/provider
ADD dubbo-demo-provider-2.1.5/  /usr/local/dubbo/provider
ADD run_java.sh /usr/local/dubbo/provider/bin
RUN <span class="token function">chown</span> nginx.nginx /usr/local/dubbo <span class="token parameter variable">-R</span>
RUN <span class="token function">chmod</span> a+x /usr/local/dubbo/provider/bin/*.sh

CMD <span class="token punctuation">[</span><span class="token string">"/usr/local/dubbo/provider/bin/run_java.sh"</span><span class="token punctuation">]</span></code></pre></div></figure>



<p><strong>配置provider生产者配置文件，填写zookeeper pod的dns地址。Zookeeper使用deployment控制器部署则地址为pod名称.名称空间.svc.集群名称：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-provider<span class="token comment"># vim dubbo-demo-provider-2.1.5/conf/dubbo.properties</span>
<span class="token comment">##</span>
<span class="token comment"># Copyright 1999-2011 Alibaba Group.</span>
<span class="token comment">#  </span>
<span class="token comment"># Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="token comment"># you may not use this file except in compliance with the License.</span>
<span class="token comment"># You may obtain a copy of the License at</span>
<span class="token comment">#  </span>
<span class="token comment">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="token comment">#  </span>
<span class="token comment"># Unless required by applicable law or agreed to in writing, software</span>
<span class="token comment"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="token comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="token comment"># See the License for the specific language governing permissions and</span>
<span class="token comment"># limitations under the License.</span>
<span class="token comment">##</span>
<span class="token assign-left variable">dubbo.container</span><span class="token operator">=</span>log4j,spring
<span class="token assign-left variable">dubbo.application.name</span><span class="token operator">=</span>demo-provider
<span class="token assign-left variable">dubbo.application.owner</span><span class="token operator">=</span>
<span class="token comment">#dubbo.registry.address=multicast://224.5.6.7:1234</span>
<span class="token assign-left variable">dubbo.registry.address</span><span class="token operator">=</span>zookeeper://zookeeper1.zookeeper.svc.chsblogs.local:2181 <span class="token operator">|</span> zookeeper://zookeeper2.zookeeper.svc.chsblogs.local:2181 <span class="token operator">|</span> zookeeper://zookeeper3.zookeeper.svc.chsblogs.local:2181
<span class="token comment">#dubbo.registry.address=redis://127.0.0.1:6379</span>
<span class="token comment">#dubbo.registry.address=dubbo://127.0.0.1:9090</span>
<span class="token assign-left variable">dubbo.monitor.protocol</span><span class="token operator">=</span>registry
<span class="token assign-left variable">dubbo.protocol.name</span><span class="token operator">=</span>dubbo
<span class="token assign-left variable">dubbo.protocol.port</span><span class="token operator">=</span><span class="token number">20880</span>
<span class="token assign-left variable">dubbo.log4j.file</span><span class="token operator">=</span>logs/dubbo-demo-provider.log
<span class="token assign-left variable">dubbo.log4j.level</span><span class="token operator">=</span>WARN</code></pre></div></figure>



<p><strong>创建dubbo-provider容器运行脚本：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-provider<span class="token comment"># vim run_java.sh</span>
<span class="token comment">#!/bin/bash</span>
<span class="token function">su</span> - nginx <span class="token parameter variable">-c</span> <span class="token string">"/usr/local/dubbo/provider/bin/start.sh"</span>
<span class="token function">tail</span> <span class="token parameter variable">-f</span> /usr/local/dubbo/provider/logs/dubbo-demo-provider.log</code></pre></div></figure>



<p><strong>创建镜像构建脚本：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-provider<span class="token comment"># vim build-command.sh</span>
<span class="token comment">#!/bin/bash</span>
<span class="token assign-left variable">TAG</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> harbor.chsblogs.local/zookeeper/dubbo-demo-provider:<span class="token variable">$&#123;TAG&#125;</span> <span class="token builtin class-name">.</span>
<span class="token function">docker</span> push harbor.chsblogs.local/zookeeper/dubbo-demo-provider:<span class="token variable">$&#123;TAG&#125;</span>

root@deploy:/opt/dockerfile/project/zookeeper/dubbo-provider<span class="token comment"># ./build-command.sh v2.1.5</span></code></pre></div></figure>



<p><strong>创建生产者k8s资源清单文件：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-provider<span class="token comment"># vim provider.yaml</span>
kind: Deployment
apiVersion: apps/v1
metadata:
  labels:
    app: dubbo-provider
  name: dubbo-provider-deployment
  namespace: zookeeper
spec:
  replicas: <span class="token number">3</span>
  selector:
    matchLabels:
      app: dubbo-provider
  template:
    metadata:
      labels:
        app: dubbo-provider
    spec:
      containers:
      - name: dubbo-provider-container
        image: harbor.chsblogs.local/zookeeper/dubbo-demo-provider:v2.1.5
        imagePullPolicy: Always
        ports:
        - containerPort: <span class="token number">20880</span>
          protocol: TCP
          name: http

---
kind: Service
apiVersion: v1
metadata:
  labels:
    app: dubbo-provider
  name: dubbo-provider-spec
  namespace: zookeeper
spec:
  type: NodePort
  ports:
  - name: http
    port: <span class="token number">80</span>
    protocol: TCP
    targetPort: <span class="token number">20880</span>
    <span class="token comment">#nodePort: 30001</span>
  selector:
    app: dubbo-provider
    
root@deploy:/opt/dockerfile/project/zookeeper/dubbo-provider<span class="token comment"># kubectl apply -f provider.yaml </span>
deployment.apps/dubbo-provider-deployment created
service/dubbo-provider-spec created
root@deploy:/opt/dockerfile/project/zookeeper/dubbo-provider<span class="token comment"># kubectl get pod -n zookeeper | grep dubbo-pro</span>
dubbo-provider-deployment-647fcb66dc-9shkf   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21s
dubbo-provider-deployment-647fcb66dc-ctxsx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21s
dubbo-provider-deployment-647fcb66dc-kp84d   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21s
root@deploy:/opt/dockerfile/project/zookeeper/dubbo-provider<span class="token comment"># kubectl get svc -n zookeeper | grep dubbo-pro</span>
dubbo-provider-spec   NodePort    <span class="token number">172.20</span>.241.94   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:54065/TCP                                   57s
root@deploy:/opt/dockerfile/project/zookeeper/dubbo-provider<span class="token comment"># kubectl get ep -n zookeeper | grep dubbo-pro</span>
dubbo-provider-spec   <span class="token number">10.20</span>.132.220:20880,10.20.178.242:20880,10.20.39.234:20880   61s</code></pre></div></figure>



<h2 id="1-6-创建消费者资源"><a href="#1-6-创建消费者资源" class="headerlink" title="1.6 创建消费者资源"></a>1.6 创建消费者资源</h2><p> <strong>创建consumer 消费者Dockerfile：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-consumer<span class="token comment"># vim Dockerfile</span>
</code></pre></div></figure>



<p><strong>配置dubbo consumer配置文件：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-consumer<span class="token comment"># vim dubbo-demo-consumer-2.1.5/conf/dubbo.properties</span>
<span class="token comment">##</span>
<span class="token comment"># Copyright 1999-2011 Alibaba Group.</span>
<span class="token comment">#  </span>
<span class="token comment"># Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="token comment"># you may not use this file except in compliance with the License.</span>
<span class="token comment"># You may obtain a copy of the License at</span>
<span class="token comment">#  </span>
<span class="token comment">#      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="token comment">#  </span>
<span class="token comment"># Unless required by applicable law or agreed to in writing, software</span>
<span class="token comment"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="token comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="token comment"># See the License for the specific language governing permissions and</span>
<span class="token comment"># limitations under the License.</span>
<span class="token comment">##</span>
<span class="token assign-left variable">dubbo.container</span><span class="token operator">=</span>log4j,spring
<span class="token assign-left variable">dubbo.application.name</span><span class="token operator">=</span>demo-consumer
<span class="token assign-left variable">dubbo.application.owner</span><span class="token operator">=</span>
<span class="token comment">#dubbo.registry.address=multicast://224.5.6.7:1234</span>
<span class="token assign-left variable">dubbo.registry.address</span><span class="token operator">=</span>zookeeper://zookeeper1.zookeeper.svc.chsblogs.local:2181 <span class="token operator">|</span> zookeeper://zookeeper2.zookeeper.svc.chsblogs.local:2181 <span class="token operator">|</span> zookeeper://zookeeper3.zookeeper.svc.chsblogs.local:2181
<span class="token comment">#dubbo.registry.address=redis://127.0.0.1:6379</span>
<span class="token comment">#dubbo.registry.address=dubbo://127.0.0.1:9090</span>
<span class="token assign-left variable">dubbo.monitor.protocol</span><span class="token operator">=</span>registry
<span class="token assign-left variable">dubbo.log4j.file</span><span class="token operator">=</span>logs/dubbo-demo-consumer.log
<span class="token assign-left variable">dubbo.log4j.level</span><span class="token operator">=</span>WARN</code></pre></div></figure>





<p><strong>创建dubbo-consumer容器运行脚本：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-consumer<span class="token comment"># vim run_java.sh</span>
<span class="token comment">#!/bin/bash</span>
<span class="token function">su</span> - nginx <span class="token parameter variable">-c</span> <span class="token string">"/usr/local/dubbo/consumer/bin/start.sh"</span>
<span class="token function">tail</span> <span class="token parameter variable">-f</span> /usr/local/dubbo/consumer/logs/dubbo-demo-consumer.log</code></pre></div></figure>



<p><strong>创建镜像构建脚本：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-consumer<span class="token comment"># vim build-command.sh </span>
<span class="token comment">#!/bin/bash</span>
<span class="token assign-left variable">TAG</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> harbor.chsblogs.local/zookeeper/dubbo-demo-consumer:<span class="token variable">$&#123;TAG&#125;</span> <span class="token builtin class-name">.</span>
<span class="token function">docker</span> push harbor.chsblogs.local/zookeeper/dubbo-demo-consumer:<span class="token variable">$&#123;TAG&#125;</span>

root@deploy:/opt/dockerfile/project/zookeeper/dubbo-consumer<span class="token comment"># ./build-command.sh v2.1.5</span></code></pre></div></figure>



<p><strong>创建消费者k8s资源清单文件：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-consumer<span class="token comment"># vim consumer.yaml</span>
kind: Deployment
apiVersion: apps/v1
metadata:
  labels:
    app: dubbo-consumer
  name: dubbo-consumer-deployment
  namespace: zookeeper
spec:
  replicas: <span class="token number">3</span>
  selector:
    matchLabels:
      app: dubbo-consumer
  template:
    metadata:
      labels:
        app: dubbo-consumer
    spec:
      containers:
      - name: dubbo-consumer-container
        image: harbor.chsblogs.local/zookeeper/dubbo-demo-consumer:v2.1.5
        imagePullPolicy: Always
        ports:
        - containerPort: <span class="token number">80</span>
          protocol: TCP
          name: http

---
kind: Service
apiVersion: v1
metadata:
  labels:
    app: dubbo-consumer
  name: dubbo-consumer-server
  namespace: zookeeper
spec:
  type: NodePort
  ports:
  - name: http
    port: <span class="token number">80</span>
    protocol: TCP
    targetPort: <span class="token number">80</span>
    <span class="token comment">#nodePort: 30001</span>
  selector:
    app: dubbo-consumer
    
root@deploy:/opt/dockerfile/project/zookeeper/dubbo-consumer<span class="token comment"># kubectl apply -f consumer.yaml </span>
deployment.apps/dubbo-consumer-deployment created
service/dubbo-consumer-server created

root@deploy:/opt/dockerfile/project/zookeeper/dubbo-consumer<span class="token comment"># kubectl get pod -n zookeeper -o wide | grep dubbo-con</span>
dubbo-consumer-deployment-5bc8f774c6-2xwb9   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          96s   <span class="token number">10.20</span>.132.221   <span class="token number">192.168</span>.1.50   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
dubbo-consumer-deployment-5bc8f774c6-j67sf   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          96s   <span class="token number">10.20</span>.178.243   <span class="token number">192.168</span>.1.51   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
dubbo-consumer-deployment-5bc8f774c6-xlntm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          96s   <span class="token number">10.20</span>.39.235    <span class="token number">192.168</span>.1.49   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span></code></pre></div></figure>



<p><strong>查看provider日志消息，查看多个consumer调用provider：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-consumer<span class="token comment"># kubectl exec -it dubbo-provider-deployment-647fcb66dc-9shkf -n zookeeper bash</span>
root@dubbo-provider-deployment-647fcb66dc-9shkf:/<span class="token comment"># tail -f /usr/local/dubbo/provider/logs/stdout.log </span>
<span class="token punctuation">[</span><span class="token number">15</span>:31:03<span class="token punctuation">]</span> Hello world111, request from consumer: /10.20.39.235:54138
<span class="token punctuation">[</span><span class="token number">15</span>:31:09<span class="token punctuation">]</span> Hello world114, request from consumer: /10.20.178.243:38824
<span class="token punctuation">[</span><span class="token number">15</span>:31:09<span class="token punctuation">]</span> Hello world114, request from consumer: /10.20.132.221:48604
<span class="token punctuation">[</span><span class="token number">15</span>:31:09<span class="token punctuation">]</span> Hello world114, request from consumer: /10.20.39.235:54138
<span class="token punctuation">[</span><span class="token number">15</span>:31:15<span class="token punctuation">]</span> Hello world117, request from consumer: /10.20.178.243:38824
<span class="token punctuation">[</span><span class="token number">15</span>:31:15<span class="token punctuation">]</span> Hello world117, request from consumer: /10.20.132.221:48604
<span class="token punctuation">[</span><span class="token number">15</span>:31:15<span class="token punctuation">]</span> Hello world117, request from consumer: /10.20.39.235:54138
<span class="token punctuation">[</span><span class="token number">15</span>:31:21<span class="token punctuation">]</span> Hello world120, request from consumer: /10.20.178.243:38824
<span class="token punctuation">[</span><span class="token number">15</span>:31:21<span class="token punctuation">]</span> Hello world120, request from consumer: /10.20.132.221:48604</code></pre></div></figure>



<h2 id="1-7-部署dubbo-admin控制台"><a href="#1-7-部署dubbo-admin控制台" class="headerlink" title="1.7 部署dubbo admin控制台"></a>1.7 部署dubbo admin控制台</h2><p><strong>创建dubbo-admin Dockerfile：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-admin<span class="token comment"># vim Dockerfile</span>
FROM harbor.chsblogs.local/system/tomcat:v9.0.65
  
RUN <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">unzip</span> <span class="token parameter variable">-y</span>
ADD server.xml /usr/local/tomcat/conf/server.xml
ADD logging.properties /usr/local/tomcat/conf/logging.properties
ADD catalina.sh /usr/local/tomcat/bin/catalina.sh
ADD run_tomcat.sh /usr/local/tomcat/bin/run_tomcat.sh
ADD dubboadmin  /usr/local/tomcat/webapps/dubboadmin

EXPOSE <span class="token number">8080</span> <span class="token number">8443</span>

CMD <span class="token punctuation">[</span><span class="token string">"/usr/local/tomcat/bin/run_tomcat.sh"</span><span class="token punctuation">]</span></code></pre></div></figure>



<p><strong>配置catalina.sh，修改tocmat java启动参数：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-admin<span class="token comment"># vim catalina.sh</span>
<span class="token assign-left variable">JAVA_OPTS</span><span class="token operator">=</span><span class="token string">"-server -Xms512m -Xmx512m -Xss512k -Xmn1g -XX:CMSInitiatingOccupancyFraction=65  -XX:+UseFastAccessorMethods -XX:+AggressiveOpts -XX:+UseBiasedLocking -XX:+DisableExplicitGC -XX:MaxTenuringThreshold=10 -XX:NewSize=2048M -XX:MaxNewSize=2048M -XX:NewRatio=2 -XX:PermSize=128m -XX:MaxPermSize=512m -XX:CMSFullGCsBeforeCompaction=5 -XX:+ExplicitGCInvokesConcurrent -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods"</span></code></pre></div></figure>



<p><strong>修改tomcat的日志路径：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-admin<span class="token comment"># vim logging.properties </span>
3manager.org.apache.juli.AsyncFileHandler.directory <span class="token operator">=</span> /usr/local/tomcat/logs</code></pre></div></figure>



<p><strong>修改tomcat服务配置文件，设置项目路径和名称：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-admin<span class="token comment"># vim server.xml</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
      <span class="token operator">&lt;</span>Host <span class="token assign-left variable">appBase</span><span class="token operator">=</span><span class="token string">"/usr/local/tomcat/webapps"</span> <span class="token assign-left variable">autoDeploy</span><span class="token operator">=</span><span class="token string">"true"</span> <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"localhost"</span> <span class="token assign-left variable">unpackWARs</span><span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">></span>

        <span class="token operator">&lt;</span><span class="token operator">!</span>-- SingleSignOn valve, share authentication between web applications
             Documentation at: /docs/config/valve.html --<span class="token operator">></span>
        <span class="token operator">&lt;</span><span class="token operator">!</span>--
        <span class="token operator">&lt;</span>Valve <span class="token assign-left variable">className</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.authenticator.SingleSignOn"</span> /<span class="token operator">></span>
        --<span class="token operator">></span>

        <span class="token operator">&lt;</span><span class="token operator">!</span>-- Access log processes all example.
             Documentation at: /docs/config/valve.html
             Note: The pattern used is equivalent to using <span class="token assign-left variable">pattern</span><span class="token operator">=</span><span class="token string">"common"</span> --<span class="token operator">></span>
        <span class="token operator">&lt;</span>Valve <span class="token assign-left variable">className</span><span class="token operator">=</span><span class="token string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="token assign-left variable">directory</span><span class="token operator">=</span><span class="token string">"logs"</span> <span class="token assign-left variable">pattern</span><span class="token operator">=</span><span class="token string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token string">"localhost_access_log"</span> <span class="token assign-left variable">suffix</span><span class="token operator">=</span><span class="token string">".txt"</span>/<span class="token operator">></span>

        <span class="token operator">&lt;</span>Context <span class="token assign-left variable">docBase</span><span class="token operator">=</span><span class="token string">"dubboadmin"</span> <span class="token assign-left variable">path</span><span class="token operator">=</span><span class="token string">"/"</span> <span class="token assign-left variable">reloadable</span><span class="token operator">=</span><span class="token string">"true"</span> <span class="token assign-left variable">source</span><span class="token operator">=</span><span class="token string">"org.eclipse.jst.jee.server:dubboadmin"</span>/<span class="token operator">></span>

        <span class="token operator">&lt;</span>/Host<span class="token operator">></span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span></code></pre></div></figure>



<p><strong>修改tomcat 服务启动脚本：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-admin<span class="token comment"># vim run_tomcat.sh</span>
<span class="token comment">#!/bin/bash</span>
 
/usr/local/tomcat/bin/catalina.sh start
<span class="token function">tail</span> <span class="token parameter variable">-f</span> /usr/local/tomcat/logs/catalina.out</code></pre></div></figure>



<p><strong>修改dubbo-admin配置文件：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-admin<span class="token comment"># vim dubboadmin/WEB-INF/dubbo.properties</span>
<span class="token assign-left variable">dubbo.registry.address</span><span class="token operator">=</span>zookeeper://zookeeper1.zookeeper.svc.chsblogs.local:2181 <span class="token operator">|</span> zookeeper://zookeeper2.zookeeper.svc.chsblogs.local:2181 <span class="token operator">|</span> zookeeper://zookeeper3.zookeeper.svc.chsblogs.local:2181
<span class="token assign-left variable">dubbo.admin.root.password</span><span class="token operator">=</span>root
<span class="token assign-left variable">dubbo.admin.guest.password</span><span class="token operator">=</span>guest</code></pre></div></figure>



<p><strong>创建镜像构建脚本：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-admin<span class="token comment"># vim build-command.sh </span>
<span class="token comment">#!/bin/bash</span>
<span class="token assign-left variable">TAG</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> harbor.chsblogs.local/zookeeper/dubboadmin:<span class="token variable">$&#123;TAG&#125;</span> <span class="token builtin class-name">.</span>
<span class="token function">docker</span> push  harbor.chsblogs.local/zookeeper/dubboadmin:<span class="token variable">$&#123;TAG&#125;</span>

root@deploy:/opt/dockerfile/project/zookeeper/dubbo-admin<span class="token comment"># ./build-command.sh v2.3.2</span></code></pre></div></figure>



<p><strong>创建dubbo-admin k8s yaml资源文件：</strong></p>
<figure><div class="code-wrapper"><pre class="language-bash" data-language="bash"><code class="language-bash">root@deploy:/opt/dockerfile/project/zookeeper/dubbo-admin<span class="token comment"># vim dubboadmin.yaml</span>
kind: Deployment
apiVersion: apps/v1
metadata:
  labels:
    app: dubboadmin
  name: dubboadmin-deployment
  namespace: zookeeper
spec:
  replicas: <span class="token number">1</span>
  selector:
    matchLabels:
      app: dubboadmin
  template:
    metadata:
      labels:
        app: dubboadmin
    spec:
      containers:
      - name: dubboadmin-container
        image: harbor.chsblogs.local/zookeeper/dubboadmin:v2.3.2
        imagePullPolicy: Always
        ports:
        - containerPort: <span class="token number">8080</span>
          protocol: TCP
          name: http
---
kind: Service
apiVersion: v1
metadata:
  labels:
    app: dubboadmin
  name: dubboadmin-service
  namespace: zookeeper
spec:
  type: NodePort
  ports:
  - name: http
    port: <span class="token number">80</span>
    protocol: TCP
    targetPort: <span class="token number">8080</span>
    nodePort: <span class="token number">30080</span>
  selector:
    app: dubboadmin

deployment.apps/dubboadmin-deployment created
service/dubboadmin-service created
root@deploy:/opt/dockerfile/project/zookeeper/dubbo-admin<span class="token comment"># kubectl get pod -n zookeeper | grep dubboadmin</span>
dubboadmin-deployment-69d548f9c6-kvt6d       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32s
root@deploy:/opt/dockerfile/project/zookeeper/dubbo-admin<span class="token comment"># kubectl get svc -n zookeeper | grep dubboadmin</span>
dubboadmin-service      NodePort    <span class="token number">172.20</span>.25.201    <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:30080/TCP                                   43s
root@deploy:/opt/dockerfile/project/zookeeper/dubbo-admin<span class="token comment"># kubectl get ep -n zookeeper | grep dubboadmin</span>
dubboadmin-service      <span class="token number">10.20</span>.132.224:8080                                           47s</code></pre></div></figure>



<p><img src="/2023/05/05/Container/Kubernetes/kubernetes09/image-20230512194646736.png" srcset="/img/loading.gif" lazyload alt="image-20230512194646736"> </p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Linux/" class="category-chain-item">Linux</a>
  
  
    <span>></span>
    
  <a href="/categories/Linux/Kubernetes/" class="category-chain-item">Kubernetes</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Kubernetes/">#Kubernetes</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>(09).K8S基于ZooKeeper集群实现微服务动态注册和发现</div>
      <div>http://chsblogs.com/2023/05/05/Container/Kubernetes/kubernetes09/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>陈怀森</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年5月5日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/05/09/Container/Kubernetes/kubernetes10/" title="(10).K8S账户授权RBAC">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">(10).K8S账户授权RBAC</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/05/03/Container/Kubernetes/kubernetes08/" title="(08).K8S基于ELK及Kafka集群实现日志收集">
                        <span class="hidden-mobile">(08).K8S基于ELK及Kafka集群实现日志收集</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    
      <script type="text/javascript">
        var disqus_config = function() {
          this.page.url = 'http://chsblogs.com/2023/05/05/Container/Kubernetes/kubernetes09/';
          this.page.identifier = '/2023/05/05/Container/Kubernetes/kubernetes09/';
        };
        Fluid.utils.loadComments('#disqus_thread', function() {
          var d = document, s = d.createElement('script');
          s.src = '//' + 'fluid' + '.disqus.com/embed.js';
          s.setAttribute('data-timestamp', new Date());
          (d.head || d.body).appendChild(s);
        });
      </script>
    
    <noscript>Please enable JavaScript to view the comments</noscript>
  </div>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar category-bar" style="margin-left: -1rem">
    





<div class="category-list">
  
  
    
    
    
    <div class="category row nomargin-x">
      <a class="category-item 
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Kubernetes"
        id="heading-30136395f01879792198317c11831ea4" role="tab" data-toggle="collapse" href="#collapse-30136395f01879792198317c11831ea4"
        aria-expanded="true"
      >
        Kubernetes
        <span class="list-group-count">(14)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse show" id="collapse-30136395f01879792198317c11831ea4"
           role="tabpanel" aria-labelledby="heading-30136395f01879792198317c11831ea4">
        
        
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2023/04/25/Container/Kubernetes/kubernetes01/" title="(01).K8S核心组件介绍"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(01).K8S核心组件介绍</span>
        </a>
      
    
      
      
        <a href="/2023/04/26/Container/Kubernetes/kubernetes02/" title="(02).基于手动二进制部署K8S高可用集群"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(02).基于手动二进制部署K8S高可用集群</span>
        </a>
      
    
      
      
        <a href="/2023/04/26/Container/Kubernetes/kubernetes03/" title="(03).基于kubeadm工具部署K8S高可用集群"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(03).基于kubeadm工具部署K8S高可用集群</span>
        </a>
      
    
      
      
        <a href="/2023/04/26/Container/Kubernetes/kubernetes04/" title="(04).基于kubeasz工具部署K8S高可用集群"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(04).基于kubeasz工具部署K8S高可用集群</span>
        </a>
      
    
      
      
        <a href="/2023/05/03/Container/Kubernetes/kubernetes05/" title="(05).自定义镜像运行Nginx及Java服务并基于NFS实现动静分离"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(05).自定义镜像运行Nginx及Java服务并基于NFS实现动静分离</span>
        </a>
      
    
      
      
        <a href="/2023/05/03/Container/Kubernetes/kubernetes06/" title="(06).K8S基于HPA控制器实现Pod自动伸缩"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(06).K8S基于HPA控制器实现Pod自动伸缩</span>
        </a>
      
    
      
      
        <a href="/2023/05/03/Container/Kubernetes/kubernetes07/" title="(07).K8S基于Jenkins和Gitlab实现版本升级与回滚"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(07).K8S基于Jenkins和Gitlab实现版本升级与回滚</span>
        </a>
      
    
      
      
        <a href="/2023/05/03/Container/Kubernetes/kubernetes08/" title="(08).K8S基于ELK及Kafka集群实现日志收集"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(08).K8S基于ELK及Kafka集群实现日志收集</span>
        </a>
      
    
      
      
        <a href="/2023/05/05/Container/Kubernetes/kubernetes09/" title="(09).K8S基于ZooKeeper集群实现微服务动态注册和发现"
           class="list-group-item list-group-item-action
           active">
          <span class="category-post">(09).K8S基于ZooKeeper集群实现微服务动态注册和发现</span>
        </a>
      
    
      
      
        <a href="/2023/05/09/Container/Kubernetes/kubernetes10/" title="(10).K8S账户授权RBAC"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(10).K8S账户授权RBAC</span>
        </a>
      
    
      
      
        <a href="/2023/05/09/Container/Kubernetes/kubernetes11/" title="(11).K8S资源配额"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(11).K8S资源配额</span>
        </a>
      
    
      
      
        <a href="/2023/05/11/Container/Kubernetes/kubernetes12/" title="(12).基于StatefulSet控制器运行Redis Cluster集群"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(12).基于StatefulSet控制器运行Redis Cluster集群</span>
        </a>
      
    
      
      
        <a href="/2023/05/12/Container/Kubernetes/kubernetes13/" title="(13).K8S基于StatefulSet控制器运行MySQL一主多从"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(13).K8S基于StatefulSet控制器运行MySQL一主多从</span>
        </a>
      
    
      
      
        <a href="/2023/05/19/Container/Kubernetes/kubernetes14/" title="(14).K8S之Etcd备份和恢复"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">(14).K8S之Etcd备份和恢复</span>
        </a>
      
    
  </div>

        
      </div>
    </div>
  
</div>


  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      Copyright © 2023 by 陈怀森
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=20005950"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>赣ICP备20005950号-1</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
